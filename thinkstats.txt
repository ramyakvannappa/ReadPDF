ThinkStats
ExploratoryDataAnalysisinPython
Version2.1.0
ThinkStats
ExploratoryDataAnalysisinPython
Version2.1.0
AllenB.Downey
GreenTeaPress
Needham,Massachusetts
Copyright
c

2014AllenB.Downey.
GreenTeaPress
9WashburnAve
NeedhamMA02492
Permissionisgrantedtocopy,distribute,and/ormodifythisdocumentunderthe
termsoftheCreativeCommonsAttribution-NonCommercial-ShareAlike4.0Inter-
nationalLicense,whichisavailableat
http://creativecommons.org/licenses/
by-nc-sa/4.0/
.
TheoriginalformofthisbookisL
A
T
E
Xsourcecode.Compilingthiscodehasthe
ofgeneratingadevice-independentrepresentationofatextbook,whichcan
beconvertedtootherformatsandprinted.
TheL
A
T
E
Xsourceforthisbookisavailablefrom
http://thinkstats2.com
.
Preface
Thisbookisanintroductiontothepracticaltoolsofexploratorydataanal-
ysis.TheorganizationofthebookfollowstheprocessIusewhenIstart
workingwithadataset:

Importingandcleaning:Whateverformatthedataisin,itusually
takessometimeandtoreadthedata,cleanandtransformit,and
checkthateverythingmadeitthroughthetranslationprocessintact.

Singlevariableexplorations:Iusuallystartbyexaminingonevariable
atatime,outwhatthevariablesmean,lookingatdistributions
ofthevalues,andchoosingappropriatesummarystatistics.

Pair-wiseexplorations:Toidentifypossiblerelationshipsbetweenvari-
ables,Ilookattablesandscatterplots,andcomputecorrelationsand
linear

Multivariateanalysis:Ifthereareapparentrelationshipsbetweenvari-
ables,Iusemultipleregressiontoaddcontrolvariablesandinvestigate
morecomplexrelationships.

Estimationandhypothesistesting:Whenreportingstatisticalresults,
itisimportanttoanswerthreequestions:HowbigistheHow
muchvariabilityshouldweexpectifwerunthesamemeasurement
again?Isitpossiblethattheapparentisduetochance?

Visualization:Duringexploration,visualizationisanimportanttool
forpossiblerelationshipsandThenifanapparent
holdsuptoscrutiny,visualizationisanewaytocommunicate
results.
viChapter0.Preface
Thisbooktakesacomputationalapproach,whichhasseveraladvantages
overmathematicalapproaches:

IpresentmostideasusingPythoncode,ratherthanmathematical
notation.Ingeneral,Pythoncodeismorereadable;also,becauseitis
executable,readerscandownloadit,runit,andmodifyit.

Eachchapterincludesexercisesreaderscandotodevelopandsolidify
theirlearning.Whenyouwriteprograms,youexpressyourunder-
standingincode;whileyouaredebuggingtheprogram,youarealso
correctingyourunderstanding.

Someexercisesinvolveexperimentstoteststatisticalbehavior.For
example,youcanexploretheCentralLimitTheorem(CLT)bygener-
atingrandomsamplesandcomputingtheirsums.Theresultingvisu-
alizationsdemonstratewhytheCLTworksandwhenitdoesn't.

Someideasthatarehardtograspmathematicallyareeasytounder-
standbysimulation.Forexample,weapproximatep-valuesbyrunning
randomsimulations,whichreinforcesthemeaningofthep-value.

Becausethebookisbasedonageneral-purposeprogramminglanguage
(Python),readerscanimportdatafromalmostanysource.Theyare
notlimitedtodatasetsthathavebeencleanedandformattedfora
particularstatisticstool.
Thebooklendsitselftoaproject-basedapproach.Inmyclass,studentswork
onasemester-longprojectthatrequiresthemtoposeastatisticalquestion,
adatasetthatcanaddressit,andapplyeachofthetechniquesthey
learntotheirowndata.
Todemonstratemyapproachtostatisticalanalysis,thebookpresentsacase
studythatrunsthroughallofthechapters.Itusesdatafromtwosources:

TheNationalSurveyofFamilyGrowth(NSFG),conductedbythe
U.S.CentersforDiseaseControlandPrevention(CDC)togather
\informationonfamilylife,marriageanddivorce,pregnancy,infer-
tility,useofcontraception,andmen'sandwomen'shealth."(See
http://cdc.gov/nchs/nsfg.htm
.)
0.1.HowIwrotethisbookvii

TheBehavioralRiskFactorSurveillanceSystem(BRFSS),conducted
bytheNationalCenterforChronicDiseasePreventionandHealth
Promotionto\trackhealthconditionsandriskbehaviorsintheUnited
States."(See
http://cdc.gov/BRFSS/
.)
OtherexamplesusedatafromtheIRS,theU.S.Census,andtheBoston
Marathon.
Thissecondeditionof
ThinkStats
includesthechaptersfromtheedition,
manyofthemsubstantiallyrevised,andnewchaptersonregression,time
seriesanalysis,survivalanalysis,andanalyticmethods.Thepreviousedition
didnotusepandas,SciPy,orStatsModels,soallofthatmaterialisnew.
0.1HowIwrotethisbook
Whenpeoplewriteanewtextbook,theyusuallystartbyreadingastackof
oldtextbooks.Asaresult,mostbookscontainthesamematerialinpretty
muchthesameorder.
Ididnotdothat.Infact,IusedalmostnoprintedmaterialwhileIwas
writingthisbook,forseveralreasons:

Mygoalwastoexploreanewapproachtothismaterial,soIdidn't
wantmuchexposuretoexistingapproaches.

SinceIammakingthisbookavailableunderafreelicense,Iwantedto
makesurethatnopartofitwasencumberedbycopyrightrestrictions.

Manyreadersofmybooksdon'thaveaccesstolibrariesofprintedma-
terial,soItriedtomakereferencestoresourcesthatarefreelyavailable
ontheInternet.

Someproponentsofoldmediathinkthattheexclusiveuseofelectronic
resourcesislazyandunreliable.Theymightberightaboutthe
part,butIthinktheyarewrongaboutthesecond,soIwantedtotest
mytheory.
viiiChapter0.Preface
TheresourceIusedmorethananyotherisWikipedia.Ingeneral,thearti-
clesIreadonstatisticaltopicswereverygood(althoughImadeafewsmall
changesalongtheway).IincludereferencestoWikipediapagesthrough-
outthebookandIencourageyoutofollowthoselinks;inmanycases,the
WikipediapagepicksupwheremydescriptionleavesThevocabulary
andnotationinthisbookaregenerallyconsistentwithWikipedia,unless
Ihadagoodreasontodeviate.OtherresourcesIfoundusefulwereWol-
framMathWorldandtheRedditstatisticsforum,
http://www.reddit.com/
r/statistics
.
0.2Usingthecode
Thecodeanddatausedinthisbookareavailablefrom
https://github.
com/AllenDowney/ThinkStats2
.Gitisaversioncontrolsystemthatallows
youtokeeptrackofthelesthatmakeupaproject.Acollectionof
underGit'scontroliscalleda
repository
.GitHubisahostingservicethat
providesstorageforGitrepositoriesandaconvenientwebinterface.
TheGitHubhomepageformyrepositoryprovidesseveralwaystoworkwith
thecode:

YoucancreateacopyofmyrepositoryonGitHubbypressingthe
Fork
button.Ifyoudon'talreadyhaveaGitHubaccount,you'llneedto
createone.Afterforking,you'llhaveyourownrepositoryonGitHub
thatyoucanusetokeeptrackofcodeyouwritewhileworkingonthis
book.Thenyoucanclonetherepo,whichmeansthatyoumakeacopy
oftheonyourcomputer.

Oryoucouldclonemyrepository.Youdon'tneedaGitHubaccountto
dothis,butyouwon'tbeabletowriteyourchangesbacktoGitHub.

Ifyoudon'twanttouseGitatall,youcandownloadtheinaZip
usingthebuttoninthelower-rightcorneroftheGitHubpage.
AllofthecodeiswrittentoworkinbothPython2andPython3withno
translation.
IdevelopedthisbookusingAnacondafromContinuumAnalytics,whichisa
freePythondistributionthatincludesallthepackagesyou'llneedtorunthe
0.2.Usingthecodeix
code(andlotsmore).IfoundAnacondaeasytoinstall.Bydefaultitdoes
auser-levelinstallation,notsystem-level,soyoudon'tneedadministrative
privileges.AnditsupportsbothPython2andPython3.Youcandownload
Anacondafrom
http://continuum.io/downloads
.
Ifyoudon'twanttouseAnaconda,youwillneedthefollowingpackages:

pandasforrepresentingandanalyzingdata,
http://pandas.pydata.
org/
;

NumPyforbasicnumericalcomputation,
http://www.numpy.org/
;

SciPyforsciencomputationincludingstatistics,
http://www.
scipy.org/
;

StatsModelsforregressionandotherstatisticalanalysis,
http://
statsmodels.sourceforge.net/
;and

matplotlibforvisualization,
http://matplotlib.org/
.
Althoughthesearecommonlyusedpackages,theyarenotincludedwithall
Pythoninstallations,andtheycanbehardtoinstallinsomeenvironments.
Ifyouhavetroubleinstallingthem,IstronglyrecommendusingAnaconda
oroneoftheotherPythondistributionsthatincludethesepackages.
Afteryouclonetherepositoryorunzipthezip,youshouldhaveafolder
called
ThinkStats2/code
withacallednsfg.py.Ifyourunnsfg.py,it
shouldreadadatarunsometests,andprintamessagelike,\Alltests
passed."Ifyougetimporterrors,itprobablymeanstherearepackagesyou
needtoinstall.
MostexercisesusePythonscripts,butsomealsousetheIPythonnotebook.
IfyouhavenotusedIPythonnotebookbefore,Isuggestyoustartwiththe
documentationat
http://ipython.org/ipython-doc/stable/notebook/
notebook.html
.
IwrotethisbookassumingthatthereaderisfamiliarwithcorePython,
includingobject-orientedfeatures,butnotpandas,NumPy,andSciPy.If
youarealreadyfamiliarwiththesemodules,youcanskipafewsections.
xChapter0.Preface
Iassumethatthereaderknowsbasicmathematics,includinglogarithms,for
example,andsummations.Irefertocalculusconceptsinafewplaces,but
youdon'thavetodoanycalculus.
Ifyouhaveneverstudiedstatistics,Ithinkthisbookisagoodplacetostart.
Andifyouhavetakenatraditionalstatisticsclass,Ihopethisbookwillhelp
repairthedamage.
|
AllenB.DowneyisaProfessorofComputerScienceattheFranklinW.Olin
CollegeofEngineeringinNeedham,MA.
ContributorList
Ifyouhaveasuggestionorcorrection,pleasesendemailto
downey@allendowney.com
.IfImakeachangebasedonyourfeedback,I
willaddyoutothecontributorlist(unlessyouasktobeomitted).
Ifyouincludeatleastpartofthesentencetheerrorappearsin,thatmakes
iteasyformetosearch.Pageandsectionnumbersaretoo,butnot
quiteaseasytoworkwith.Thanks!

LisaDowneyandJuneDowneyreadanearlydraftandmademanycorrec-
tionsandsuggestions.

StevenZhangfoundseveralerrors.

AndyPethanandMollyFarisonhelpeddebugsomeofthesolutions,and
Mollyspottedseveraltypos.

Dr.NikolasAkerblomknowshowbigaHyracotheriumis.

AlexMorrowoneofthecodeexamples.

JonathanStreetcaughtanerrorinthenickoftime.

ManythankstoKevinSmithandTimArnoldfortheirworkonplasTeX,
whichIusedtoconvertthisbooktoDocBook.

GeorgeCaplansentseveralsuggestionsforimprovingclarity.
0.2.Usingthecodexi

JulianCeipekfoundanerrorandanumberoftypos.

StijnDebrouwere,LeoMarihartIII,JonathanHammler,andKentJohnson
founderrorsintheprintedition.

orgBeyerfoundtyposinthebookandmademanycorrectionsinthedoc-
stringsoftheaccompanyingcode.

TommieGannertsentapatchwithanumberofcorrections.

ChristophLendenmannsubmittedseveralerrata.

MichaelKearneysentmemanyexcellentsuggestions.

AlexBirchmadeanumberofhelpfulsuggestions.

LindseyVanderlyn,Tschurwald,andBenSmallreadanearlyversion
ofthisbookandfoundmanyerrors.

JohnRoth,CarolWilling,andCarolNovitskyperformedtechnicalreviews
ofthebook.Theyfoundmanyerrorsandmademanyhelpfulsuggestions.

DavidPalmersentmanyhelpfulsuggestionsandcorrections.

ErikKulykfoundmanytypos.

Nirsentseveralexcellentpullrequestsforboththebookandthe
supportingcode.

GitHubusersentanumberofcorrections.

ToshiakiKurokawa,whoisworkingontheJapanesetranslationofthisbook,
hassentmanycorrectionsandhelpfulsuggestions.

BenjaminWhitesuggestedmoreidiomaticPandascode.

TakashiSatospottedancodeerror.
OtherpeoplewhofoundtyposandsimilarerrorsareAndrewHeine,aborak,
DanKearney,AlexanderGryzlov,MartinVeillette,HaitaoMa,Pickhardt,
RohitDeshpande,JoannePratt,LucianUrsu,PaulGlezen,Ting-kuangLin,Scott
Miller,LuigiPatruno.
xiiChapter0.Preface
Contents
Prefacev
0.1HowIwrotethisbook.....................vii
0.2Usingthecode..........................viii
1Exploratorydataanalysis1
1.1Astatisticalapproach......................2
1.2TheNationalSurveyofFamilyGrowth............3
1.3Importingthedata.......................4
1.4DataFrames...........................5
1.5Variables.............................7
1.6Transformation.........................8
1.7Validation............................10
1.8Interpretation..........................12
1.9Exercises.............................13
1.10Glossary.............................15
xivContents
2Distributions17
2.1Histograms............................17
2.2Representinghistograms....................18
2.3Plottinghistograms.......................19
2.4NSFGvariables.........................19
2.5Outliers.............................22
2.6Firstbabies...........................23
2.7Summarizingdistributions...................25
2.8Variance.............................26
2.9size............................27
2.10Reportingresults........................28
2.11Exercises.............................28
2.12Glossary.............................29
3Probabilitymassfunctions31
3.1Pmfs...............................31
3.2PlottingPMFs.........................33
3.3Othervisualizations.......................35
3.4Theclasssizeparadox.....................35
3.5DataFrameindexing......................39
3.6Exercises.............................41
3.7Glossary.............................43
Contentsxv
4Cumulativedistributionfunctions45
4.1ThelimitsofPMFs.......................45
4.2Percentiles............................46
4.3CDFs...............................48
4.4RepresentingCDFs.......................49
4.5ComparingCDFs........................50
4.6Percentile-basedstatistics....................51
4.7Randomnumbers........................52
4.8Comparingpercentileranks..................54
4.9Exercises.............................55
4.10Glossary.............................55
5Modelingdistributions57
5.1Theexponentialdistribution..................57
5.2Thenormaldistribution....................60
5.3Normalprobabilityplot.....................62
5.4Thelognormaldistribution...................65
5.5TheParetodistribution.....................67
5.6Generatingrandomnumbers..................69
5.7Whymodel?...........................70
5.8Exercises.............................71
5.9Glossary.............................73
xviContents
6Probabilitydensityfunctions75
6.1PDFs...............................75
6.2Kerneldensityestimation....................77
6.3Thedistributionframework..................79
6.4Histimplementation......................80
6.5Pmfimplementation......................81
6.6Cdfimplementation.......................82
6.7Moments.............................84
6.8Skewness.............................85
6.9Exercises.............................88
6.10Glossary.............................89
7Relationshipsbetweenvariables91
7.1Scatterplots...........................91
7.2Characterizingrelationships..................95
7.3Correlation............................96
7.4Covariance............................97
7.5Pearson'scorrelation......................98
7.6Nonlinearrelationships.....................100
7.7Spearman'srankcorrelation..................101
7.8Correlationandcausation...................102
7.9Exercises.............................103
7.10Glossary.............................103
Contentsxvii
8Estimation105
8.1Theestimationgame......................105
8.2Guessthevariance.......................107
8.3Samplingdistributions.....................109
8.4Samplingbias..........................112
8.5Exponentialdistributions....................113
8.6Exercises.............................115
8.7Glossary.............................116
9Hypothesistesting117
9.1Classicalhypothesistesting...................117
9.2HypothesisTest.........................119
9.3Testingainmeans..................121
9.4Otherteststatistics.......................123
9.5Testingacorrelation......................124
9.6Testingproportions.......................125
9.7Chi-squaredtests........................127
9.8Firstbabiesagain........................128
9.9Errors..............................130
9.10Power..............................130
9.11Replication............................132
9.12Exercises.............................133
9.13Glossary.............................134
xviiiContents
10Linearleastsquares137
10.1Leastsquares.........................137
10.2Implementation.........................139
10.3Residuals.............................140
10.4Estimation............................141
10.5Goodnessof.........................144
10.6Testingalinearmodel.....................146
10.7Weightedresampling......................148
10.8Exercises.............................150
10.9Glossary.............................150
11Regression153
11.1StatsModels...........................154
11.2Multipleregression.......................156
11.3Nonlinearrelationships.....................158
11.4Datamining...........................159
11.5Prediction............................161
11.6Logisticregression........................163
11.7Estimatingparameters.....................165
11.8Implementation.........................166
11.9Accuracy.............................168
11.10Exercises.............................169
11.11Glossary.............................170
Contentsxix
12Timeseriesanalysis173
12.1Importingandcleaning.....................174
12.2Plotting.............................176
12.3Linearregression........................178
12.4Movingaverages.........................180
12.5Missingvalues..........................182
12.6Serialcorrelation........................183
12.7Autocorrelation.........................185
12.8Prediction............................187
12.9Furtherreading.........................192
12.10Exercises.............................192
12.11Glossary.............................193
13Survivalanalysis195
13.1Survivalcurves.........................195
13.2Hazardfunction.........................198
13.3Inferringsurvivalcurves....................199
13.4Kaplan-Meierestimation....................200
13.5Themarriagecurve.......................202
13.6Estimatingthesurvivalcurve.................203
13.7intervals.......................204
13.8Cohort..........................206
13.9Extrapolation..........................209
13.10Expectedremaininglifetime..................210
13.11Exercises.............................214
13.12Glossary.............................214
xxContents
14Analyticmethods217
14.1Normaldistributions......................217
14.2Samplingdistributions.....................219
14.3Representingnormaldistributions...............220
14.4Centrallimittheorem......................221
14.5TestingtheCLT.........................222
14.6ApplyingtheCLT........................227
14.7Correlationtest.........................228
14.8Chi-squaredtest.........................230
14.9Discussion............................232
14.10Exercises.............................233
Index235
Chapter1
Exploratorydataanalysis
Thethesisofthisbookisthatdatacombinedwithpracticalmethodscan
answerquestionsandguidedecisionsunderuncertainty.
Asanexample,IpresentacasestudymotivatedbyaquestionIheardwhen
mywifeandIwereexpectingourchild:dobabiestendtoarrive
late?
IfyouGooglethisquestion,youwillplentyofdiscussion.Somepeople
claimit'strue,otherssayit'samyth,andsomepeoplesayit'stheotherway
around:babiescomeearly.
Inmanyofthesediscussions,peopleprovidedatatosupporttheirclaims.I
foundmanyexampleslikethese:
\Mytwofriendsthathavegivenbirthrecentlytotheirba-
bies,BOTHwentalmost2weeksoverduebeforegoingintolabour
orbeinginduced."
\Myonecame2weekslateandnowIthinkthesecondone
isgoingtocomeouttwoweeksearly!!"
\Idon'tthinkthatcanbetruebecausemysisterwasmymother's
andshewasearly,aswithmanyofmycousins."
Reportslikethesearecalled
anecdotalevidence
becausetheyarebased
ondatathatisunpublishedandusuallypersonal.Incasualconversation,
2Chapter1.Exploratorydataanalysis
thereisnothingwrongwithanecdotes,soIdon'tmeantopickonthepeople
Iquoted.
Butwemightwantevidencethatismorepersuasiveandananswerthatis
morereliable.Bythosestandards,anecdotalevidenceusuallyfails,because:

Smallnumberofobservations:Ifpregnancylengthislongerfor
babies,theceisprobablysmallcomparedtonaturalvariation.
Inthatcase,wemighthavetocomparealargenumberofpregnancies
tobesurethataexists.

Selectionbias:Peoplewhojoinadiscussionofthisquestionmightbe
interestedbecausetheirstbabieswerelate.Inthatcasetheprocess
ofselectingdatawouldbiastheresults.

bias:Peoplewhobelievetheclaimmightbemorelikely
tocontributeexamplesthatit.Peoplewhodoubttheclaim
aremorelikelytocitecounterexamples.

Inaccuracy:Anecdotesareoftenpersonalstories,andoftenmisremem-
bered,misrepresented,repeatedinaccurately,etc.
Sohowcanwedobetter?
1.1Astatisticalapproach
Toaddressthelimitationsofanecdotes,wewillusethetoolsofstatistics,
whichinclude:

Datacollection:Wewillusedatafromalargenationalsurveythat
wasdesignedexplicitlywiththegoalofgeneratingstatisticallyvalid
inferencesabouttheU.S.population.

Descriptivestatistics:Wewillgeneratestatisticsthatsummarizethe
dataconcisely,andevaluatetwaystovisualizedata.

Exploratorydataanalysis:Wewilllookforpatterns,and
otherfeaturesthataddressthequestionsweareinterestedin.Atthe
sametimewewillcheckforinconsistenciesandidentifylimitations.
1.2.TheNationalSurveyofFamilyGrowth3

Estimation:Wewillusedatafromasampletoestimatecharacteristics
ofthegeneralpopulation.

Hypothesistesting:Whereweseeapparentts,likea
betweentwogroups,wewillevaluatewhetherthemighthave
happenedbychance.
Byperformingthesestepswithcaretoavoidpitfalls,wecanreachconclusions
thataremoreandmorelikelytobecorrect.
1.2TheNationalSurveyofFamilyGrowth
Since1973theU.S.CentersforDiseaseControlandPrevention(CDC)
haveconductedtheNationalSurveyofFamilyGrowth(NSFG),whichis
intendedtogather\informationonfamilylife,marriageanddivorce,preg-
nancy,infertility,useofcontraception,andmen'sandwomen'shealth.The
surveyresultsareused...toplanhealthservicesandhealtheducationpro-
grams,andtodostatisticalstudiesoffamilies,fertility,andhealth."See
http://cdc.gov/nchs/nsfg.htm
.
Wewillusedatacollectedbythissurveytoinvestigatewhetherstbabies
tendtocomelate,andotherquestions.Inordertousethisdataely,
wehavetounderstandthedesignofthestudy.
TheNSFGisa
cross-sectional
study,whichmeansthatitcapturesasnap-
shotofagroupatapointintime.Themostcommonalternativeisa
lon-
gitudinal
study,whichobservesagrouprepeatedlyoveraperiodoftime.
TheNSFGhasbeenconductedseventimes;eachdeploymentiscalleda
cycle
.WewillusedatafromCycle6,whichwasconductedfromJanuary
2002toMarch2003.
Thegoalofthesurveyistodrawconclusionsabouta
population
;the
targetpopulationoftheNSFGispeopleintheUnitedStatesaged15-44.
Ideallysurveyswouldcollectdatafromeverymemberofthepopulation,
butthat'sseldompossible.Insteadwecollectdatafromasubsetofthe
4Chapter1.Exploratorydataanalysis
populationcalleda
sample
.Thepeoplewhoparticipateinasurveyare
called
respondents
.
Ingeneral,cross-sectionalstudiesaremeanttobe
representative
,which
meansthateverymemberofthetargetpopulationhasanequalchanceof
participating.Thatidealishardtoachieveinpractice,butpeoplewho
conductsurveyscomeascloseastheycan.
TheNSFGisnotrepresentative;insteaditisdeliberately
oversampled
.The
designersofthestudyrecruitedthreegroups|Hispanics,African-Americans
andteenagers|atrateshigherthantheirrepresentationintheU.S.popula-
tion,inordertomakesurethatthenumberofrespondentsineachofthese
groupsislargeenoughtodrawvalidstatisticalinferences.
Ofcourse,thedrawbackofoversamplingisthatitisnotaseasytodraw
conclusionsaboutthegeneralpopulationbasedonstatisticsfromthesurvey.
Wewillcomebacktothispointlater.
Whenworkingwiththiskindofdata,itisimportanttobefamiliarwith
the
codebook
,whichdocumentsthedesignofthestudy,thesurveyques-
tions,andtheencodingoftheresponses.Thecodebookanduser'sguidefor
theNSFGdataareavailablefrom
http://www.cdc.gov/nchs/nsfg/nsfg_
cycle6.htm
1.3Importingthedata
Thecodeanddatausedinthisbookareavailablefrom
https://github.
com/AllenDowney/ThinkStats2
.Forinformationaboutdownloadingand
workingwiththiscode,seeSection0.2.
Onceyoudownloadthecode,youshouldhaveacalled
ThinkStats2/code/nsfg.py
.Ifyourunit,itshouldreadadata
runsometests,andprintamessagelike,\Alltestspassed."
Let'sseewhatitdoes.PregnancydatafromCycle6oftheNSFGisina
called
2002FemPreg.dat.gz
;itisagzip-compresseddatainplaintext
(ASCII),withwidthcolumns.Eachlineintheisa
record
that
containsdataaboutonepregnancy.
1.4.DataFrames5
Theformatoftheisdocumentedin
2002FemPreg.dct
,whichisaStata
dictionaryStataisastatisticalsoftwaresystem;a\dictionary"inthis
contextisalistofvariablenames,types,andindicesthatidentifywherein
eachlinetoeachvariable.
Forexample,hereareafewlinesfrom
2002FemPreg.dct
:
infiledictionary{
_column(1)str12caseid%12s"RESPONDENTIDNUMBER"
_column(13)bytepregordr%2f"PREGNANCYORDER(NUMBER)"
}
Thisdictionarydescribestwovariables:
caseid
isa12-characterstringthat
representstherespondentID;
pregordr
isaone-byteintegerthatindicates
whichpregnancythisrecorddescribesforthisrespondent.
Thecodeyoudownloadedincludes
thinkstats2.py
,whichisaPythonmod-
ulethatcontainsmanyclassesandfunctionsusedinthisbook,including
functionsthatreadtheStatadictionaryandtheNSFGdataHere'show
theyareusedin
nsfg.py
:
defReadF

dct=thinkstats2.ReadStataDct(dct_file)
df=dct.ReadFixedWidth(dat_file,
CleanFemPreg(df)
returndf
ReadStataDct
takesthenameofthedictionaryandreturns
dct
,a
FixedWidthVariables
objectthatcontainstheinformationfromthedic-
tionary
dct
provides
ReadFixedWidth
,whichreadsthedata
1.4DataFrames
Theresultof
ReadFixedWidth
isaDataFrame,whichisthefundamentaldata
structureprovidedbypandas,whichisaPythondataandstatisticspackage
we'llusethroughoutthisbook.ADataFramecontainsarowforeachrecord,
inthiscaseonerowperpregnancy,andacolumnforeachvariable.
6Chapter1.Exploratorydataanalysis
Inadditiontothedata,aDataFramealsocontainsthevariablenamesand
theirtypes,anditprovidesmethodsforaccessingandmodifyingthedata.
Ifyouprint
df
yougetatruncatedviewoftherowsandcolumns,
andtheshapeoftheDataFrame,whichis13593rows/recordsand244
columns/variables.
>>>importnsfg
>>>df=nsfg.ReadFemPreg()
>>>df
...
[13593rowsx244columns]
TheDataFrameistoobigtodisplay,sotheoutputistruncated.Thelast
linereportsthenumberofrowsandcolumns.
Theattribute
columns
returnsasequenceofcolumnnamesasUnicode
strings:
>>>df.columns
...])
TheresultisanIndex,whichisanotherpandasdatastructure.We'lllearn
moreaboutIndexlater,butfornowwe'lltreatitlikealist:
>>>df.columns[1]

ToaccessacolumnfromaDataFrame,youcanusethecolumnnameasa
key:
>>>pregordr=
>>>type(pregordr)
<class
TheresultisaSeries,yetanotherpandasdatastructure.ASeriesislikea
Pythonlistwithsomeadditionalfeatures.WhenyouprintaSeries,youget
theindicesandthecorrespondingvalues:
>>>pregordr
01
12
21
32
1.5.Variables7
...
135903
135914
135925
Name:pregordr,Length:13593,dtype:int64
Inthisexampletheindicesareintegersfrom0to13592,butingeneralthey
canbeanysortabletype.Theelementsarealsointegers,buttheycanbe
anytype.
Thelastlineincludesthevariablename,Serieslength,anddatatype;
int64
isoneofthetypesprovidedbyNumPy.Ifyourunthisexampleona32-bit
machineyoumightsee
int32
.
YoucanaccesstheelementsofaSeriesusingintegerindicesandslices:
>>>pregordr[0]
1
>>>pregordr[2:5]
21
32
43
Name:pregordr,dtype:int64
Theresultoftheindexoperatorisan
int64
;theresultofthesliceisanother
Series.
YoucanalsoaccessthecolumnsofaDataFrameusingdotnotation:
>>>pregordr=df.pregordr
ThisnotationonlyworksifthecolumnnameisavalidPythonidenso
ithastobeginwithaletter,can'tcontainspaces,etc.
1.5Variables
WehavealreadyseentwovariablesintheNSFGdataset,
caseid
and
pregordr
,andwehaveseenthatthereare244variablesintotal.Forthe
explorationsinthisbook,Iusethefollowingvariables:

caseid
istheintegerIDoftherespondent.
8Chapter1.Exploratorydataanalysis

prglngth
istheintegerdurationofthepregnancyinweeks.

outcome
isanintegercodefortheoutcomeofthepregnancy.Thecode
1indicatesalivebirth.

pregordr
isapregnancyserialnumber;forexample,thecodefora
respondent'spregnancyis1,forthesecondpregnancyis2,andso
on.

birthord
isaserialnumberforlivebirths;thecodeforarespondent's
childis1,andsoon.Foroutcomesotherthanlivebirth,this
isblank.

birthwgt_lb
and
birthwgt_oz
containthepoundsandouncesparts
ofthebirthweightofthebaby.

agepreg
isthemother'sageattheendofthepregnancy.

finalwgt
isthestatisticalweightassociatedwiththerespondent.Itis
aointvaluethatindicatesthenumberofpeopleintheU.S.
populationthisrespondentrepresents.
Ifyoureadthecodebookcarefully,youwillseethatmanyofthevariables
are
recodes
,whichmeansthattheyarenotpartofthe
rawdata
collected
bythesurvey;theyarecalculatedusingtherawdata.
Forexample,
prglngth
forlivebirthsisequaltotherawvariable
wksgest
(weeksofgestation)ifitisavailable;otherwiseitisestimatedusing
mosgest*4.33
(monthsofgestationtimestheaveragenumberofweeks
inamonth).
Recodesareoftenbasedonlogicthatcheckstheconsistencyandaccuracyof
thedata.Ingeneralitisagoodideatouserecodeswhentheyareavailable,
unlessthereisacompellingreasontoprocesstherawdatayourself.
1.6Transformation
Whenyouimportdatalikethis,youoftenhavetocheckforerrors,dealwith
specialvalues,convertdataintotformats,andperformcalculations.
Theseoperationsarecalled
datacleaning
.
1.6.Transformation9
nsfg.py
includes
CleanFemPreg
,afunctionthatcleansthevariablesIam
planningtouse.
defCleanFemPreg(df):
df.agepreg/=100.0
na_vals=[97,98,99]
df.birthwgt_lb.replace(na_vals,np.nan,inplace=True)
df.birthwgt_oz.replace(na_vals,np.nan,inplace=True)
=df.birthwgt_lb+df.birthwgt_oz/16.0
agepreg
containsthemother'sageattheendofthepregnancy.Inthedata

agepreg
isencodedasanintegernumberofcentiyears.Sotheline
divideseachelementof
agepreg
by100,yieldingaointvaluein
years.
birthwgt_lb
and
birthwgt_oz
containtheweightofthebaby,inpounds
andounces,forpregnanciesthatendinlivebirth.Inadditionitusesseveral
specialcodes:
97NOTASCERTAINED
98REFUSED
99KNOW
Specialvaluesencodedasnumbersare
dangerous
becauseiftheyarenot
handledproperly,theycangeneratebogusresults,likea99-poundbaby.
The
replace
methodreplacesthesevalueswith
np.nan
,aspecial
pointvaluethatrepresents\notanumber."The
inplace
tells
replace
tomodifytheexistingSeriesratherthancreateanewone.
AspartoftheIEEEointstandard,allmathematicaloperations
return
nan
ifeitherargumentis
nan
:
>>>importnumpyasnp
>>>np.nan/100.0
nan
Socomputationswith
nan
tendtodotherightthing,andmostpandas
functionshandle
nan
appropriately.Butdealingwithmissingdatawillbea
recurringissue.
Thelastlineof
CleanFemPreg
createsanewcolumn
totalwgt_lb
thatcom-
binespoundsandouncesintoasinglequantity,inpounds.
10Chapter1.Exploratorydataanalysis
Oneimportantnote:whenyouaddanewcolumntoaDataFrame,youmust
usedictionarysyntax,likethis
#CORRECT
=df.birthwgt_lb+df.birthwgt_oz/16.0
Notdotnotation,likethis:
#WRONG!
df.totalwgt_lb=df.birthwgt_lb+df.birthwgt_oz/16.0
TheversionwithdotnotationaddsanattributetotheDataFrameobject,
butthatattributeisnottreatedasanewcolumn.
1.7Validation
Whendataisexportedfromonesoftwareenvironmentandimportedinto
another,errorsmightbeintroduced.Andwhenyouaregettingfamiliar
withanewdataset,youmightinterpretdataincorrectlyorintroduceother
misunderstandings.Ifyoutaketimetovalidatethedata,youcansavetime
laterandavoiderrors.
Onewaytovalidatedataistocomputebasicstatisticsandcomparethem
withpublishedresults.Forexample,theNSFGcodebookincludestables
thatsummarizeeachvariable.Hereisthetablefor
outcome
,whichencodes
theoutcomeofeachpregnancy:
valuelabelTotal
1LIVEBIRTH9148
2INDUCEDABORTION1862
3STILLBIRTH120
4MISCARRIAGE1921
5ECTOPICPREGNANCY190
6CURRENTPREGNANCY352
TheSeriesclassprovidesamethod,
value_counts
,thatcountsthenum-
beroftimeseachvalueappears.Ifweselectthe
outcome
Seriesfromthe
DataFrame,wecanuse
value_counts
tocomparewiththepublisheddata:
>>>df.outcome.value_counts().sort_index()
19148
1.7.Validation11
21862
3120
41921
5190
6352
Theresultof
value_counts
isaSeries;
sort_index()
sortstheSeriesby
index,sothevaluesappearinorder.
Comparingtheresultswiththepublishedtable,itlookslikethevaluesin
outcome
arecorrect.Similarly,hereisthepublishedtablefor
birthwgt_lb
valuelabelTotal
.INAPPLICABLE4449
0-5UNDER6POUNDS1125
66POUNDS2223
77POUNDS3049
88POUNDS1889
9-959POUNDSORMORE799
Andherearethevaluecounts:
>>>df.birthwgt_lb.value_counts(sort=False)
08
140
253
398
4229
5697
62223
73049
81889
9623
10132
1126
1210
133
143
151
511
12Chapter1.Exploratorydataanalysis
Thecountsfor6,7,and8poundscheckout,andifyouaddupthecounts
for0-5and9-95,theycheckout,too.Butifyoulookmoreclosely,youwill
noticeonevaluethathastobeanerror,a51poundbaby!
Todealwiththiserror,Iaddedalineto
CleanFemPreg
:
df.loc[df.birthwgt_lb>20,=np.nan
Thisstatementreplacesinvalidvalueswith
np.nan
.Theattribute
loc
pro-
videsseveralwaystoselectrowsandcolumnsfromaDataFrame.Inthis
example,theexpressioninbracketsistherowindexer;thesecondex-
pressionselectsthecolumn.
Theexpression
df.birthwgt_lb>20
yieldsaSeriesoftype
bool
,where
Trueindicatesthattheconditionistrue.WhenabooleanSeriesisusedas
anindex,itselectsonlytheelementsthatsatisfythecondition.
1.8Interpretation
Toworkwithdataely,youhavetothinkontwolevelsatthesame
time:thelevelofstatisticsandthelevelofcontext.
Asanexample,let'slookatthesequenceofoutcomesforafewrespondents.
Becauseofthewaythedataareorganized,wehavetodosomeprocessing
tocollectthepregnancydataforeachrespondent.Here'safunctionthatdoes
that:
defMakePregMap(df):
d=defaultdict(list)
forindex,caseidindf.caseid.iteritems():
d[caseid].append(index)
returnd
df
istheDataFramewithpregnancydata.The
iteritems
methodenumer-
atestheindex(rownumber)and
caseid
foreachpregnancy.
d
isadictionarythatmapsfromeachcaseIDtoalistofindices.Ifyouarenot
familiarwith
defaultdict
,itisinthePython
collections
module.Using
d
,wecanlookuparespondentandgettheindicesofthatrespondent's
pregnancies.
1.9.Exercises13
Thisexamplelooksuponerespondentandprintsalistofoutcomesforher
pregnancies:
>>>caseid=10229
>>>preg_map=nsfg.MakePregMap(df)
>>>indices=preg_map[caseid]
>>>df.outcome[indices].values
[4444441]
indices
isthelistofindicesforpregnanciescorrespondingtorespondent
10229
.
Usingthislistasanindexinto
df.outcome
selectstheindicatedrowsand
yieldsaSeries.InsteadofprintingthewholeSeries,Iselectedthe
values
attribute,whichisaNumPyarray.
Theoutcomecode
1
indicatesalivebirth.Code
4
indicatesamiscarriage;
thatis,apregnancythatendedspontaneously,usuallywithnoknownmed-
icalcause.
Statisticallythisrespondentisnotunusual.Miscarriagesarecommonand
thereareotherrespondentswhoreportedasmanyormore.
Butrememberingthecontext,thisdatatellsthestoryofawomanwhowas
pregnantsixtimes,eachtimeendinginmiscarriage.Herseventhandmost
recentpregnancyendedinalivebirth.Ifweconsiderthisdatawithempathy,
itisnaturaltobemovedbythestoryittells.
EachrecordintheNSFGdatasetrepresentsapersonwhoprovidedhonest
answerstomanypersonalandquestions.Wecanusethisdatato
answerstatisticalquestionsaboutfamilylife,reproduction,andhealth.At
thesametime,wehaveanobligationtoconsiderthepeoplerepresentedby
thedata,andtothemrespectandgratitude.
1.9Exercises
Exercise1.1
Intherepositoryyoudownloaded,youshouldanamed
chap01ex.ipynb
,whichisanIPythonnotebook.YoucanlaunchIPython
notebookfromthecommandlinelikethis:
14Chapter1.Exploratorydataanalysis
$ipythonnotebook&
IfIPythonisinstalled,itshouldlaunchaserverthatrunsintheback-
groundandopenabrowsertoviewthenotebook.Ifyouarenotfamiliar
withIPython,Isuggestyoustartat
http://ipython.org/ipython-doc/
stable/notebook/notebook.html
.
TolaunchtheIPythonnotebookserver,run:
$ipythonnotebook&
Itshouldopenanewbrowserwindow,butifnot,thestartupmessagepro-
videsaURLyoucanloadinabrowser,usually
http://localhost:8888
.
Thenewwindowshouldlistthenotebooksintherepository.
Open
chap01ex.ipynb
.Somecellsarealreadyin,andyoushould
executethem.Othercellsgiveyouinstructionsforexercisesyoushouldtry.
Asolutiontothisexerciseisin
chap01soln.ipynb
Exercise1.2
Intherepositoryyoudownloaded,youshouldanamed
chap01ex.py
;usingthisasastartingplace,writeafunctionthatreads
therespondent,
2002FemResp.dat.gz
.
Thevariable
pregnum
isarecodethatindicateshowmanytimeseachre-
spondenthasbeenpregnant.Printthevaluecountsforthisvariableand
comparethemtothepublishedresultsintheNSFGcodebook.
Youcanalsocross-validatetherespondentandpregnancybycomparing
pregnum
foreachrespondentwiththenumberofrecordsinthepregnancy

Youcanuse
nsfg.MakePregMap
tomakeadictionarythatmapsfromeach
caseid
toalistofindicesintothepregnancyDataFrame.
Asolutiontothisexerciseisin
chap01soln.py
Exercise1.3
Thebestwaytolearnaboutstatisticsistoworkonaproject
youareinterestedin.Isthereaquestionlike,\Dobabiesarrivelate,"
thatyouwanttoinvestigate?
Thinkaboutquestionsyoupersonallyinteresting,oritemsofconven-
tionalwisdom,orcontroversialtopics,orquestionsthathavepoliticalconse-
quences,andseeifyoucanformulateaquestionthatlendsitselftostatistical
inquiry.
1.10.Glossary15
Lookfordatatohelpyouaddressthequestion.Governmentsaregood
sourcesbecausedatafrompublicresearchisoftenfreelyavailable.Good
placestostartinclude
http://www.data.gov/
,and
http://www.science.
gov/
,andintheUnitedKingdom,
http://data.gov.uk/
.
TwoofmyfavoritedatasetsaretheGeneralSocialSurveyat
http://www3.
norc.org/gss+website/
,andtheEuropeanSocialSurveyat
http://www.
europeansocialsurvey.org/
.
Ifitseemslikesomeonehasalreadyansweredyourquestion,lookcloselyto
seewhethertheanswerisTheremightbewsinthedataorthe
analysisthatmaketheconclusionunreliable.Inthatcaseyoucouldperform
atanalysisofthesamedata,orlookforabettersourceofdata.
Ifyouapublishedpaperthataddressesyourquestion,youshouldbe
abletogettherawdata.Manyauthorsmaketheirdataavailableonthe
web,butforsensitivedatayoumighthavetowritetotheauthors,provide
informationabouthowyouplantousethedata,oragreetocertaintermsof
use.Bepersistent!
1.10Glossary

anecdotalevidence
:Evidence,oftenpersonal,thatiscollectedcasu-
allyratherthanbyawell-designedstudy.

population
:Agroupweareinterestedinstudying.\Population"
oftenreferstoagroupofpeople,butthetermisusedforothersubjects,
too.

cross-sectionalstudy
:Astudythatcollectsdataaboutapopulation
ataparticularpointintime.

cycle
:Inarepeatedcross-sectionalstudy,eachrepetitionofthestudy
iscalledacycle.

longitudinalstudy
:Astudythatfollowsapopulationovertime,
collectingdatafromthesamegrouprepeatedly.

record
:Inadataset,acollectionofinformationaboutasingleperson
orothersubject.
16Chapter1.Exploratorydataanalysis

respondent
:Apersonwhorespondstoasurvey.

sample
:Thesubsetofapopulationusedtocollectdata.

representative
:Asampleisrepresentativeifeverymemberofthe
populationhasthesamechanceofbeinginthesample.

oversampling
:Thetechniqueofincreasingtherepresentationofa
sub-populationinordertoavoiderrorsduetosmallsamplesizes.

rawdata
:Valuescollectedandrecordedwithlittleornochecking,
calculationorinterpretation.

recode
:Avaluethatisgeneratedbycalculationandotherlogicap-
pliedtorawdata.

datacleaning
:Processesthatincludevalidatingdata,identifyinger-
rors,translatingbetweendatatypesandrepresentations,etc.
Chapter2
Distributions
2.1Histograms
Oneofthebestwaystodescribeavariableistoreportthevaluesthatappear
inthedatasetandhowmanytimeseachvalueappears.Thisdescriptionis
calledthe
distribution
ofthevariable.
Themostcommonrepresentationofadistributionisa
histogram
,whichisa
graphthatshowsthe
frequency
ofeachvalue.Inthiscontext,\frequency"
meansthenumberoftimesthevalueappears.
InPython,antwaytocomputefrequenciesiswithadictionary.Given
asequenceofvalues,
t
:
hist={}
forxint:
hist[x]=hist.get(x,0)+1
Theresultisadictionarythatmapsfromvaluestofrequencies.Alternatively,
youcouldusethe
Counter
classinthe
collections
module:
fromcollectionsimportCounter
counter=Counter(t)
Theresultisa
Counter
object,whichisasubclassofdictionary.
18Chapter2.Distributions
Anotheroptionistousethepandasmethod
value_counts
,whichwesawin
thepreviouschapter.ButforthisbookIcreatedaclass,Hist,thatrepresents
histogramsandprovidesthemethodsthatoperateonthem.
2.2Representinghistograms
TheHistconstructorcantakeasequence,dictionary,pandasSeries,oran-
otherHist.YoucaninstantiateaHistobjectlikethis:
>>>importthinkstats2
>>>hist=thinkstats2.Hist([1,2,2,3,5])
>>>hist
Hist({1:1,2:2,3:1,5:1})
Histobjectsprovide
Freq
,whichtakesavalueandreturnsitsfrequency:
>>>hist.Freq(2)
2
Thebracketoperatordoesthesamething:
>>>hist[2]
2
Ifyoulookupavaluethathasneverappeared,thefrequencyis0.
>>>hist.Freq(4)
0
Values
returnsanunsortedlistofthevaluesintheHist:
>>>hist.Values()
[1,5,3,2]
Toloopthroughthevaluesinorder,youcanusethebuilt-infunction
sorted
:
forvalinsorted(hist.Values()):
print(val,hist.Freq(val))
Oryoucanuse
Items
toiteratethroughvalue-frequencypairs:
forval,freqinhist.Items():
print(val,freq)
2.3.Plottinghistograms19
Figure2.1:Histogramofthepoundpartofbirthweight.
2.3Plottinghistograms
ForthisbookIwroteamodulecalled
thinkplot.py
thatprovidesfunctions
forplottingHistsandotherobjectsin
thinkstats2.py
.Itisbased
on
pyplot
,whichispartofthe
matplotlib
package.SeeSection0.2for
informationaboutinstalling
matplotlib
.
Toplot
hist
with
thinkplot
,trythis:
>>>importthinkplot
>>>thinkplot.Hist(hist)
>>>think
Youcanreadthedocumentationfor
thinkplot
at
http://greenteapress.
com/thinkstats2/thinkplot.html
.
2.4NSFGvariables
Nowlet'sgetbacktothedatafromtheNSFG.Thecodeinthischapterisin
first.py
.Forinformationaboutdownloadingandworkingwiththiscode,
seeSection0.2.
Whenyoustartworkingwithanewdataset,Isuggestyouexplorethevari-
ablesyouareplanningtouseoneatatime,andagoodwaytostartisby
20Chapter2.Distributions
Figure2.2:Histogramoftheouncepartofbirthweight.
lookingathistograms.
InSection1.6wetransformed
agepreg
fromcentiyearstoyears,andcom-
bined
birthwgt_lb
and
birthwgt_oz
intoasinglequantity,
totalwgt_lb
.
InthissectionIusethesevariablestodemonstratesomefeaturesofhis-
tograms.
I'llstartbyreadingthedataandselectingrecordsforlivebirths:
preg=nsfg.ReadFemPreg()
live=preg[preg.outcome==1]
TheexpressioninbracketsisabooleanSeriesthatselectsrowsfromthe
DataFrameandreturnsanewDataFrame.NextIgenerateandplotthe
histogramof
birthwgt_lb
forlivebirths.
hist=thinkstats2.Hist(live.birthwgt_lb,
thinkplot.Hist(hist)

WhentheargumentpassedtoHistisapandasSeries,any
nan
valuesare
dropped.
label
isastringthatappearsinthelegendwhentheHistis
plotted.
Figure2.1showstheresult.Themostcommonvalue,calledthe
mode
,is7
pounds.Thedistributionisapproximatelybell-shaped,whichistheshape
2.4.NSFGvariables21
Figure2.3:Histogramofmother'sageatendofpregnancy.
Figure2.4:Histogramofpregnancylengthinweeks.
22Chapter2.Distributions
ofthe
normal
distribution,alsocalleda
Gaussian
distribution.Butunlike
atruenormaldistribution,thisdistributionisasymmetric;ithasa
tail
that
extendsfarthertotheleftthantotheright.
Figure2.2showsthehistogramof
birthwgt_oz
,whichistheouncespartof
birthweight.Intheoryweexpectthisdistributiontobe
uniform
;thatis,all
valuesshouldhavethesamefrequency.Infact,0ismorecommonthanthe
othervalues,and1and15arelesscommon,probablybecauserespondents
roundbirthweightsthatareclosetoanintegervalue.
Figure2.3showsthehistogramof
agepreg
,themother'sageattheendof
pregnancy.Themodeis21years.Thedistributionisveryroughlybell-
shaped,butinthiscasethetailextendsfarthertotherightthanleft;most
mothersareintheir20s,fewerintheir30s.
Figure2.4showsthehistogramof
prglngth
,thelengthofthepregnancyin
weeks.Byfarthemostcommonvalueis39weeks.Thelefttailislonger
thantheright;earlybabiesarecommon,butpregnanciesseldomgopast43
weeks,anddoctorsofteninterveneiftheydo.
2.5Outliers
Lookingathistograms,itiseasytoidentifythemostcommonvaluesand
theshapeofthedistribution,butrarevaluesarenotalwaysvisible.
Beforegoingon,itisagoodideatocheckfor
outliers
,whichareextreme
valuesthatmightbeerrorsinmeasurementandrecording,ormightbeac-
curatereportsofrareevents.
Histprovidesmethods
Largest
and
Smallest
,whichtakeaninteger
n
and
returnthe
n
largestorsmallestvaluesfromthehistogram:
forweeks,freqinhist.Smallest(10):
print(weeks,freq)
Inthelistofpregnancylengthsforlivebirths,the10lowestvaluesare
[0,4,9,13,17,18,19,20,21,22]
.Valuesbelow10weeksarecer-
tainlyerrors;themostlikelyexplanationisthattheoutcomewasnotcoded
correctly.Valueshigherthan30weeksareprobablylegitimate.Between10
2.6.Firstbabies23
and30weeks,itishardtobesure;somevaluesareprobablyerrors,but
somerepresentprematurebabies.
Ontheotherendoftherange,thehighestvaluesare:
weekscount
43148
4446
4510
461
471
487
502
Mostdoctorsrecommendinducedlaborifapregnancyexceeds42weeks,
sosomeofthelongervaluesaresurprising.Inparticular,50weeksseems
medicallyunlikely.
Thebestwaytohandleoutliersdependson\domainknowledge";thatis,
informationaboutwherethedatacomefromandwhattheymean.Andit
dependsonwhatanalysisyouareplanningtoperform.
Inthisexample,themotivatingquestioniswhetherbabiestendtobe
early(orlate).Whenpeopleaskthisquestion,theyareusuallyinterestedin
full-termpregnancies,soforthisanalysisIwillfocusonpregnancieslonger
than27weeks.
2.6Firstbabies
Nowwecancomparethedistributionofpregnancylengthsforbabies
andothers.IdividedtheDataFrameoflivebirthsusing
birthord
,and
computedtheirhistograms:
firsts=live[live.birthord==1]
others=live[live.birthord!=1]
first_hist=thinkstats2.Hist(firsts.prglngth,
other_hist=thinkstats2.Hist(others.prglngth,
ThenIplottedtheirhistogramsonthesameaxis:
24Chapter2.Distributions
Figure2.5:Histogramofpregnancylengths.
width=0.45
thinkplot.PrePlot(2)
thinkplot.Hist(first_hist,width=width)
thinkplot.Hist(other_hist,width=width)

xlim=[27,46])
thinkplot.PrePlot
takesthenumberofhistogramsweareplanningtoplot;
itusesthisinformationtochooseanappropriatecollectionofcolors.
thinkplot.Hist
normallyuses

sothateachbariscentered
overitsvalue.ForthisIuse

and

to
placecorrespondingbarsoneithersideofthevalue.
With
width=0.45
,thetotalwidthofthetwobarsis0.9,leavingsomespace
betweeneachpair.
Finally,Iadjusttheaxistoshowonlydatabetween27and46weeks.Fig-
ure2.5showstheresult.
Histogramsareusefulbecausetheymakethemostfrequentvaluesimmedi-
atelyapparent.Buttheyarenotthebestchoiceforcomparingtwodistribu-
tions.Inthisexample,therearefewerbabies"than\others,"sosome
oftheapparentinthehistogramsareduetosamplesizes.Inthe
nextchapterweaddressthisproblemusingprobabilitymassfunctions.
2.7.Summarizingdistributions25
2.7Summarizingdistributions
Ahistogramisacompletedescriptionofthedistributionofasample;thatis,
givenahistogram,wecouldreconstructthevaluesinthesample(although
nottheirorder).
Ifthedetailsofthedistributionareimportant,itmightbenecessaryto
presentahistogram.Butoftenwewanttosummarizethedistributionwith
afewdescriptivestatistics.
Someofthecharacteristicswemightwanttoreportare:

centraltendency:Dothevaluestendtoclusteraroundaparticular
point?

modes:Istheremorethanonecluster?

spread:Howmuchvariabilityisthereinthevalues?

tails:Howquicklydotheprobabilitiesdropaswemoveawayfrom
themodes?

outliers:Arethereextremevaluesfarfromthemodes?
Statisticsdesignedtoanswerthesequestionsarecalled
summarystatistics
.
Byfarthemostcommonsummarystatisticisthe
mean
,whichismeantto
describethecentraltendencyofthedistribution.
Ifyouhaveasampleof
n
values,
x
i
,themean,
x
,isthesumofthevalues
dividedbythenumberofvalues;inotherwords

x
=
1
n
X
i
x
i
Thewords\mean"and\average"aresometimesusedinterchangeably,butI
makethisdistinction:

The\mean"ofasampleisthesummarystatisticcomputedwiththe
previousformula.

An\average"isoneofseveralsummarystatisticsyoumightchooseto
describeacentraltendency.
26Chapter2.Distributions
Sometimesthemeanisagooddescriptionofasetofvalues.Forexample,
applesareallprettymuchthesamesize(atleasttheonessoldinsupermar-
kets).SoifIbuy6applesandthetotalweightis3pounds,itwouldbea
reasonablesummarytosaytheyareaboutahalfpoundeach.
Butpumpkinsaremorediverse.SupposeIgrowseveralvarietiesinmygar-
den,andonedayIharvestthreedecorativepumpkinsthatare1poundeach,
twopiepumpkinsthatare3poundseach,andoneAtlanticGiant
R

pumpkin
thatweighs591pounds.Themeanofthissampleis100pounds,butifI
toldyou\Theaveragepumpkininmygardenis100pounds,"thatwouldbe
misleading.Inthisexample,thereisnomeaningfulaveragebecausethereis
notypicalpumpkin.
2.8Variance
Ifthereisnosinglenumberthatsummarizespumpkinweights,wecandoa
littlebetterwithtwonumbers:meanand
variance
.
Varianceisasummarystatisticintendedtodescribethevariabilityorspread
ofadistribution.Thevarianceofasetofvaluesis
S
2
=
1
n
X
i
(
x
i


x
)
2
Theterm
x
i


x
iscalledthe\deviationfromthemean,"sovarianceisthe
meansquareddeviation.Thesquarerootofvariance,
S
,isthe
standard
deviation
.
Ifyouhavepriorexperience,youmighthaveseenaformulaforvariancewith
n

1inthedenominator,ratherthan
n
.Thisstatisticisusedtoestimate
thevarianceinapopulationusingasample.Wewillcomebacktothisin
Chapter8.
Pandasdatastructuresprovidesmethodstocomputemean,varianceand
standarddeviation:
mean=live.prglngth.mean()
var=live.prglngth.var()
std=live.prglngth.std()
2.9.size27
Foralllivebirths,themeanpregnancylengthis38.6weeks,thestandard
deviationis2.7weeks,whichmeansweshouldexpectdeviationsof2-3weeks
tobecommon.
Varianceofpregnancylengthis7.3,whichishardtointerpret,especially
sincetheunitsareweeks
2
,or\squareweeks."Varianceisusefulinsome
calculations,butitisnotagoodsummarystatistic.
2.9size
An
size
isasummarystatisticintendedtodescribe(waitforit)the
sizeofanForexample,todescribetherencebetweentwogroups,
oneobviouschoiceistheinthemeans.
Meanpregnancylengthforbabiesis38.601;forotherbabiesitis38.523.
Theis0.078weeks,whichworksoutto13hours.Asafractionof
thetypicalpregnancylength,thisisabout0.2%.
Ifweassumethisestimateisaccurate,suchawouldhavenoprac-
ticalconsequences.Infact,withoutobservingalargenumberofpregnancies,
itisunlikelythatanyonewouldnoticethisceatall.
Anotherwaytoconveythesizeoftheistocomparethe
betweengroupstothevariabilitywithingroups.Cohen's
d
isastatistic
intendedtodothat;itis
d
=

x
1


x
2
s
where
x
1
and
x
2
arethemeansofthegroupsand
s
isthe\pooledstandard
deviation".Here'sthePythoncodethatcomputesCohen's
d
:
defCohenEffectSize(group1,group2):
diff=group1.mean()-group2.mean()
var1=group1.var()
var2=group2.var()
n1,n2=len(group1),len(group2)
28Chapter2.Distributions
pooled_var=(n1*var1+n2*var2)/(n1+n2)
d=diff/math.sqrt(pooled_var)
returnd
Inthisexample,theerenceinmeansis0.029standarddeviations,which
issmall.Toputthatinperspective,theinheightbetweenmen
andwomenisabout1.7standarddeviations(see
https://en.wikipedia.
org/wiki/Effect_size
).
2.10Reportingresults
Wehaveseenseveralwaystodescribetheinpregnancylength(if
thereisone)betweenbabiesandothers.Howshouldwereportthese
results?
Theanswerdependsonwhoisaskingthequestion.Ascientistmightbe
interestedinany(real)nomatterhowsmall.Adoctormightonly
careaboutthatare
clinicallyt
;thatis,that
treatmentdecisions.Apregnantwomanmightbeinterestedinresults
thatarerelevanttoher,liketheprobabilityofdeliveringearlyorlate.
Howyoureportresultsalsodependsonyourgoals.Ifyouaretryingto
demonstratetheimportanceofanyoumightchoosesummarystatis-
ticsthatemphasizeIfyouaretryingtoreassureapatient,you
mightchoosestatisticsthatputtheesincontext.
Ofcourseyourdecisionsshouldalsobeguidedbyprofessionalethics.It'sok
tobepersuasive;you
should
designstatisticalreportsandvisualizationsthat
tellastoryclearly.Butyoushouldalsodoyourbesttomakeyourreports
honest,andtoacknowledgeuncertaintyandlimitations.
2.11Exercises
Exercise2.1
Basedontheresultsinthischapter,supposeyouwereasked
tosummarizewhatyoulearnedaboutwhetherbabiesarrivelate.
2.12.Glossary29
Whichsummarystatisticswouldyouuseifyouwantedtogetastoryon
theeveningnews?Whichoneswouldyouuseifyouwantedtoreassurean
anxiouspatient?
Finally,imaginethatyouareCecilAdams,authorof
TheStraightDope
(
http://straightdope.com
),andyourjobistoanswerthequestion,\Do
babiesarrivelate?"Writeaparagraphthatusestheresultsinthis
chaptertoanswerthequestionclearly,precisely,andhonestly.
Exercise2.2
Intherepositoryyoudownloaded,youshouldanamed
chap02ex.ipynb
;openit.Somecellsarealreadyin,andyoushould
executethem.Othercellsgiveyouinstructionsforexercises.Followthe
instructionsandintheanswers.
Asolutiontothisexerciseisin
chap02soln.ipynb
Intherepositoryyoudownloaded,youshouldanamed
chap02ex.py
;
youcanusethisasastartingplaceforthefollowingexercises.Mysolution
isin
chap02soln.py
.
Exercise2.3
Themodeofadistributionisthemostfrequentvalue;see
http://wikipedia.org/wiki/Mode_(statistics)
.Writeafunctioncalled
Mode
thattakesaHistandreturnsthemostfrequentvalue.
Asamorechallengingexercise,writeafunctioncalled
AllModes
thatreturns
alistofvalue-frequencypairsindescendingorderoffrequency.
Exercise2.4
Usingthevariable
totalwgt_lb
,investigatewhetherba-
biesarelighterorheavierthanothers.ComputeCohen's
d
toquantifythe
betweenthegroups.Howdoesitcomparetothein
pregnancylength?
2.12Glossary

distribution
:Thevaluesthatappearinasampleandthefrequency
ofeach.

histogram
:Amappingfromvaluestofrequencies,oragraphthat
showsthismapping.
30Chapter2.Distributions

frequency
:Thenumberoftimesavalueappearsinasample.

mode
:Themostfrequentvalueinasample,oroneofthemostfrequent
values.

normaldistribution
:Anidealizationofabell-shapeddistribution;
alsoknownasaGaussiandistribution.

uniformdistribution
:Adistributioninwhichallvalueshavethe
samefrequency.

tail
:Thepartofadistributionatthehighandlowextremes.

centraltendency
:Acharacteristicofasampleorpopulation;intu-
itively,itisanaverageortypicalvalue.

outlier
:Avaluefarfromthecentraltendency.

spread
:Ameasureofhowspreadoutthevaluesinadistributionare.

summarystatistic
:Astatisticthatquansomeaspectofadis-
tribution,likecentraltendencyorspread.

variance
:Asummarystatisticoftenusedtoquantifyspread.

standarddeviation
:Thesquarerootofvariance,alsousedasa
measureofspread.

size
:Asummarystatisticintendedtoquantifythesizeofan
likeabetweengroups.

clinicallyt
:Aresult,likearencebetweengroups,that
isrelevantinpractice.
Chapter3
Probabilitymassfunctions
Thecodeforthischapterisin
probability.py
.Forinformationabout
downloadingandworkingwiththiscode,seeSection0.2.
3.1Pmfs
Anotherwaytorepresentadistributionisa
probabilitymassfunction
(PMF),whichmapsfromeachvaluetoitsprobability.A
probability
isa
frequencyexpressedasafractionofthesamplesize,
n
.Togetfromfrequen-
ciestoprobabilities,wedividethroughby
n
,whichiscalled
normalization
.
GivenaHist,wecanmakeadictionarythatmapsfromeachvaluetoits
probability:
n=hist.Total()
d={}
forx,freqinhist.Items():
d[x]=freq/n
OrwecanusethePmfclassprovidedby
thinkstats2
.LikeHist,thePmf
constructorcantakealist,pandasSeries,dictionary,Hist,oranotherPmf
object.Here'sanexamplewithasimplelist:
32Chapter3.Probabilitymassfunctions
>>>importthinkstats2
>>>pmf=thinkstats2.Pmf([1,2,2,3,5])
>>>pmf
Pmf({1:0.2,2:0.4,3:0.2,5:0.2})
ThePmfisnormalizedsototalprobabilityis1.
PmfandHistobjectsaresimilarinmanyways;infact,theyinheritmany
oftheirmethodsfromacommonparentclass.Forexample,themethods
Values
and
Items
workthesamewayforboth.Thebiggestis
thataHistmapsfromvaluestointegercounters;aPmfmapsfromvalues
toointprobabilities.
Tolookuptheprobabilityassociatedwithavalue,use
Prob
:
>>>pmf.Prob(2)
0.4
Thebracketoperatorisequivalent:
>>>pmf[2]
0.4
YoucanmodifyanexistingPmfbyincrementingtheprobabilityassociated
withavalue:
>>>pmf.Incr(2,0.2)
>>>pmf.Prob(2)
0.6
Oryoucanmultiplyaprobabilitybyafactor:
>>>pmf.Mult(2,0.5)
>>>pmf.Prob(2)
0.3
IfyoumodifyaPmf,theresultmaynotbenormalized;thatis,theprobabil-
itiesmaynolongeraddupto1.Tocheck,youcancall
Total
,whichreturns
thesumoftheprobabilities:
>>>pmf.Total()
0.9
3.2.PlottingPMFs33
Torenormalize,call
Normalize
:
>>>pmf.Normalize()
>>>pmf.Total()
1.0
Pmfobjectsprovidea
Copy
methodsoyoucanmakeandmodifyacopy
withouttheoriginal.
Mynotationinthissectionmightseeminconsistent,butthereisasystem:I
usePmfforthenameoftheclass,
pmf
foraninstanceoftheclass,andPMF
forthemathematicalconceptofaprobabilitymassfunction.
3.2PlottingPMFs
thinkplot
providestwowaystoplotPmfs:

ToplotaPmfasabargraph,youcanuse
thinkplot.Hist
.Bargraphs
aremostusefulifthenumberofvaluesinthePmfissmall.

ToplotaPmfasastepfunction,youcanuse
thinkplot.Pmf
.This
optionismostusefuliftherearealargenumberofvaluesandthePmf
issmooth.ThisfunctionalsoworkswithHistobjects.
Inaddition,
pyplot
providesafunctioncalled
hist
thattakesasequenceof
values,computesahistogram,andplotsit.SinceIuseHistobjects,Iusually
don'tuse
pyplot.hist
.
Figure3.1showsPMFsofpregnancylengthforbabiesandothersusing
bargraphs(left)andstepfunctions(right).
ByplottingthePMFinsteadofthehistogram,wecancomparethetwo
distributionswithoutbeingmisleadbytheinsamplesize.Based
onthisstbabiesseemtobelesslikelythanotherstoarriveontime
(week39)andmorelikelytobealate(weeks41and42).
Here'sthecodethatgeneratesFigure3.1:
34Chapter3.Probabilitymassfunctions
Figure3.1:PMFofpregnancylengthsforbabiesandothers,usingbar
graphsandstepfunctions.
thinkplot.PrePlot(2,cols=2)
thinkplot.Hist(first_pmf,width=width)
thinkplot.Hist(other_pmf,width=width)
,

axis=[27,46,0,0.6])
thinkplot.PrePlot(2)
thinkplot.SubPlot(2)
thinkplot.Pmfs([first_pmf,other_pmf])

axis=[27,46,0,0.6])
PrePlot
takesoptionalparameters
rows
and
cols
tomakeagridof
inthiscaseonerowoftwoThe(ontheleft)displaysthe
Pmfsusing
thinkplot.Hist
,aswehaveseenbefore.
Thesecondcallto
PrePlot
resetsthecolorgenerator.Then
SubPlot
switchestothesecond(ontheright)anddisplaysthePmfsusing
thinkplot.Pmfs
.Iusedthe
axis
optiontoensurethatthetwoare
3.3.Othervisualizations35
onthesameaxes,whichisgenerallyagoodideaifyouintendtocompare
two
3.3Othervisualizations
HistogramsandPMFsareusefulwhileyouareexploringdataandtryingto
identifypatternsandrelationships.Onceyouhaveanideawhatisgoingon,
agoodnextstepistodesignavisualizationthatmakesthepatternsyou
haveidenasclearaspossible.
IntheNSFGdata,thebiggestinthedistributionsarenearthe
mode.Soitmakessensetozoominonthatpartofthegraph,andto
transformthedatatoemphasize
weeks=range(35,46)
diffs=[]
forweekinweeks:
p1=first_pmf.Prob(week)
p2=other_pmf.Prob(week)
diff=100*(p1-p2)
diffs.append(diff)
thinkplot.Bar(weeks,diffs)
Inthiscode,
weeks
istherangeofweeks;
diffs
isthebetweenthe
twoPMFsinpercentagepoints.Figure3.2showstheresultasabarchart.
Thismakesthepatternclearer:babiesarelesslikelytobeborn
inweek39,andsomewhatmorelikelytobeborninweeks41and42.
Fornowweshouldholdthisconclusiononlytentatively.Weusedthesame
datasettoidentifyanapparentandthenchoseavisualizationthat
makesthedapparent.Wecan'tbesurethisisreal;itmight
beduetorandomvariation.We'lladdressthisconcernlater.
3.4Theclasssizeparadox
Beforewegoon,Iwanttodemonstrateonekindofcomputationyoucando
withPmfobjects;Icallthisexamplethe\classsizeparadox."
36Chapter3.Probabilitymassfunctions
Figure3.2:inpercentagepoints,byweek.
AtmanyAmericancollegesanduniversities,thestudent-to-facultyratiois
about10:1.Butstudentsareoftensurprisedtodiscoverthattheiraverage
classsizeisbiggerthan10.Therearetworeasonsforthediscrepancy:

Studentstypicallytake4{5classespersemester,butprofessorsoften
teach1or2.

Thenumberofstudentswhoenjoyasmallclassissmall,butthenum-
berofstudentsinalargeclassis(ahem!)large.
Theectisobvious,atleastonceitispointedout;thesecondismore
subtle.Let'slookatanexample.Supposethatacollege65classesin
agivensemester,withthefollowingdistributionofsizes:
sizecount
5-98
10-148
15-1914
20-244
25-296
30-3412
35-398
40-443
45-492
3.4.Theclasssizeparadox37
IfyouasktheDeanfortheaverageclasssize,hewouldconstructaPMF,
computethemean,andreportthattheaverageclasssizeis23.7.Here'sthe
code:
d={7:8,12:8,17:14,22:4,
27:6,32:12,37:8,42:3,47:2}
pmf=thinkstats2.Pmf(d,
pmf.Mean())
Butifyousurveyagroupofstudents,askthemhowmanystudentsarein
theirclasses,andcomputethemean,youwouldthinktheaverageclasswas
bigger.Let'sseehowmuchbigger.
First,Icomputethedistributionasobservedbystudents,wheretheproba-
bilityassociatedwitheachclasssizeis\biased"bythenumberofstudents
intheclass.
defBiasPmf(pmf,label):
new_pmf=pmf.Copy(label=label)
forx,pinpmf.Items():
new_pmf.Mult(x,x)
new_pmf.Normalize()
returnnew_pmf
Foreachclasssize,
x
,wemultiplytheprobabilityby
x
,thenumberofstudents
whoobservethatclasssize.TheresultisanewPmfthatrepresentsthe
biaseddistribution.
Nowwecanplottheactualandobserveddistributions:
biased_pmf=BiasPmf(pmf,
thinkplot.PrePlot(2)
thinkplot.Pmfs([pmf,biased_pmf])

Figure3.3showstheresult.Inthebiaseddistributiontherearefewersmall
classesandmorelargeones.Themeanofthebiaseddistributionis29.1,
almost25%higherthantheactualmean.
Itisalsopossibletoinvertthisoperation.Supposeyouwanttothe
distributionofclasssizesatacollege,butyoucan'tgetreliabledatafrom
38Chapter3.Probabilitymassfunctions
Figure3.3:Distributionofclasssizes,actualandasobservedbystudents.
theDean.Analternativeistochoosearandomsampleofstudentsandask
howmanystudentsareintheirclasses.
Theresultwouldbebiasedforthereasonswe'vejustseen,butyoucanuseit
toestimatetheactualdistribution.Here'sthefunctionthatunbiasesaPmf:
defUnbiasPmf(pmf,label):
new_pmf=pmf.Copy(label=label)
forx,pinpmf.Items():
new_pmf.Mult(x,1.0/x)
new_pmf.Normalize()
returnnew_pmf
It'ssimilarto
BiasPmf
;theonlyceisthatitdivideseachprobability
by
x
insteadofmultiplying.
3.5.DataFrameindexing39
3.5DataFrameindexing
InSection1.4wereadapandasDataFrameandusedittoselectandmodify
datacolumns.Nowlet'slookatrowselection.Tostart,IcreateaNumPy
arrayofrandomnumbersanduseittoinitializeaDataFrame:
>>>importnumpyasnp
>>>importpandas
>>>array=np.random.randn(4,2)
>>>df=pandas.DataFrame(array)
>>>df
01
0-0.1435100.616050
1-1.4896470.300774
2-0.0743500.039621
3-1.3699680.545897
Bydefault,therowsandcolumnsarenumberedstartingatzero,butyou
canprovidecolumnnames:
>>>columns=
>>>df=pandas.DataFrame(array,columns=columns)
>>>df
AB
0-0.1435100.616050
1-1.4896470.300774
2-0.0743500.039621
3-1.3699680.545897
Youcanalsoproviderownames.Thesetofrownamesiscalledthe
index
;
therownamesthemselvesarecalled
labels
.
>>>index=
>>>df=pandas.DataFrame(array,columns=columns,index=index)
>>>df
AB
a-0.1435100.616050
b-1.4896470.300774
c-0.0743500.039621
d-1.3699680.545897
40Chapter3.Probabilitymassfunctions
Aswesawinthepreviouschapter,simpleindexingselectsacolumn,return-
ingaSeries:
>>>
a-0.143510
b-1.489647
c-0.074350
d-1.369968
Name:A,dtype:float64
Toselectarowbylabel,youcanusethe
loc
attribute,whichreturnsa
Series:
>>>df.l
A-0.14351
B0.61605
Name:a,dtype:float64
Ifyouknowtheintegerpositionofarow,ratherthanitslabel,youcanuse
the
iloc
attribute,whichalsoreturnsaSeries.
>>>df.iloc[0]
A-0.14351
B0.61605
Name:a,dtype:float64
loc
canalsotakealistoflabels;inthatcase,theresultisaDataFrame.
>>>indices=
>>>df.loc[indices]
AB
a-0.143510.616050
c-0.074350.039621
Finally,youcanuseaslicetoselectarangeofrowsbylabel:
>>>
AB
a-0.1435100.616050
b-1.4896470.300774
c-0.0743500.039621
Orbyintegerposition:
3.6.Exercises41
>>>df[0:2]
AB
a-0.1435100.616050
b-1.4896470.300774
TheresultineithercaseisaDataFrame,butnoticethattheresult
includestheendoftheslice;theseconddoesn't.
Myadvice:ifyourrowshavelabelsthatarenotsimpleintegers,usethe
labelsconsistentlyandavoidusingintegerpositions.
3.6Exercises
Solutionstotheseexercisesarein
chap03soln.ipynb
and
chap03soln.py
Exercise3.1
Somethingliketheclasssizeparadoxappearsifyousurvey
childrenandaskhowmanychildrenareintheirfamily.Familieswithmany
childrenaremorelikelytoappearinyoursample,andfamilieswithnochil-
drenhavenochancetobeinthesample.
UsetheNSFGrespondentvariable
NUMKDHH
toconstructtheactualdistribu-
tionforthenumberofchildrenunder18inthehousehold.
Nowcomputethebiaseddistributionwewouldseeifwesurveyedthechildren
andaskedthemhowmanychildrenunder18(includingthemselves)arein
theirhousehold.
Plottheactualandbiaseddistributions,andcomputetheirmeans.Asa
startingplace,youcanuse
chap03ex.ipynb
.
Exercise3.2
InSection2.7wecomputedthemeanofasamplebyadding
uptheelementsanddividingbyn.IfyouaregivenaPMF,youcanstill
computethemean,buttheprocessisslightlyt:

x
=
X
i
p
i
x
i
wherethe
x
i
aretheuniquevaluesinthePMFand
p
i
=
PMF
(
x
i
).Similarly,
youcancomputevariancelikethis:
S
2
=
X
i
p
i
(
x
i


x
)
2
42Chapter3.Probabilitymassfunctions
Writefunctionscalled
PmfMean
and
PmfVar
thattakeaPmfobjectandcom-
putethemeanandvariance.Totestthesemethods,checkthattheyare
consistentwiththemethods
Mean
and
Var
providedbyPmf.
Exercise3.3
Istartedwiththequestion,\Arebabiesmorelikelytobe
late?"Toaddressit,Icomputedtheinmeansbetweengroupsof
babies,butIignoredthepossibilitythattheremightbeabetween
babiesandothers
forthesamewoman
.
Toaddressthisversionofthequestion,selectrespondentswhohaveatleast
twobabiesandcomputepairwises.Doesthisformulationofthe
questionyieldatresult?
Hint:use
nsfg.MakePregMap
.
Exercise3.4
Inmostfootraces,everyonestartsatthesametime.Ifyou
areafastrunner,youusuallypassalotofpeopleatthebeginningofthe
race,butafterafewmileseveryonearoundyouisgoingatthesamespeed.
WhenIranalong-distance(209miles)relayraceforthetime,Inoticed
anoddphenomenon:whenIovertookanotherrunner,Iwasusuallymuch
faster,andwhenanotherrunnerovertookme,hewasusuallymuchfaster.
AtIthoughtthatthedistributionofspeedsmightbebimodal;thatis,
thereweremanyslowrunnersandmanyfastrunners,butfewatmyspeed.
ThenIrealizedthatIwasthevictimofabiassimilartothectofclass
size.Theracewasunusualintwoways:itusedastaggeredstart,soteams
startedatttimes;also,manyteamsincludedrunnersatdt
levelsofability.
Asaresult,runnerswerespreadoutalongthecoursewithlittlerelationship
betweenspeedandlocation.WhenIjoinedtherace,therunnersnearme
were(prettymuch)arandomsampleoftherunnersintherace.
Sowheredoesthebiascomefrom?Duringmytimeonthecourse,thechance
ofovertakingarunner,orbeingovertaken,isproportionaltothedi
inourspeeds.Iammorelikelytocatchaslowrunner,andmorelikelytobe
caughtbyafastrunner.Butrunnersatthesamespeedareunlikelytosee
eachother.
3.7.Glossary43
Writeafunctioncalled
ObservedPmf
thattakesaPmfrepresentingtheactual
distributionofrunners'speeds,andthespeedofarunningobserver,and
returnsanewPmfrepresentingthedistributionofrunners'speedsasseen
bytheobserver.
Totestyourfunction,youcanuse
relay.py
,whichreadstheresultsfrom
theJamesJoyceRamble10KinDedhamMAandconvertsthepaceofeach
runnertomph.
Computethedistributionofspeedsyouwouldobserveifyouranarelay
raceat7.5mphwiththisgroupofrunners.Asolutiontothisexerciseisin
relay_soln.py
.
3.7Glossary

Probabilitymassfunction(PMF)
:arepresentationofadistribu-
tionasafunctionthatmapsfromvaluestoprobabilities.

probability
:Afrequencyexpressedasafractionofthesamplesize.

normalization
:Theprocessofdividingafrequencybyasamplesize
togetaprobability.

index
:InapandasDataFrame,theindexisaspecialcolumnthat
containstherowlabels.
44Chapter3.Probabilitymassfunctions
Chapter4
Cumulativedistribution
functions
Thecodeforthischapterisin
cumulative.py
.Forinformationaboutdown-
loadingandworkingwiththiscode,seeSection0.2.
4.1ThelimitsofPMFs
PMFsworkwellifthenumberofvaluesissmall.Butasthenumberof
valuesincreases,theprobabilityassociatedwitheachvaluegetssmallerand
theofrandomnoiseincreases.
Forexample,wemightbeinterestedinthedistributionofbirthweights.In
theNSFGdata,thevariable
totalwgt_lb
recordsweightatbirthinpounds.
Figure4.1showsthePMFofthesevaluesforbabiesandothers.
Overall,thesedistributionsresemblethebellshapeofanormaldistribution,
withmanyvaluesnearthemeanandafewvaluesmuchhigherandlower.
Butpartsofthisarehardtointerpret.Therearemanyspikesand
valleys,andsomeapparentbetweenthedistributions.Itishard
totellwhichofthesefeaturesaremeaningful.Also,itishardtoseeoverall
patterns;forexample,whichdistributiondoyouthinkhasthehighermean?
46Chapter4.Cumulativedistributionfunctions
Figure4.1:PMFofbirthweights.ThisshowsalimitationofPMFs:
theyarehardtocomparevisually.
Theseproblemscanbemitigatedbybinningthedata;thatis,dividingthe
rangeofvaluesintonon-overlappingintervalsandcountingthenumberof
valuesineachbin.Binningcanbeuseful,butitistrickytogetthesizeof
thebinsright.Iftheyarebigenoughtosmoothoutnoise,theymightalso
smoothoutusefulinformation.
Analternativethatavoidstheseproblemsisthecumulativedistributionfunc-
tion(CDF),whichisthesubjectofthischapter.ButbeforeIcanexplain
CDFs,Ihavetoexplainpercentiles.
4.2Percentiles
Ifyouhavetakenastandardizedtest,youprobablygotyourresultsinthe
formofarawscoreanda
percentilerank
.Inthiscontext,thepercentile
rankisthefractionofpeoplewhoscoredlowerthanyou(orthesame).So
ifyouare\inthe90thpercentile,"youdidaswellasorbetterthan90%of
thepeoplewhotooktheexam.
Here'showyoucouldcomputethepercentilerankofavalue,
your_score
,
relativetothevaluesinthesequence
scores
:
4.2.Percentiles47
defPercentileRank(scores,your_score):
count=0
forscoreinscores:
ifscore<=your_score:
count+=1
percentile_rank=100.0*count/len(scores)
returnpercentile_rank
Asanexample,ifthescoresinthesequencewere55,66,77,88and99,and
yougotthe88,thenyourpercentilerankwouldbe
100*4/5
whichis
80.
Ifyouaregivenavalue,itiseasytoditspercentilerank;goingtheother
wayisslightlyharder.Ifyouaregivenapercentilerankandyouwantto
thecorrespondingvalue,oneoptionistosortthevaluesandsearchfor
theoneyouwant:
defPercentile(scores,percentile_rank):
scores.sort()
forscoreinscores:
ifPercentileRank(scores,score)>=percentile_rank:
returnscore
Theresultofthiscalculationisa
percentile
.Forexample,the50thper-
centileisthevaluewithpercentilerank50.Inthedistributionofexamscores,
the50thpercentileis77.
Thisimplementationof
Percentile
isnotent.Abetterapproachisto
usethepercentileranktocomputetheindexofthecorrespondingpercentile:
defPercentile2(scores,percentile_rank):
scores.sort()
index=percentile_rank*(len(scores)-1)//100
returnscores[index]
Thebetween\percentile"and\percentilerank"canbeconfus-
ing,andpeopledonotalwaysusethetermsprecisely.Tosummarize,
PercentileRank
takesavalueandcomputesitspercentilerankinasetof
values;
Percentile
takesapercentilerankandcomputesthecorresponding
value.
48Chapter4.Cumulativedistributionfunctions
4.3CDFs
Nowthatweunderstandpercentilesandpercentileranks,wearereadyto
tacklethe
cumulativedistributionfunction
(CDF).TheCDFisthefunc-
tionthatmapsfromavaluetoitspercentilerank.
TheCDFisafunctionof
x
,where
x
isanyvaluethatmightappearinthe
distribution.ToevaluateCDF(
x
)foraparticularvalueof
x
,wecompute
thefractionofvaluesinthedistributionlessthanorequalto
x
.
Here'swhatthatlookslikeasafunctionthattakesasequence,
sample
,and
avalue,
x
:
defEvalCdf(sample,x):
count=0.0
forvalueinsample:
ifvalue<=x:
count+=1
prob=count/len(sample)
returnprob
Thisfunctionisalmostidenticalto
PercentileRank
,exceptthattheresult
isaprobabilityintherange0{1ratherthanapercentilerankintherange
0{100.
Asanexample,supposewecollectasamplewiththevalues
[1,2,2,3,5]
.HerearesomevaluesfromitsCDF:
CDF
(0)=0
CDF
(1)=0
:
2
CDF
(2)=0
:
6
CDF
(3)=0
:
8
CDF
(4)=0
:
8
CDF
(5)=1
WecanevaluatetheCDFforanyvalueof
x
,notjustvaluesthatappearin
thesample.If
x
islessthanthesmallestvalueinthesample,CDF(
x
)is0.
4.4.RepresentingCDFs49
Figure4.2:ExampleofaCDF.
If
x
isgreaterthanthelargestvalue,CDF(
x
)is1.
Figure4.2isagraphicalrepresentationofthisCDF.TheCDFofasample
isastepfunction.
4.4RepresentingCDFs
thinkstats2
providesaclassnamedCdfthatrepresentsCDFs.Thefunda-
mentalmethodsCdfprovidesare:

Prob(x)
:Givenavalue
x
,computestheprobability
p
=CDF(
x
).The
bracketoperatorisequivalentto
Prob
.

Value(p)
:Givenaprobability
p
,computesthecorrespondingvalue,
x
;thatis,the
inverseCDF
of
p
.
TheCdfconstructorcantakeasanargumentalistofvalues,apandas
Series,aHist,Pmf,oranotherCdf.ThefollowingcodemakesaCdfforthe
distributionofpregnancylengthsintheNSFG:
live,firsts,others=first.MakeFrames()
cdf=thinkstats2.Cdf(live.prglngth,
50Chapter4.Cumulativedistributionfunctions
Figure4.3:CDFofpregnancylength.
thinkplot
providesafunctionnamed
Cdf
thatplotsCdfsaslines:
thinkplot.Cdf(cdf)

Figure4.3showstheresult.OnewaytoreadaCDFistolookuppercentiles.
Forexample,itlookslikeabout10%ofpregnanciesareshorterthan36weeks,
andabout90%areshorterthan41weeks.TheCDFalsoprovidesavisual
representationoftheshapeofthedistribution.Commonvaluesappearas
steeporverticalsectionsoftheCDF;inthisexample,themodeat39weeks
isapparent.Therearefewvaluesbelow30weeks,sotheCDFinthisrange
is
IttakessometimetogetusedtoCDFs,butonceyoudo,Ithinkyouwill
thattheyshowmoreinformation,moreclearly,thanPMFs.
4.5ComparingCDFs
CDFsareespeciallyusefulforcomparingdistributions.Forexample,hereis
thecodethatplotstheCDFofbirthweightforbabiesandothers.
first_cdf=thinkstats2.Cdf(firsts.totalwgt_lb,
other_cdf=thinkstats2.Cdf(others.totalwgt_lb,
4.6.Percentile-basedstatistics51
Figure4.4:CDFofbirthweightsforbabiesandothers.
thinkplot.PrePlot(2)
thinkplot.Cdfs([first_cdf,other_cdf])
yla
Figure4.4showstheresult.ComparedtoFigure4.1,thismakesthe
shapeofthedistributions,andthebetweenthem,muchclearer.
Wecanseethatbabiesareslightlylighterthroughoutthedistribution,
withalargerdiscrepancyabovethemean.
4.6Percentile-basedstatistics
OnceyouhavecomputedaCDF,itiseasytocomputepercentilesandper-
centileranks.TheCdfclassprovidesthesetwomethods:

PercentileRank(x)
:Givenavalue
x
,computesitspercentilerank,
100

CDF(
x
).

Percentile(p)
:Givenapercentilerank
p
,computesthecorrespond-
ingvalue,
x
.Equivalentto
Value(p/100)
.
Percentile
canbeusedtocomputepercentile-basedsummarystatistics.
Forexample,the50thpercentileisthevaluethatdividesthedistributionin
52Chapter4.Cumulativedistributionfunctions
half,alsoknownasthe
median
.Likethemean,themedianisameasureof
thecentraltendencyofadistribution.
Actually,thereareseveralof\median,"eachwithtprop-
erties.But
Percentile(50)
issimpleandttocompute.
Anotherpercentile-basedstatisticisthe
interquartilerange
(IQR),which
isameasureofthespreadofadistribution.TheIQRisthebetween
the75thand25thpercentiles.
Moregenerally,percentilesareoftenusedtosummarizetheshapeofadistri-
bution.Forexample,thedistributionofincomeisoftenreportedin\quin-
tiles";thatis,itissplitatthe20th,40th,60thand80thpercentiles.Other
distributionsaredividedintoten\deciles".Statisticslikethesethatrep-
resentequally-spacedpointsinaCDFarecalled
quantiles
.Formore,see
https://en.wikipedia.org/wiki/Quantile
.
4.7Randomnumbers
Supposewechoosearandomsamplefromthepopulationoflivebirthsand
lookupthepercentilerankoftheirbirthweights.Nowsupposewecompute
theCDFofthepercentileranks.Whatdoyouthinkthedistributionwill
looklike?
Here'showwecancomputeit.First,wemaketheCdfofbirthweights:
weights=live.totalwgt_lb
cdf=thinkstats2.Cdf(weights,
Thenwegenerateasampleandcomputethepercentilerankofeachvaluein
thesample.
sample=np.random.choice(weights,100,replace=True)
ranks=[cdf.PercentileRank(x)forxinsample]
sample
isarandomsampleof100birthweights,chosenwith
replacement
;
thatis,thesamevaluecouldbechosenmorethanonce.
ranks
isalistof
percentileranks.
FinallywemakeandplottheCdfofthepercentileranks.
4.7.Randomnumbers53
Figure4.5:CDFofpercentileranksforarandomsampleofbirthweights.
rank_cdf=thinkstats2.Cdf(ranks)
thinkplot.Cdf(rank_cdf)
eyla
Figure4.5showstheresult.TheCDFisapproximatelyastraightline,which
meansthatthedistributionisuniform.
Thatoutcomemightbenon-obvious,butitisaconsequenceofthewaythe
CDFisned.Whatthisshowsisthat10%ofthesampleisbelow
the10thpercentile,20%isbelowthe20thpercentile,andsoon,exactlyas
weshouldexpect.
So,regardlessoftheshapeoftheCDF,thedistributionofpercentileranks
isuniform.Thispropertyisuseful,becauseitisthebasisofasimpleand
talgorithmforgeneratingrandomnumberswithagivenCDF.Here's
how:

Chooseapercentilerankuniformlyfromtherange0{100.

Use
Cdf.Percentile
tothevalueinthedistributionthatcorre-
spondstothepercentilerankyouchose.
Cdfprovidesanimplementationofthisalgorithm,called
Random
:
54Chapter4.Cumulativedistributionfunctions
#classCdf:
defRandom(self):
returnself.Percentile(random.uniform(0,100))
Cdfalsoprovides
Sample
,whichtakesaninteger,
n
,andreturnsalistof
n
valueschosenatrandomfromtheCdf.
4.8Comparingpercentileranks
Percentileranksareusefulforcomparingmeasurementsacrosst
groups.Forexample,peoplewhocompeteinfootracesareusuallygrouped
byageandgender.Tocomparepeopleintagegroups,youcan
convertracetimestopercentileranks.
AfewyearsagoIrantheJamesJoyceRamble10KinDedhamMA;I
in42:44,whichwas97thinaof1633.Ibeatortied1537runnersout
of1633,somypercentilerankintheis94%.
Moregenerally,givenpositionandsize,wecancomputepercentilerank:
defPositionToPercentile(position,field_size):
beat=field_size-position+1
percentile=100.0*beat/field_size
returnpercentile
Inmyagegroup,denotedM4049for\malebetween40and49yearsofage",
Icamein26thoutof256.Somypercentilerankinmyagegroupwas90%.
IfIamstillrunningin10years(andIhopeIam),IwillbeintheM5059
division.Assumingthatmypercentilerankinmydivisionisthesame,how
muchslowershouldIexpecttobe?
IcananswerthatquestionbyconvertingmypercentilerankinM4049toa
positioninM5059.Here'sthecode:
defPercentileToPosition(percentile,field_size):
beat=percentile*field_size/100.0
position=field_size-beat+1
returnposition
4.9.Exercises55
Therewere171peopleinM5059,soIwouldhavetocomeinbetween17th
and18thplacetohavethesamepercentilerank.Thetimeofthe
17thrunnerinM5059was46:05,sothat'sthetimeIwillhavetobeatto
maintainmypercentilerank.
4.9Exercises
Forthefollowingexercises,youcanstartwith
chap04ex.ipynb
.Mysolution
isin
chap04soln.ipynb
.
Exercise4.1
Howmuchdidyouweighatbirth?Ifyoudon'tknow,callyour
motherorsomeoneelsewhoknows.UsingtheNSFGdata(alllivebirths),
computethedistributionofbirthweightsanduseittoyourpercentile
rank.Ifyouwereababy,yourpercentilerankinthedistribution
forbabies.Otherwiseusethedistributionforothers.Ifyouareinthe
90thpercentileorhigher,callyourmotherbackandapologize.
Exercise4.2
Thenumbersgeneratedby
random.random
aresupposedtobe
uniformbetween0and1;thatis,everyvalueintherangeshouldhavethe
sameprobability.
Generate1000numbersfrom
random.random
andplottheirPMFandCDF.
Isthedistributionuniform?
4.10Glossary

percentilerank
:Thepercentageofvaluesinadistributionthatare
lessthanorequaltoagivenvalue.

percentile
:Thevalueassociatedwithagivenpercentilerank.

cumulativedistributionfunction(CDF)
:Afunctionthatmaps
fromvaluestotheircumulativeprobabilities.CDF(
x
)isthefraction
ofthesamplelessthanorequalto
x
.

inverseCDF
:Afunctionthatmapsfromacumulativeprobability,
p
,
tothecorrespondingvalue.
56Chapter4.Cumulativedistributionfunctions

median
:The50thpercentile,oftenusedasameasureofcentralten-
dency.

interquartilerange
:Thebetweenthe75thand25thper-
centiles,usedasameasureofspread.

quantile
:Asequenceofvaluesthatcorrespondtoequallyspacedper-
centileranks;forexample,thequartilesofadistributionarethe25th,
50thand75thpercentiles.

replacement
:Apropertyofasamplingprocess.\Withreplacement"
meansthatthesamevaluecanbechosenmorethanonce;\without
replacement"meansthatonceavalueischosen,itisremovedfromthe
population.
Chapter5
Modelingdistributions
Thedistributionswehaveusedsofararecalled
empiricaldistributions
becausetheyarebasedonempiricalobservations,whicharenecessarily
samples.
Thealternativeisan
analyticdistribution
,whichischaracterizedbya
CDFthatisamathematicalfunction.Analyticdistributionscanbeusedto
modelempiricaldistributions.Inthiscontext,a
model
isasi
thatleavesoutunneededdetails.Thischapterpresentscommonanalytic
distributionsandusesthemtomodeldatafromavarietyofsources.
Thecodeforthischapterisin
analytic.py
.Forinformationaboutdown-
loadingandworkingwiththiscode,seeSection0.2.
5.1Theexponentialdistribution
I'llstartwiththe
exponentialdistribution
becauseitisrelativelysimple.
TheCDFoftheexponentialdistributionis
CDF(
x
)=1

e


Theparameter,

,determinestheshapeofthedistribution.Figure5.1shows
whatthisCDFlookslikewith

=0.5,1,and2.
58Chapter5.Modelingdistributions
Figure5.1:CDFsofexponentialdistributionswithvariousparameters.
Intherealworld,exponentialdistributionscomeupwhenwelookataseries
ofeventsandmeasurethetimesbetweenevents,called
interarrivaltimes
.
Iftheeventsareequallylikelytooccuratanytime,thedistributionof
interarrivaltimestendstolooklikeanexponentialdistribution.
Asanexample,wewilllookattheinterarrivaltimeofbirths.OnDecember
18,1997,44babieswereborninahospitalinBrisbane,Australia.
1
The
timeofbirthforall44babieswasreportedinthelocalpaper;thecomplete
datasetisinacalled
babyboom.dat
,inthe
ThinkStats2
repository.
df=ReadBabyBoom()
diffs=df.minutes.diff()
cdf=thinkstats2.Cdf(diffs,
thinkplot.Cdf(cdf)
,
ReadBabyBoom
readsthedataandreturnsaDataFramewithcolumns
time
,
sex
,
weight_g
,and
minutes
,where
minutes
istimeofbirthconverted
tominutessincemidnight.
diffs
isthebetweenconsecutivebirthtimes,and
cdf
isthedistri-
1
ThisexampleisbasedoninformationanddatafromDunn,\ASimpleDatasetfor
DemonstratingCommonDistributions,"JournalofStatisticsEducationv.7,n.3(1999).
5.1.Theexponentialdistribution59
Figure5.2:CDFofinterarrivaltimes(left)andCCDFonalog-yscale(right).
butionoftheseinterarrivaltimes.Figure5.2(left)showstheCDF.Itseems
tohavethegeneralshapeofanexponentialdistribution,buthowcanwe
tell?
Onewayistoplotthe
complementaryCDF
,whichis1

CDF(
x
),ona
log-yscale.Fordatafromanexponentialdistribution,theresultisastraight
line.Let'sseewhythatworks.
IfyouplotthecomplementaryCDF(CCDF)ofadatasetthatyouthinkis
exponential,youexpecttoseeafunctionlike:
y
ˇ
e


Takingthelogofbothsidesyields:
log
y
ˇ

Soonalog-yscaletheCCDFisastraightlinewithslope


.Here'show
wecangenerateaplotlikethat:
thinkplot.Cdf(cdf,complement=True)



60Chapter5.Modelingdistributions
Withtheargument
complement=True
,
thinkplot.Cdf
computesthecom-
plementaryCDFbeforeplotting.Andwith

,
thinkplot.Show
setsthe
y
axistoalogarithmicscale.
Figure5.2(right)showstheresult.Itisnotexactlystraight,whichindicates
thattheexponentialdistributionisnotaperfectmodelforthisdata.Most
likelytheunderlyingassumption|thatabirthisequallylikelyatanytime
ofday|isnotexactlytrue.Nevertheless,itmightbereasonabletomodel
thisdatasetwithanexponentialdistribution.Withthatwe
cansummarizethedistributionwithasingleparameter.
Theparameter,

,canbeinterpretedasarate;thatis,thenumberofevents
thatoccur,onaverage,inaunitoftime.Inthisexample,44babiesare
bornin24hours,sotherateis

=0
:
0306birthsperminute.Themeanof
anexponentialdistributionis1

,sothemeantimebetweenbirthsis32.7
minutes.
5.2Thenormaldistribution
The
normaldistribution
,alsocalledGaussian,iscommonlyusedbecause
itdescribesmanyphenomena,atleastapproximately.Itturnsoutthatthere
isagoodreasonforitsubiquity,whichwewillgettoinSection14.4.
Thenormaldistributionischaracterizedbytwoparameters:themean,

,and
standarddeviation
˙
.Thenormaldistributionwith

=0and
˙
=1iscalled
the
standardnormaldistribution
.ItsCDFisbyanintegralthat
doesnothaveaclosedformsolution,buttherearealgorithmsthatevaluate
ittly.OneofthemisprovidedbySciPy:
scipy.stats.norm
isan
objectthatrepresentsanormaldistribution;itprovidesamethod,
cdf
,that
evaluatesthestandardnormalCDF:
>>>importscipy.stats
>>>scipy.stats.norm.cdf(0)
0.5
Thisresultiscorrect:themedianofthestandardnormaldistributionis0
(thesameasthemean),andhalfofthevaluesfallbelowthemedian,so
CDF(0)is0.5.
5.2.Thenormaldistribution61
Figure5.3:CDFofnormaldistributionswitharangeofparameters.
norm.cdf
takesoptionalparameters:
loc
,whichspthemean,and
scale
,whichspthestandarddeviation.
thinkstats2
makesthisfunctionalittleeasiertousebyproviding
EvalNormalCdf
,whichtakesparameters
mu
and
sigma
andevaluatesthe
CDFat
x
:
defEvalNormalCdf(x,mu=0,sigma=1):
returnscipy.stats.norm.cdf(x,loc=mu,scale=sigma)
Figure5.3showsCDFsfornormaldistributionswitharangeofparameters.
Thesigmoidshapeofthesecurvesisarecognizablecharacteristicofanormal
distribution.
Inthepreviouschapterwelookedatthedistributionofbirthweightsinthe
NSFG.Figure5.4showstheempiricalCDFofweightsforalllivebirthsand
theCDFofanormaldistributionwiththesamemeanandvariance.
Thenormaldistributionisagoodmodelforthisdataset,soifwesummarize
thedistributionwiththeparameters

=7
:
28and
˙
=1
:
24,theresulting
errorbetweenthemodelandthedata)issmall.
Belowthe10thpercentilethereisadiscrepancybetweenthedataandthe
model;therearemorelightbabiesthanwewouldexpectinanormaldistribu-
tion.Ifwearespllyinterestedinpretermbabies,itwouldbeimportant
62Chapter5.Modelingdistributions
Figure5.4:CDFofbirthweightswithanormalmodel.
togetthispartofthedistributionright,soitmightnotbeappropriateto
usethenormalmodel.
5.3Normalprobabilityplot
Fortheexponentialdistribution,andafewothers,therearesimpletransfor-
mationswecanusetotestwhetherananalyticdistributionisagoodmodel
foradataset.
Forthenormaldistributionthereisnosuchtransformation,butthereis
analternativecalleda
normalprobabilityplot
.Therearetwowaysto
generateanormalprobabilityplot:thehardwayandtheeasyway.Ifyouare
interestedinthehardway,youcanreadaboutitat
https://en.wikipedia.
org/wiki/Normal_probability_plot
.Here'stheeasyway:
1.Sortthevaluesinthesample.
2.Fromastandardnormaldistribution(

=0and
˙
=1),generatea
randomsamplewiththesamesizeasthesample,andsortit.
3.Plotthesortedvaluesfromthesampleversustherandomvalues.
5.3.Normalprobabilityplot63
Figure5.5:Normalprobabilityplotforrandomsamplesfromnormaldistri-
butions.
Ifthedistributionofthesampleisapproximatelynormal,theresultisa
straightlinewithintercept
mu
andslope
sigma
.
thinkstats2
provides
NormalProbability
,whichtakesasampleandreturnstwoNumPyarrays:
xs,ys=thinkstats2.NormalProbability(sample)
ys
containsthesortedvaluesfrom
sample
;
xs
containstherandomvalues
fromthestandardnormaldistribution.
Totest
NormalProbability
Igeneratedsomefakesamplesthatwereactually
drawnfromnormaldistributionswithvariousparameters.Figure5.5shows
theresults.Thelinesareapproximatelystraight,withvaluesinthetails
deviatingmorethanvaluesnearthemean.
Nowlet'stryitwithrealdata.Here'scodetogenerateanormalprobability
plotforthebirthweightdatafromtheprevioussection.Itplotsagrayline
thatrepresentsthemodelandabluelinethatrepresentsthedata.
defMakeNormalPlot(weights):
mean=weights.mean()
std=weights.std()
xs=[-4,4]
fxs,fys=thinkstats2.FitLine(xs,inter=mean,slope=std)
64Chapter5.Modelingdistributions
Figure5.6:Normalprobabilityplotofbirthweights.
thinkplot.Plot(fxs,fys,
xs,ys=thinkstats2.NormalProbability(weights)
thinkplot.Plot(xs,ys,
weights
isapandasSeriesofbirthweights;
mean
and
std
arethemeanand
standarddeviation.
FitLine
takesasequenceof
xs
,anintercept,andaslope;itreturns
xs
and
ys
thatrepresentalinewiththegivenparameters,evaluatedatthevalues
in
xs
.
NormalProbability
returns
xs
and
ys
thatcontainvaluesfromthestandard
normaldistributionandvaluesfrom
weights
.Ifthedistributionofweights
isnormal,thedatashouldmatchthemodel.
Figure5.6showstheresultsforalllivebirths,andalsoforfulltermbirths
(pregnancylengthgreaterthan36weeks).Bothcurvesmatchthemodel
nearthemeananddeviateinthetails.Theheaviestbabiesareheavierthan
whatthemodelexpects,andthelightestbabiesarelighter.
Whenweselectonlyfulltermbirths,weremovesomeofthelightestweights,
whichreducesthediscrepancyinthelowertailofthedistribution.
Thisplotsuggeststhatthenormalmodeldescribesthedistributionwell
5.4.Thelognormaldistribution65
Figure5.7:CDFofadultweightsonalinearscale(left)andlogscale(right).
withinafewstandarddeviationsfromthemean,butnotinthetails.
Whetheritisgoodenoughforpracticalpurposesdependsonthepurposes.
5.4Thelognormaldistribution
Ifthelogarithmsofasetofvalueshaveanormaldistribution,thevalues
havea
lognormaldistribution
.TheCDFofthelognormaldistributionis
thesameastheCDFofthenormaldistribution,withlog
x
substitutedfor
x
.
CDF
lognormal
(
x
)=
CDF
normal
(log
x
)
Theparametersofthelognormaldistributionareusuallydenoted

and
˙
.Butrememberthattheseparametersare
not
themeanandstandard
deviation;themeanofalognormaldistributionisexp(

+
˙
2
=
2)andthe
standarddeviationisugly(see
http://wikipedia.org/wiki/Log-normal_
distribution
).
IfasampleisapproximatelylognormalandyouplotitsCDFonalog-xscale,
itwillhavethecharacteristicshapeofanormaldistribution.Totesthow
wellthesamplealognormalmodel,youcanmakeanormalprobability
plotusingthelogofthevaluesinthesample.
66Chapter5.Modelingdistributions
Figure5.8:Normalprobabilityplotsforadultweightonalinearscale(left)
andlogscale(right).
Asanexample,let'slookatthedistributionofadultweights,whichisap-
proximatelylognormal.
2
TheNationalCenterforChronicDiseasePreventionandHealthPromotion
conductsanannualsurveyaspartoftheBehavioralRiskFactorSurveillance
System(BRFSS).
3
In2008,theyinterviewed414,509respondentsandasked
abouttheirdemographics,health,andhealthrisks.Amongthedatathey
collectedaretheweightsinkilogramsof398,484respondents.
Therepositoryforthisbookcontains
CDBRFS08.ASC.gz
,aASCII
thatcontainsdatafromtheBRFSS,and
brfss.py
,whichreadsthe
andanalyzesthedata.
Figure5.7(left)showsthedistributionofadultweightsonalinearscale
2
Iwastippedtothispossibilitybyacomment(withoutcitation)at
http:
//mathworld.wolfram.com/LogNormalDistribution.html
.SubsequentlyIfoundapa-
perthatproposesthelogtransformandsuggestsacause:PenmanandJohnson,\The
ChangingShapeoftheBodyMassIndexDistributionCurveinthePopulation,"Prevent-
ingChronicDisease,2006July;3(3):A74.Onlineat
http://www.ncbi.nlm.nih.gov/
pmc/articles/PMC1636707
.
3
CentersforDiseaseControlandPrevention(CDC).BehavioralRiskFactorSurveil-
lanceSystemSurveyData.Atlanta,Georgia:U.S.DepartmentofHealthandHuman
Services,CentersforDiseaseControlandPrevention,2008.
5.5.TheParetodistribution67
withanormalmodel.Figure5.7(right)showsthesamedistributiononalog
scalewithalognormalmodel.Thelognormalmodelisabetterbutthis
representationofthedatadoesnotmaketheparticularlydramatic.
Figure5.8showsnormalprobabilityplotsforadultweights,
w
,andfortheir
logarithms,log
10
w
.Nowitisapparentthatthedatadeviatesubstantially
fromthenormalmodel.Ontheotherhand,thelognormalmodelisagood
matchforthedata.
5.5TheParetodistribution
The
Paretodistribution
isnamedaftertheeconomistVilfredoPareto,
whousedittodescribethedistributionofwealth(see
http://wikipedia.
org/wiki/Pareto_distribution
).Sincethen,ithasbeenusedtodescribe
phenomenainthenaturalandsocialsciencesincludingsizesofcitiesand
towns,sandparticlesandmeteorites,forestsandearthquakes.
TheCDFoftheParetodistributionis:
CDF
(
x
)=1


x
x
m



Theparameters
x
m
and

determinethelocationandshapeofthedistribu-
tion.
x
m
istheminimumpossiblevalue.Figure5.9showsCDFsofPareto
distributionswith
x
m
=0
:
5andtvaluesof

.
Thereisasimplevisualtestthatindicateswhetheranempiricaldistribution
aParetodistribution:onalog-logscale,theCCDFlookslikeastraight
line.Let'sseewhythatworks.
IfyouplottheCCDFofasamplefromaParetodistributiononalinear
scale,youexpecttoseeafunctionlike:
y
ˇ

x
x
m



Takingthelogofbothsidesyields:
log
y
ˇ

(log
x

log
x
m
)
68Chapter5.Modelingdistributions
Figure5.9:CDFsofParetodistributionswithtparameters.
Soifyouplotlog
y
versuslog
x
,itshouldlooklikeastraightlinewithslope


andintercept

log
x
m
.
Asanexample,let'slookatthesizesofcitiesandtowns.TheU.S.Census
Bureaupublishesthepopulationofeveryincorporatedcityandtowninthe
UnitedStates.
Idownloadedtheirdatafrom
http://www.census.gov/popest/data/
cities/totals/2012/SUB-EST2012-3.html
;itisintherepositoryforthis
bookinanamed
PEP_2012_PEPANNRES_with_ann.csv
.Therepository
alsocontains
populations.py
,whichreadstheandplotsthedistribution
ofpopulations.
Figure5.10showstheCCDFofpopulationsonalog-logscale.Thelargest
1%ofcitiesandtowns,below10

2
,fallalongastraightline.Sowecould
conclude,assomeresearchershave,thatthetailofthisdistributiona
Paretomodel.
Ontheotherhand,alognormaldistributionalsomodelsthedatawell.Fig-
ure5.11showstheCDFofpopulationsandalognormalmodel(left),and
anormalprobabilityplot(right).Bothplotsshowgoodagreementbetween
thedataandthemodel.
Neithermodelisperfect.TheParetomodelonlyappliestothelargest1%of
5.6.Generatingrandomnumbers69
Figure5.10:CCDFsofcityandtownpopulations,onalog-logscale.
cities,butitisabetterforthatpartofthedistribution.Thelognormal
modelisabetterfortheother99%.Whichmodelisappropriatedepends
onwhichpartofthedistributionisrelevant.
5.6Generatingrandomnumbers
AnalyticCDFscanbeusedtogeneraterandomnumberswithagivendis-
tributionfunction,
p
=CDF(
x
).Ifthereisantwaytocompute
theinverseCDF,wecangeneraterandomvalueswiththeappropriatedis-
tributionbychoosing
p
fromauniformdistributionbetween0and1,then
choosing
x
=
ICDF
(
p
).
Forexample,theCDFoftheexponentialdistributionis
p
=1

e


Solvingfor
x
yields:
x
=

log(1

p
)

SoinPythonwecanwrite
defexpovariate(lam):
70Chapter5.Modelingdistributions
Figure5.11:CDFofcityandtownpopulationsonalog-xscale(left),and
normalprobabilityplotoflog-transformedpopulations(right).
p=random.random()
x=-math.log(1-p)/lam
returnx
expovariate
takes
lam
andreturnsarandomvaluechosenfromtheexpo-
nentialdistributionwithparameter
lam
.
Twonotesaboutthisimplementation:Icalledtheparameter
lam
because
lambda
isaPythonkeyword.Also,sincelog0isundwehavetobe
alittlecareful.Theimplementationof
random.random
canreturn0butnot
1,so1

p
canbe1butnot0,so
log(1-p)
isalways
5.7Whymodel?
Atthebeginningofthischapter,Isaidthatmanyrealworldphenomenacan
bemodeledwithanalyticdistributions.\So,"youmightask,\what?"
Likeallmodels,analyticdistributionsareabstractions,whichmeansthey
leaveoutdetailsthatareconsideredirrelevant.Forexample,anobserved
distributionmighthavemeasurementerrorsorquirksthataresptothe
sample;analyticmodelssmoothouttheseidiosyncrasies.
5.8.Exercises71
Analyticmodelsarealsoaformofdatacompression.Whenamodel
adatasetwell,asmallsetofparameterscansummarizealargeamountof
data.
Itissometimessurprisingwhendatafromanaturalphenomenonanan-
alyticdistribution,buttheseobservationscanprovideinsightintophysical
systems.Sometimeswecanexplainwhyanobserveddistributionhasapar-
ticularform.Forexample,Paretodistributionsareoftentheresultofgen-
erativeprocesseswithpositivefeedback(so-calledpreferentialattachment
processes:see
http://wikipedia.org/wiki/Preferential_attachment
.).
Also,analyticdistributionslendthemselvestomathematicalanalysis,aswe
willseeinChapter14.
Butitisimportanttorememberthatallmodelsareimperfect.Datafrom
therealworldneverananalyticdistributionperfectly.Peoplesometimes
talkasifdataaregeneratedbymodels;forexample,theymightsaythat
thedistributionofhumanheightsisnormal,orthedistributionofincome
islognormal.Takenliterally,theseclaimscannotbetrue;therearealways
betweentherealworldandmathematicalmodels.
Modelsareusefuliftheycapturetherelevantaspectsoftherealworldand
leaveoutunneededdetails.Butwhatis\relevant"or\unneeded"depends
onwhatyouareplanningtousethemodelfor.
5.8Exercises
Forthefollowingexercises,youcanstartwith
chap05ex.ipynb
.Mysolution
isin
chap05soln.ipynb
.
Exercise5.1
IntheBRFSS(seeSection5.4),thedistributionofheightsis
roughlynormalwithparameters

=178cmand
˙
=7
:
7cmformen,and

=163cmand
˙
=7
:
3cmforwomen.
InordertojoinBlueManGroup,youhavetobemalebetween5'10"and
6'1"(see
http://bluemancasting.com
).WhatpercentageoftheU.S.male
populationisinthisrange?Hint:use
scipy.stats.norm.cdf
.
72Chapter5.Modelingdistributions
Exercise5.2
TogetafeelfortheParetodistribution,let'sseehowt
theworldwouldbeifthedistributionofhumanheightwerePareto.Withthe
parameters
x
m
=1mand

=1
:
7,wegetadistributionwithareasonable
minimum,1m,andmedian,1.5m.
Plotthisdistribution.WhatisthemeanhumanheightinParetoworld?
Whatfractionofthepopulationisshorterthanthemean?Ifthereare7
billionpeopleinParetoworld,howmanydoweexpecttobetallerthan1
km?Howtalldoweexpectthetallestpersontobe?
Exercise5.3
TheWeibulldistributionisageneralizationoftheexponential
distributionthatcomesupinfailureanalysis(see
http://wikipedia.org/
wiki/Weibull_distribution
).ItsCDFis
CDF
(
x
)=1

e

(

)
k
CanyouatransformationthatmakesaWeibulldistributionlooklikea
straightline?Whatdotheslopeandinterceptofthelineindicate?
Use
random.weibullvariate
togenerateasamplefromaWeibulldistribu-
tionanduseittotestyourtransformation.
Exercise5.4
Forsmallvaluesof
n
,wedon'texpectanempiricaldistribution
toananalyticdistributionexactly.Onewaytoevaluatethequalityof
istogenerateasamplefromananalyticdistributionandseehowwellit
matchesthedata.
Forexample,inSection5.1weplottedthedistributionoftimebetweenbirths
andsawthatitisapproximatelyexponential.Butthedistributionisbased
ononly44datapoints.Toseewhetherthedatamighthavecomefroman
exponentialdistribution,generate44valuesfromanexponentialdistribution
withthesamemeanasthedata,about33minutesbetweenbirths.
Plotthedistributionoftherandomvaluesandcompareittotheactual
distribution.Youcanuse
random.expovariate
togeneratethevalues.
Exercise5.5
Intherepositoryforthisbook,you'llasetofdata
called
mystery0.dat
,
mystery1.dat
,andsoon.Eachcontainsasequence
ofrandomnumbersgeneratedfromananalyticdistribution.
Youwillalso
test_models.py
,ascriptthatreadsdatafromaand
plotstheCDFunderavarietyoftransforms.Youcanrunitlikethis:
5.9.Glossary73
$pythontest_models.pymystery0.dat
Basedontheseplots,youshouldbeabletoinferwhatkindofdistribution
generatedeachIfyouarestumped,youcanlookin
mystery.py
,which
containsthecodethatgeneratedthe
Exercise5.6
Thedistributionsofwealthandincomearesometimesmodeled
usinglognormalandParetodistributions.Toseewhichisbetter,let'slook
atsomedata.
TheCurrentPopulationSurvey(CPS)isajointoftheBureauofLabor
StatisticsandtheCensusBureautostudyincomeandrelatedvariables.
Datacollectedin2013isavailablefrom
http://www.census.gov/hhes/www/
cpstables/032013/hhinc/toc.htm
.Idownloaded
hinc06.xls
,whichisan
Excelspreadsheetwithinformationabouthouseholdincome,andconverted
itto
hinc06.csv
,aCSVyouwillintherepositoryforthisbook.
Youwillalso
hinc.py
,whichreadsthis
Extractthedistributionofincomesfromthisdataset.Areanyoftheanalytic
distributionsinthischapteragoodmodelofthedata?Asolutiontothis
exerciseisin
hinc_soln.py
.
5.9Glossary

empiricaldistribution
:Thedistributionofvaluesinasample.

analyticdistribution
:AdistributionwhoseCDFisananalyticfunc-
tion.

model
:AusefulAnalyticdistributionsareoftengood
modelsofmorecomplexempiricaldistributions.

interarrivaltime
:Theelapsedtimebetweentwoevents.

complementaryCDF
:Afunctionthatmapsfromavalue,
x
,tothe
fractionofvaluesthatexceed
x
,whichis1

CDF(
x
).

standardnormaldistribution
:Thenormaldistributionwithmean
0andstandarddeviation1.

normalprobabilityplot
:Aplotofthevaluesinasampleversus
randomvaluesfromastandardnormaldistribution.
74Chapter5.Modelingdistributions
Chapter6
Probabilitydensityfunctions
Thecodeforthischapterisin
density.py
.Forinformationaboutdown-
loadingandworkingwiththiscode,seeSection0.2.
6.1PDFs
ThederivativeofaCDFiscalleda
probabilitydensityfunction
,orPDF.
Forexample,thePDFofanexponentialdistributionis
PDF
expo
(
x
)=



ThePDFofanormaldistributionis
PDF
normal
(
x
)=
1
˙
p
2
ˇ
exp
"

1
2

x


˙

2
#
EvaluatingaPDFforaparticularvalueof
x
isusuallynotuseful.Theresult
isnotaprobability;itisaprobability
density
.
Inphysics,densityismassperunitofvolume;inordertogetamass,you
havetomultiplybyvolumeor,ifthedensityisnotconstant,youhaveto
integrateovervolume.
Similarly,
probabilitydensity
measuresprobabilityperunitof
x
.Inorder
togetaprobabilitymass,youhavetointegrateover
x
.
76Chapter6.Probabilitydensityfunctions
thinkstats2
providesaclasscalledPdfthatrepresentsaprobabilitydensity
function.EveryPdfobjectprovidesthefollowingmethods:

Density
,whichtakesavalue,
x
,andreturnsthedensityofthedistri-
butionat
x
.

Render
,whichevaluatesthedensityatadiscretesetofvaluesand
returnsapairofsequences:thesortedvalues,
xs
,andtheirprobability
densities,
ds
.

MakePmf
,whichevaluates
Density
atadiscretesetofvaluesandre-
turnsanormalizedPmfthatapproximatesthePdf.

GetLinspace
,whichreturnsthedefaultsetofpointsusedby
Render
and
MakePmf
.
Pdfisanabstractparentclass,whichmeansyoushouldnotinstantiate
it;thatis,youcannotcreateaPdfobject.Instead,youshouldda
childclassthatinheritsfromPdfandprovidesof
Density
and
GetLinspace
.Pdfprovides
Render
and
MakePmf
.
Forexample,
thinkstats2
providesaclassnamed
NormalPdf
thatevaluates
thenormaldensityfunction.
classNormalPdf(Pdf):
def__init__(self,mu=0,sigma=1,
self.mu=mu
self.sigma=sigma
self.label=label
defDensity(self,xs):
returnscipy.stats.norm.pdf(xs,self.mu,self.sigma)
defGetLinspace(self):
low,high=self.mu-3*self.sigma,self.mu+3*self.sigma
returnnp.linspace(low,high,101)
TheNormalPdfobjectcontainstheparameters
mu
and
sigma
.
Density
uses
scipy.stats.norm
,whichisanobjectthatrepresentsanormaldistribution
andprovides
cdf
and
pdf
,amongothermethods(seeSection5.2).
6.2.Kerneldensityestimation77
ThefollowingexamplecreatesaNormalPdfwiththemeanandvariance
ofadultfemaleheights,incm,fromtheBRFSS(seeSection5.4).Thenit
computesthedensityofthedistributionatalocationonestandarddeviation
fromthemean.
>>>mean,var=163,52.8
>>>std=math.sqrt(var)
>>>pdf=thinkstats2.NormalPdf(mean,std)
>>>pdf.Density(mean+std)
0.0333001
Theresultisabout0.03,inunitsofprobabilitymasspercm.Again,a
probabilitydensitydoesn'tmeanmuchbyitself.ButifweplotthePdf,we
canseetheshapeofthedistribution:
>>>thinkplot.Pdf(pdf,
>>>thinkplot.Show()
thinkplot.Pdf
plotsthePdfasasmoothfunction,ascontrastedwith
thinkplot.Pmf
,whichrendersaPmfasastepfunction.Figure6.1shows
theresult,aswellasaPDFestimatedfromasample,whichwe'llcompute
inthenextsection.
Youcanuse
MakePmf
toapproximatethePdf:
>>>pmf=pdf.MakePmf()
Bydefault,theresultingPmfcontains101pointsequallyspacedfrom
mu-3*sigma
to
mu+3*sigma
.Optionally,
MakePmf
and
Render
cantake
keywordarguments
low
,
high
,and
n
.
6.2Kerneldensityestimation
Kerneldensityestimation
(KDE)isanalgorithmthattakesasample
andanappropriatelysmoothPDFthatthedata.Youcanread
detailsat
http://en.wikipedia.org/wiki/Kernel_density_estimation
.
scipy
providesanimplementationofKDEand
thinkstats2
providesaclass
called
EstimatedPdf
thatusesit:
78Chapter6.Probabilitydensityfunctions
Figure6.1:AnormalPDFthatmodelsadultfemaleheightintheU.S.,and
thekerneldensityestimateofasamplewith
n
=500.
classEstimatedPdf(Pdf):
def__init__(self,sample):
self.kde=scipy.stats.gaussian_kde(sample)
defDensity(self,xs):
returnself.kde.evaluate(xs)
__init__
takesasampleandcomputesakerneldensityestimate.Theresult
isa
gaussian_kde
objectthatprovidesan
evaluate
method.
Density
takesavalueorsequence,calls
gaussian_kde.evaluate
,andre-
turnstheresultingdensity.Theword\Gaussian"appearsinthenamebe-
causeitusesabasedonaGaussiandistributiontosmooththeKDE.
Here'sanexamplethatgeneratesasamplefromanormaldistributionand
thenmakesanEstimatedPdftoit:
>>>sample=[random.gauss(mean,std)foriinrange(500)]
>>>sample_pdf=thinkstats2.EstimatedPdf(sample)
>>>thinkplot.Pdf(sample_pdf,
sample
isalistof500randomheights.
sample_pdf
isaPdfobjectthat
containstheestimatedKDEofthesample.
6.3.Thedistributionframework79
Figure6.1showsthenormaldensityfunctionandaKDEbasedonasam-
pleof500randomheights.Theestimateisagoodmatchfortheoriginal
distribution.
EstimatingadensityfunctionwithKDEisusefulforseveralpurposes:

Visualization:
Duringtheexplorationphaseofaproject,CDFsare
usuallythebestvisualizationofadistribution.Afteryoulookata
CDF,youcandecidewhetheranestimatedPDFisanappropriate
modelofthedistribution.Ifso,itcanbeabetterchoiceforpresenting
thedistributiontoanaudiencethatisunfamiliarwithCDFs.

Interpolation:
AnestimatedPDFisawaytogetfromasampleto
amodelofthepopulation.Ifyouhavereasontobelievethatthe
populationdistributionissmooth,youcanuseKDEtointerpolatethe
densityforvaluesthatdon'tappearinthesample.

Simulation:
Simulationsareoftenbasedonthedistributionofasample.
Ifthesamplesizeissmall,itmightbeappropriatetosmooththesample
distributionusingKDE,whichallowsthesimulationtoexploremore
possibleoutcomes,ratherthanreplicatingtheobserveddata.
6.3Thedistributionframework
AtthispointwehaveseenPMFs,CDFsandPDFs;let'stakeaminuteto
review.Figure6.2showshowthesefunctionsrelatetoeachother.
WestartedwithPMFs,whichrepresenttheprobabilitiesforadiscretesetof
values.TogetfromaPMFtoaCDF,youadduptheprobabilitymassesto
getcumulativeprobabilities.TogetfromaCDFbacktoaPMF,youcompute
incumulativeprobabilities.We'llseetheimplementationofthese
operationsinthenextfewsections.
APDFisthederivativeofacontinuousCDF;or,equivalently,aCDFisthe
integralofaPDF.RememberthataPDFmapsfromvaluestoprobability
densities;togetaprobability,youhavetointegrate.
Togetfromadiscretetoacontinuousdistribution,youcanperformvarious
kindsofsmoothing.Oneformofsmoothingistoassumethatthedatacome
80Chapter6.Probabilitydensityfunctions
Figure6.2:Aframeworkthatrelatesrepresentationsofdistributionfunc-
tions.
fromananalyticcontinuousdistribution(likeexponentialornormal)and
toestimatetheparametersofthatdistribution.Anotheroptioniskernel
densityestimation.
Theoppositeofsmoothingis
discretizing
,orquantizing.Ifyouevaluatea
PDFatdiscretepoints,youcangenerateaPMFthatisanapproximationof
thePDF.Youcangetabetterapproximationusingnumericalintegration.
TodistinguishbetweencontinuousanddiscreteCDFs,itmightbebetterfor
adiscreteCDFtobea\cumulativemassfunction,"butasfarasIcantell
nooneusesthatterm.
6.4Histimplementation
Atthispointyoushouldknowhowtousethebasictypesprovidedby
thinkstats2
:Hist,Pmf,Cdf,andPdf.Thenextfewsectionsprovidede-
tailsabouthowtheyareimplemented.Thismaterialmighthelpyouuse
theseclassesmoreely,butitisnotstrictlynecessary.
HistandPmfinheritfromaparentclasscalled
_DictWrapper
.Theleading
underscoreindicatesthatthisclassis\internal;"thatis,itshouldnotbe
usedbycodeinothermodules.Thenameindicateswhatitis:adictionary
6.5.Pmfimplementation81
wrapper.Itsprimaryattributeis
d
,thedictionarythatmapsfromvaluesto
theirfrequencies.
Thevaluescanbeanyhashabletype.Thefrequenciesshouldbeintegers,
butcanbeanynumerictype.
_DictWrapper
containsmethodsappropriateforbothHistandPmf,includ-
ing
__init__
,
Values
,
Items
and
Render
.Italsoprovidesmomethods
Set
,
Incr
,
Mult
,and
Remove
.Thesemethodsareallimplementedwith
dictionaryoperations.Forexample:
#class_DictWrapper
defIncr(self,x,term=1):
self.d[x]=self.d.get(x,0)+term
defMult(self,x,factor):
self.d[x]=self.d.get(x,0)*factor
defRemove(self,x):
delself.d[x]
Histalsoprovides
Freq
,whichlooksupthefrequencyofagivenvalue.
BecauseHistoperatorsandmethodsarebasedondictionaries,thesemethods
areconstanttimeoperations;thatis,theirruntimedoesnotincreaseasthe
Histgetsbigger.
6.5Pmfimplementation
PmfandHistarealmostthesamething,exceptthataPmfmapsvaluesto
ointprobabilities,ratherthanintegerfrequencies.Ifthesumofthe
probabilitiesis1,thePmfisnormalized.
Pmfprovides
Normalize
,whichcomputesthesumoftheprobabilitiesand
dividesthroughbyafactor:
#classPmf
defNormalize(self,fraction=1.0):
82Chapter6.Probabilitydensityfunctions
total=self.Total()
iftotal==0.0:
raiseprobabilityis
factor=float(fraction)/total
forxinself.d:
self.d[x]*=factor
returntotal
fraction
determinesthesumoftheprobabilitiesafternormalizing;thede-
faultvalueis1.Ifthetotalprobabilityis0,thePmfcannotbenormalized,
so
Normalize
raises
ValueError
.
HistandPmfhavethesameconstructor.Itcantakeasanargumenta
dict
,
Hist,PmforCdf,apandasSeries,alistof(value,frequency)pairs,ora
sequenceofvalues.
IfyouinstantiateaPmf,theresultisnormalized.IfyouinstantiateaHist,
itisnot.ToconstructanunnormalizedPmf,youcancreateanemptyPmf
andmodifyit.ThePmfmodonotrenormalizethePmf.
6.6Cdfimplementation
ACDFmapsfromvaluestocumulativeprobabilities,soIcouldhaveimple-
mentedCdfasa
_DictWrapper
.ButthevaluesinaCDFareorderedand
thevaluesina
_DictWrapper
arenot.Also,itisoftenusefultocomputethe
inverseCDF;thatis,themapfromcumulativeprobabilitytovalue.Sothe
implementaionIchoseistwosortedlists.ThatwayIcanusebinarysearch
todoaforwardorinverselookupinlogarithmictime.
TheCdfconstructorcantakeasaparameterasequenceofvaluesorapan-
dasSeries,adictionarythatmapsfromvaluestoprobabilities,asequence
of(value,probability)pairs,aHist,Pmf,orCdf.Orifitisgiventwopa-
rameters,ittreatsthemasasortedsequenceofvaluesandthesequenceof
correspondingcumulativeprobabilities.
Givenasequence,pandasSeries,ordictionary,theconstructormakesaHist.
ThenitusestheHisttoinitializetheattributes:
6.6.Cdfimplementation83
self.xs,freqs=zip(*sorted(dw.Items()))
self.ps=np.cumsum(freqs,dtype=np.float)
self.ps/=self.ps[-1]
xs
isthesortedlistofvalues;
freqs
isthelistofcorrespondingfrequen-
cies.
np.cumsum
computesthecumulativesumofthefrequencies.Dividing
throughbythetotalfrequencyyieldscumulativeprobabilities.For
n
values,
thetimetoconstructtheCdfisproportionalto
n
log
n
.
Hereistheimplementationof
Prob
,whichtakesavalueandreturnsits
cumulativeprobability:
#classCdf
defProb(self,x):
ifx<self.xs[0]:
return0.0
index=bisect.bisect(self.xs,x)
p=self.ps[index-1]
returnp
The
bisect
moduleprovidesanimplementationofbinarysearch.Andhere
istheimplementationof
Value
,whichtakesacumulativeprobabilityand
returnsthecorrespondingvalue:
#classCdf
defValue(self,p):
ifp<0orp>1:
raisemustbeinrange[0,
index=bisect.bisect_left(self.ps,p)
returnself.xs[index]
GivenaCdf,wecancomputethePmfbycomputingbetween
consecutivecumulativeprobabilities.IfyoucalltheCdfconstructorand
passaPmf,itcomputessbycalling
Cdf.Items
:
#classCdf
defItems(self):
a=self.ps
b=np.roll(a,1)
b[0]=0
returnzip(self.xs,a-b)
84Chapter6.Probabilitydensityfunctions
np.roll
shiftstheelementsof
a
totheright,and\rolls"thelastoneback
tothebeginning.Wereplacetheelementof
b
with0andthencompute
the
a-b
.TheresultisaNumPyarrayofprobabilities.
Cdfprovides
Shift
and
Scale
,whichmodifythevaluesintheCdf,butthe
probabilitiesshouldbetreatedasimmutable.
6.7Moments
Anytimeyoutakeasampleandreduceittoasinglenumber,thatnumberis
astatistic.Thestatisticswehaveseensofarincludemean,variance,median,
andinterquartilerange.
A
rawmoment
isakindofstatistic.Ifyouhaveasampleofvalues,
x
i
,the
k
thrawmomentis:
m
0
k
=
1
n
X
i
x
k
i
OrifyoupreferPythonnotation:
defRawMoment(xs,k):
returnsum(x**kforxinxs)/len(xs)
When
k
=1theresultisthesamplemean,
x
.Theotherrawmomentsdon't
meanmuchbythemselves,buttheyareusedinsomecomputations.
The
centralmoments
aremoreuseful.The
k
thcentralmomentis:
m
k
=
1
n
X
i
(
x
i


x
)
k
OrinPython:
defCentralMoment(xs,k):
mean=RawMoment(xs,1)
returnsum((x-mean)**kforxinxs)/len(xs)
When
k
=2theresultisthesecondcentralmoment,whichyoumight
recognizeasvariance.Theofvariancegivesahintaboutwhy
thesestatisticsarecalledmoments.Ifweattachaweightalongarulerat
eachlocation,
x
i
,andthenspintheruleraroundthemean,themoment
6.8.Skewness85
ofinertiaofthespinningweightsisthevarianceofthevalues.Ifyouare
notfamiliarwithmomentofinertia,see
http://en.wikipedia.org/wiki/
Moment_of_inertia
.
Whenyoureportmoment-basedstatistics,itisimportanttothinkaboutthe
units.Forexample,ifthevalues
x
i
areincm,therawmomentisalso
incm.Butthesecondmomentisincm
2
,thethirdmomentisincm
3
,and
soon.
Becauseoftheseunits,momentsarehardtointerpretbythemselves.That's
why,forthesecondmoment,itiscommontoreportstandarddeviation,
whichisthesquarerootofvariance,soitisinthesameunitsas
x
i
.
6.8Skewness
Skewness
isapropertythatdescribestheshapeofadistribution.Ifthe
distributionissymmetricarounditscentraltendency,itisunskewed.Ifthe
valuesextendfarthertotheright,itis\rightskewed"andifthevaluesextend
left,itis\leftskewed."
Thisuseof\skewed"doesnothavetheusualconnotationof\biased."Skew-
nessonlydescribestheshapeofthedistribution;itsaysnothingabout
whetherthesamplingprocessmighthavebeenbiased.
Severalstatisticsarecommonlyusedtoquantifytheskewnessofadistri-
bution.Givenasequenceofvalues,
x
i
,the
sampleskewness
,
g
1
,canbe
computedlikethis:
defStandardizedMoment(xs,k):
var=CentralMoment(xs,2)
std=math.sqrt(var)
returnCentralMoment(xs,k)/std**k
defSkewness(xs):
returnStandardizedMoment(xs,3)
g
1
isthethird
standardizedmoment
,whichmeansthatithasbeennor-
malizedsoithasnounits.
86Chapter6.Probabilitydensityfunctions
Negativeskewnessindicatesthatadistributionskewsleft;positiveskewness
indicatesthatadistributionskewsright.Themagnitudeof
g
1
indicatesthe
strengthoftheskewness,butbyitselfitisnoteasytointerpret.
Inpractice,computingsampleskewnessisusuallynotagoodidea.Ifthere
areanyoutliers,theyhaveadisproportionateton
g
1
.
Anotherwaytoevaluatetheasymmetryofadistributionistolookatthe
relationshipbetweenthemeanandmedian.Extremevalueshavemore
onthemeanthanthemedian,soinadistributionthatskewsleft,themeanis
lessthanthemedian.Inadistributionthatskewsright,themeanisgreater.
Pearson'smedianskewnesscot
isameasureofskewnessbased
onthebetweenthesamplemeanandmedian:
g
p
=3(
x

m
)
=S
Where
x
isthesamplemean,
m
isthemedian,and
S
isthestandarddevia-
tion.OrinPython:
defMedian(xs):
cdf=thinkstats2.Cdf(xs)
returncdf.Value(0.5)
defPearsonMedianSkewness(xs):
median=Median(xs)
mean=RawMoment(xs,1)
var=CentralMoment(xs,2)
std=math.sqrt(var)
gp=3*(mean-median)/std
returngp
Thisstatisticis
robust
,whichmeansthatitislessvulnerabletothe
ofoutliers.
Asanexample,let'slookattheskewnessofbirthweightsintheNSFG
pregnancydata.Here'sthecodetoestimateandplotthePDF:
live,firsts,others=first.MakeFrames()
data=live.totalwgt_lb.dropna()
6.8.Skewness87
Figure6.3:EstimatedPDFofbirthweightdatafromtheNSFG.
pdf=thinkstats2.EstimatedPdf(data)
thinkplot.Pdf(pdf,
Figure6.3showstheresult.Thelefttailappearslongerthantheright,
sowesuspectthedistributionisskewedleft.Themean,7.27lbs,isabit
lessthanthemedian,7.38lbs,sothatisconsistentwithleftskew.And
bothskewnesscotsarenegative:sampleskewnessis-0.59;Pearson's
medianskewnessis-0.23.
Nowlet'scomparethisdistributiontothedistributionofadultweightinthe
BRFSS.Again,here'sthecode:
df=brfss.ReadBrfss(nrows=None)
data=df.wtkg2.dropna()
pdf=thinkstats2.EstimatedPdf(data)
thinkplot.Pdf(pdf,
Figure6.4showstheresult.Thedistributionappearsskewedtotheright.
Sureenough,themean,79.0,isbiggerthanthemedian,77.3.Thesample
skewnessis1.1andPearson'smedianskewnessis0.26.
Thesignoftheskewnesscotindicateswhetherthedistributionskews
leftorright,butotherthanthat,theyarehardtointerpret.Sampleskewness
islessrobust;thatis,itismoresusceptibletooutliers.Asaresultitisless
reliablewhenappliedtoskeweddistributions,exactlywhenitwouldbemost
relevant.
88Chapter6.Probabilitydensityfunctions
Figure6.4:EstimatedPDFofadultweightdatafromtheBRFSS.
Pearson'smedianskewnessisbasedonacomputedmeanandvariance,so
itisalsosusceptibletooutliers,butsinceitdoesnotdependonathird
moment,itissomewhatmorerobust.
6.9Exercises
Asolutiontothisexerciseisin
chap06soln.py
.
Exercise6.1
Thedistributionofincomeisfamouslyskewedtotheright.In
thisexercise,we'llmeasurehowstrongthatskewis.
TheCurrentPopulationSurvey(CPS)isajointoftheBureauofLabor
StatisticsandtheCensusBureautostudyincomeandrelatedvariables.
Datacollectedin2013isavailablefrom
http://www.census.gov/hhes/www/
cpstables/032013/hhinc/toc.htm
.Idownloaded
hinc06.xls
,whichisan
Excelspreadsheetwithinformationabouthouseholdincome,andconverted
itto
hinc06.csv
,aCSVyouwillintherepositoryforthisbook.
Youwillalsond
hinc2.py
,whichreadsthisandtransformsthedata.
Thedatasetisintheformofaseriesofincomerangesandthenumberof
respondentswhofellineachrange.Thelowestrangeincludesrespondents
whoreportedannualhouseholdincome\Under$5000."Thehighestrange
includesrespondentswhomade\$250,000ormore."
6.10.Glossary89
Toestimatemeanandotherstatisticsfromthesedata,wehavetomakesome
assumptionsaboutthelowerandupperbounds,andhowthevaluesaredis-
tributedineachrange.
hinc2.py
provides
InterpolateSample
,whichshows
onewaytomodelthisdata.IttakesaDataFramewithacolumn,
income
,
thatcontainstheupperboundofeachrange,and
freq
,whichcontainsthe
numberofrespondentsineachframe.
Italsotakes
log_upper
,whichisanassumedupperboundonthehighest
range,expressedin
log10
dollars.Thedefaultvalue,
log_upper=6.0
repre-
sentstheassumptionthatthelargestincomeamongtherespondentsis10
6
,
oronemilliondollars.
InterpolateSample
generatesapseudo-sample;thatis,asampleofhouse-
holdincomesthatyieldsthesamenumberofrespondentsineachrangeas
theactualdata.Itassumesthatincomesineachrangeareequallyspaced
onalog10scale.
Computethemedian,mean,skewnessandPearson'sskewnessoftheresulting
sample.Whatfractionofhouseholdsreportsataxableincomebelowthe
mean?Howdotheresultsdependontheassumedupperbound?
6.10Glossary

Probabilitydensityfunction(PDF)
:Thederivativeofacontinu-
ousCDF,afunctionthatmapsavaluetoitsprobabilitydensity.

Probabilitydensity
:Aquantitythatcanbeintegratedoverarange
ofvaluestoyieldaprobability.Ifthevaluesareinunitsofcm,for
example,probabilitydensityisinunitsofprobabilitypercm.

Kerneldensityestimation(KDE)
:Analgorithmthatestimatesa
PDFbasedonasample.

discretize
:Toapproximateacontinuousfunctionordistributionwith
adiscretefunction.Theoppositeofsmoothing.

rawmoment
:Astatisticbasedonthesumofdataraisedtoapower.
90Chapter6.Probabilitydensityfunctions

centralmoment
:Astatisticbasedondeviationfromthemean,raised
toapower.

standardizedmoment
:Aratioofmomentsthathasnounits.

skewness
:Ameasureofhowasymmetricadistributionis.

sampleskewness
:Amoment-basedstatisticintendedtoquantifythe
skewnessofadistribution.

Pearson'smedianskewnesscot
:Astatisticintendedto
quantifytheskewnessofadistributionbasedonthemedian,mean,
andstandarddeviation.

robust
:Astatisticisrobustifitisrelativelyimmunetotheectof
outliers.
Chapter7
Relationshipsbetweenvariables
Sofarwehaveonlylookedatonevariableatatime.Inthischapterwe
lookatrelationshipsbetweenvariables.Twovariablesarerelatedifknowing
onegivesyouinformationabouttheother.Forexample,heightandweight
arerelated;peoplewhoaretallertendtobeheavier.Ofcourse,itisnota
perfectrelationship:thereareshortheavypeopleandtalllightones.Butif
youaretryingtoguesssomeone'sweight,youwillbemoreaccurateifyou
knowtheirheightthanifyoudon't.
Thecodeforthischapterisin
scatter.py
.Forinformationaboutdown-
loadingandworkingwiththiscode,seeSection0.2.
7.1Scatterplots
Thesimplestwaytocheckforarelationshipbetweentwovariablesisa
scat-
terplot
,butmakingagoodscatterplotisnotalwayseasy.Asanexample,
I'llplotweightversusheightfortherespondentsintheBRFSS(seeSec-
tion5.4).
Here'sthecodethatreadsthedataandextractsheightandweight:
df=brfss.ReadBrfss(nrows=None)
sample=thinkstats2.SampleRows(df,5000)
heights,weights=sample.htm3,sample.wtkg2
92Chapter7.Relationshipsbetweenvariables
Figure7.1:Scatterplotsofweightversusheightfortherespondentsinthe
BRFSS,unjittered(left),jittered(right).
SampleRows
choosesarandomsubsetofthedata:
defSampleRows(df,nrows,replace=False):
indices=np.random.choice(df.index,nrows,replace=replace)
sample=df.loc[indices]
returnsample
df
istheDataFrame,
nrows
isthenumberofrowstochoose,and
replace
isabooleanindicatingwhethersamplingshouldbedonewithreplacement;
inotherwords,whetherthesamerowcouldbechosenmorethanonce.
thinkplot
provides
Scatter
,whichmakesscatterplots:
thinkplot.Scatter(heights,weights)


axis=[140,210,20,200])
Theresult,inFigure7.1(left),showstheshapeoftherelationship.Aswe
expected,tallerpeopletendtobeheavier.
Butthisisnotthebestrepresentationofthedata,becausethedataare
7.1.Scatterplots93
packedintocolumns.Theproblemisthattheheightsareroundedtothe
nearestinch,convertedtocentimeters,andthenroundedagain.Someinfor-
mationislostintranslation.
Wecan'tgetthatinformationback,butwecanminimizetheonthe
scatterplotby
jittering
thedata,whichmeansaddingrandomnoiseto
reversetheofroundingSincethesemeasurementswereroundedto
thenearestinch,theymightbebyupto0.5inchesor1.3cm.Similarly,
theweightsmightbeby0.5kg.
heights=thinkstats2.Jitter(heights,1.3)
weights=thinkstats2.Jitter(weights,0.5)
Here'stheimplementationof
Jitter
:
defJitter(values,jitter=0.5):
n=len(values)
returnnp.random.uniform(-jitter,+jitter,n)+values
Thevaluescanbeanysequence;theresultisaNumPyarray.
Figure7.1(right)showstheresult.Jitteringreducesthevisualof
roundingandmakestheshapeoftherelationshipclearer.Butingeneralyou
shouldonlyjitterdataforpurposesofvisualizationandavoidusingjittered
dataforanalysis.
Evenwithjittering,thisisnotthebestwaytorepresentthedata.There
aremanyoverlappingpoints,whichhidesdatainthedensepartsofthe
andgivesdisproportionateemphasistooutliers.Thiseiscalled
saturation
.
Wecansolvethisproblemwiththe
alpha
parameter,whichmakesthepoints
partlytransparent:
thinkplot.Scatter(heights,weights,alpha=0.2)
Figure7.2(left)showstheresult.Overlappingdatapointslookdarker,so
darknessisproportionaltodensity.Inthisversionoftheplotwecansee
twodetailsthatwerenotapparentbefore:verticalclustersatseveralheights
andahorizontallinenear90kgor200pounds.Sincethisdataisbasedon
self-reportsinpounds,themostlikelyexplanationisthatsomerespondents
reportedroundedvalues.
94Chapter7.Relationshipsbetweenvariables
Figure7.2:Scatterplotwithjitteringandtransparency(left),hexbinplot
(right).
Usingtransparencyworkswellformoderate-sizeddatasets,butthis
onlyshowsthe5000recordsintheBRFSS,outofatotalof414509.
Tohandlelargerdatasets,anotheroptionisahexbinplot,whichdividesthe
graphintohexagonalbinsandcolorseachbinaccordingtohowmanydata
pointsfallinit.
thinkplot
provides
HexBin
:
thinkplot.HexBin(heights,weights)
Figure7.2(right)showstheresult.Anadvantageofahexbinisthatitshows
theshapeoftherelationshipwell,anditistforlargedatasets,both
intimeandinthesizeoftheitgenerates.Adrawbackisthatitmakes
theoutliersinvisible.
Thepointofthisexampleisthatitisnoteasytomakeascatterplotthat
showsrelationshipsclearlywithoutintroducingmisleadingartifacts.
7.2.Characterizingrelationships95
Figure7.3:Percentilesofweightforarangeofheightbins.
7.2Characterizingrelationships
Scatterplotsprovideageneralimpressionoftherelationshipbetweenvari-
ables,butthereareothervisualizationsthatprovidemoreinsightintothe
natureoftherelationship.Oneoptionistobinonevariableandplotper-
centilesoftheother.
NumPyandpandasprovidefunctionsforbinningdata:
df=
bins=np.arange(135,210,5)
indices=np.digitize(df.htm3,bins)
groups=df.groupby(indices)
dropna
dropsrowswith
nan
inanyofthelistedcolumns.
arange
makesa
NumPyarrayofbinsfrom135to,butnotincluding,210,inincrementsof
5.
digitize
computestheindexofthebinthatcontainseachvaluein
df.htm3
.
TheresultisaNumPyarrayofintegerindices.Valuesthatfallbelowthe
lowestbinaremappedtoindex0.Valuesabovethehighestbinaremapped
to
len(bins)
.
groupby
isaDataFramemethodthatreturnsaGroupByobject;usedina
for
loop,
groups
iteratesthenamesofthegroupsandtheDataFramesthat
96Chapter7.Relationshipsbetweenvariables
representthem.So,forexample,wecanprintthenumberofrowsineach
grouplikethis:
fori,groupingroups:
print(i,len(group))
NowforeachgroupwecancomputethemeanheightandtheCDFofweight:
heights=[group.htm3.mean()fori,groupingroups]
cdfs=[thinkstats2.Cdf(group.wtkg2)fori,groupingroups]
Finally,wecanplotpercentilesofweightversusheight:
forpercentin[75,50,25]:
weights=[cdf.Percentile(percent)forcdfincdfs]
label=%percent
thinkplot.Plot(heights,weights,label=label)
Figure7.3showstheresult.Between140and200cmtherelationshipbetween
thesevariablesisroughlylinear.Thisrangeincludesmorethan99%ofthe
data,sowedon'thavetoworrytoomuchabouttheextremes.
7.3Correlation
A
correlation
isastatisticintendedtoquantifythestrengthoftherela-
tionshipbetweentwovariables.
Achallengeinmeasuringcorrelationisthatthevariableswewanttocompare
areoftennotexpressedinthesameunits.Andeveniftheyareinthesame
units,theycomefromtdistributions.
Therearetwocommonsolutionstotheseproblems:
1.Transformeachvaluetoa
standardscore
,whichisthenumberof
standarddeviationsfromthemean.Thistransformleadstothe\Pear-
sonproduct-momentcorrelationcot."
2.Transformeachvaluetoits
rank
,whichisitsindexinthesortedlist
ofvalues.Thistransformleadstothe\Spearmanrankcorrelation
cot."
7.4.Covariance97
If
X
isaseriesof
n
values,
x
i
,wecanconverttostandardscoresbysub-
tractingthemeananddividingbythestandarddeviation:
z
i
=(
x
i


)
=˙
.
Thenumeratorisadeviation:thedistancefromthemean.Dividingby
˙
standardizes
thedeviation,sothevaluesof
Z
aredimensionless(nounits)
andtheirdistributionhasmean0andvariance1.
If
X
isnormallydistributed,sois
Z
.Butif
X
isskewedorhasoutliers,
sodoes
Z
;inthosecases,itismorerobusttousepercentileranks.Ifwe
computeanewvariable,
R
,sothat
r
i
istherankof
x
i
,thedistributionof
R
isuniformfrom1to
n
,regardlessofthedistributionof
X
.
7.4Covariance
Covariance
isameasureofthetendencyoftwovariablestovarytogether.
Ifwehavetwoseries,
X
and
Y
,theirdeviationsfromthemeanare
dx
i
=
x
i


x
dy
i
=
y
i


y
where
x
isthesamplemeanof
X
and
y
isthesamplemeanof
Y
.If
X
and
Y
varytogether,theirdeviationstendtohavethesamesign.
Ifwemultiplythemtogether,theproductispositivewhenthedeviationshave
thesamesignandnegativewhentheyhavetheoppositesign.Soaddingup
theproductsgivesameasureofthetendencytovarytogether.
Covarianceisthemeanoftheseproducts:
Cov
(
X;Y
)=
1
n
X
dx
i
dy
i
where
n
isthelengthofthetwoseries(theyhavetobethesamelength).
Ifyouhavestudiedlinearalgebra,youmightrecognizethat
Cov
isthedot
productofthedeviations,dividedbytheirlength.Sothecovarianceis
maximizedifthetwovectorsareidentical,0iftheyareorthogonal,and
98Chapter7.Relationshipsbetweenvariables
negativeiftheypointinoppositedirections.
thinkstats2
uses
np.dot
to
implement
Cov
tly:
defCov(xs,ys,meanx=None,meany=None):
xs=np.asarray(xs)
ys=np.asarray(ys)
ifmeanxisNone:
meanx=np.mean(xs)
ifmeanyisNone:
meany=np.mean(ys)
cov=np.dot(xs-meanx,ys-meany)/len(xs)
returncov
Bydefault
Cov
computesdeviationsfromthesamplemeans,oryoucanpro-
videknownmeans.If
xs
and
ys
arePythonsequences,
np.asarray
converts
themtoNumPyarrays.IftheyarealreadyNumPyarrays,
np.asarray
does
nothing.
Thisimplementationofcovarianceismeanttobesimpleforpurposesof
explanation.NumPyandpandasalsoprovideimplementationsofcovariance,
butbothofthemapplyacorrectionforsmallsamplesizesthatwehavenot
coveredyet,and
np.cov
returnsacovariancematrix,whichismorethanwe
needfornow.
7.5Pearson'scorrelation
Covarianceisusefulinsomecomputations,butitisseldomreportedasa
summarystatisticbecauseitishardtointerpret.Amongotherproblems,
itsunitsaretheproductoftheunitsof
X
and
Y
.Forexample,thecovari-
anceofweightandheightintheBRFSSdatasetis113kilogram-centimeters,
whateverthatmeans.
Onesolutiontothisproblemistodividethedeviationsbythestandard
deviation,whichyieldsstandardscores,andcomputetheproductofstandard
scores:
p
i
=
(
x
i


x
)
S
X
(
y
i


y
)
S
Y
7.5.Pearson'scorrelation99
Where
S
X
and
S
Y
arethestandarddeviationsof
X
and
Y
.Themeanof
theseproductsis
ˆ
=
1
n
X
p
i
Orwecanrewrite
ˆ
byfactoringout
S
X
and
S
Y
:
ˆ
=
Cov
(
X;Y
)
S
X
S
Y
Thisvalueiscalled
Pearson'scorrelation
afterKarlPearson,antial
earlystatistician.Itiseasytocomputeandeasytointerpret.Because
standardscoresaredimensionless,sois
ˆ
.
Hereistheimplementationin
thinkstats2
:
defCorr(xs,ys):
xs=np.asarray(xs)
ys=np.asarray(ys)
meanx,varx=MeanVar(xs)
meany,vary=MeanVar(ys)
corr=Cov(xs,ys,meanx,meany)/math.sqrt(varx*vary)
returncorr
MeanVar
computesmeanandvarianceslightlymoretlythanseparate
callsto
np.mean
and
np.var
.
Pearson'scorrelationisalwaysbetween-1and+1(includingboth).If
ˆ
is
positive,wesaythatthecorrelationispositive,whichmeansthatwhenone
variableishigh,theothertendstobehigh.If
ˆ
isnegative,thecorrelation
isnegative,sowhenonevariableishigh,theotherislow.
Themagnitudeof
ˆ
indicatesthestrengthofthecorrelation.If
ˆ
is1or-1,
thevariablesareperfectlycorrelated,whichmeansthatifyouknowone,you
canmakeaperfectpredictionabouttheother.
Mostcorrelationintherealworldisnotperfect,butitisstilluseful.Thecor-
relationofheightandweightis0.51,whichisastrongcorrelationcompared
tosimilarhuman-relatedvariables.
100Chapter7.Relationshipsbetweenvariables
Figure7.4:Examplesofdatasetswitharangeofcorrelations.
7.6Nonlinearrelationships
IfPearson'scorrelationisnear0,itistemptingtoconcludethatthereisno
relationshipbetweenthevariables,butthatconclusionisnotvalid.Pear-
son'scorrelationonlymeasures
linear
relationships.Ifthere'sanonlinear
relationship,
ˆ
understatesitsstrength.
Figure7.4isfrom
http://wikipedia.org/wiki/Correlation_and_
dependence
.Itshowsscatterplotsandcorrelationcotsforseveral
carefullyconstructeddatasets.
Thetoprowshowslinearrelationshipswitharangeofcorrelations;youcan
usethisrowtogetasenseofwhattvaluesof
ˆ
looklike.Thesecond
rowshowsperfectcorrelationswitharangeofslopes,whichdemonstrates
thatcorrelationisunrelatedtoslope(we'lltalkaboutestimatingslopesoon).
Thethirdrowshowsvariablesthatareclearlyrelated,butbecausetherela-
tionshipisnonlinear,thecorrelationcoetis0.
Themoralofthisstoryisthatyoushouldalwayslookatascatterplotof
yourdatabeforeblindlycomputingacorrelationcot.
7.7.Spearman'srankcorrelation101
7.7Spearman'srankcorrelation
Pearson'scorrelationworkswelliftherelationshipbetweenvariablesislinear
andifthevariablesareroughlynormal.Butitisnotrobustinthepresence
ofoutliers.Spearman'srankcorrelationisanalternativethatmitigates
theofoutliersandskeweddistributions.TocomputeSpearman'scor-
relation,wehavetocomputethe
rank
ofeachvalue,whichisitsindexin
thesortedsample.Forexample,inthesample
[1,2,5,7]
therankof
thevalue5is3,becauseitappearsthirdinthesortedlist.Thenwecompute
Pearson'scorrelationfortheranks.
thinkstats2
providesafunctionthatcomputesSpearman'srankcorrelation:
defSpearmanCorr(xs,ys):
xranks=pandas.Series(xs).rank()
yranks=pandas.Series(ys).rank()
returnCorr(xranks,yranks)
IconverttheargumentstopandasSeriesobjectssoIcanuse
rank
,which
computestherankforeachvalueandreturnsaSeries.ThenIuse
Corr
to
computethecorrelationoftheranks.
Icouldalsouse
Series.corr
directlyandspecifySpearman'smethod:
defSpearmanCorr(xs,ys):
xs=pandas.Series(xs)
ys=pandas.Series(ys)
returnxs.corr(ys,
TheSpearmanrankcorrelationfortheBRFSSdatais0.54,alittlehigher
thanthePearsoncorrelation,0.51.Thereareseveralpossiblereasonsforthe
including:

Iftherelationshipisnonlinear,Pearson'scorrelationtendstounderes-
timatethestrengthoftherelationship,and

Pearson'scorrelationcanbe(ineitherdirection)ifoneofthe
distributionsisskewedorcontainsoutliers.Spearman'srankcorrela-
tionismorerobust.
IntheBRFSSexample,weknowthatthedistributionofweightsisroughly
lognormal;underalogtransformitapproximatesanormaldistribution,soit
102Chapter7.Relationshipsbetweenvariables
hasnoskew.Soanotherwaytoeliminatetheofskewnessistocompute
Pearson'scorrelationwithlog-weightandheight:
thinkstats2.Corr(df.htm3,np.log(df.wtkg2)))
Theresultis0.53,closetotherankcorrelation,0.54.Sothatsuggeststhat
skewnessinthedistributionofweightexplainsmostofthebetween
Pearson'sandSpearman'scorrelation.
7.8Correlationandcausation
IfvariablesAandBarecorrelated,therearethreepossibleexplanations:A
causesB,orBcausesA,orsomeothersetoffactorscausesbothAandB.
Theseexplanationsarecalled\causalrelationships".
Correlationalonedoesnotdistinguishbetweentheseexplanations,soit
doesnottellyouwhichonesaretrue.Thisruleisoftensummarizedwith
thephrase\Correlationdoesnotimplycausation,"whichissopithyit
hasitsownWikipediapage:
http://wikipedia.org/wiki/Correlation_
does_not_imply_causation
.
Sowhatcanyoudotoprovideevidenceofcausation?
1.Usetime.IfAcomesbeforeB,thenAcancauseBbutnottheother
wayaround(atleastaccordingtoourcommonunderstandingofcausa-
tion).Theorderofeventscanhelpusinferthedirectionofcausation,
butitdoesnotprecludethepossibilitythatsomethingelsecausesboth
AandB.
2.Userandomness.Ifyoudividealargesampleintotwogroupsatran-
domandcomputethemeansofalmostanyvariable,youexpectthe
tobesmall.Ifthegroupsarenearlyidenticalinallvariables
butone,youcaneliminatespuriousrelationships.
Thisworksevenifyoudon'tknowwhattherelevantvariablesare,but
itworksevenbetterifyoudo,becauseyoucancheckthatthegroups
areidentical.
Theseideasarethemotivationforthe
randomizedcontrolledtrial
,in
whichsubjectsareassignedrandomlytotwo(ormore)groups:a
treatment
7.9.Exercises103
group
thatreceivessomekindofintervention,likeanewmedicine,anda
controlgroup
thatreceivesnointervention,oranothertreatmentwhose
areknown.
Arandomizedcontrolledtrialisthemostreliablewaytodemonstratea
causalrelationship,andthefoundationofscience-basedmedicine(see
http:
//wikipedia.org/wiki/Randomized_controlled_trial
).
Unfortunately,controlledtrialsareonlypossibleinthelaboratorysciences,
medicine,andafewotherdisciplines.Inthesocialsciences,controlledex-
perimentsarerare,usuallybecausetheyareimpossibleorunethical.
Analternativeistolookfora
naturalexperiment
,wheret\treat-
ments"areappliedtogroupsthatareotherwisesimilar.Onedangerof
naturalexperimentsisthatthegroupsmightinwaysthatarenot
apparent.Youcanreadmoreaboutthistopicat
http://wikipedia.org/
wiki/Natural_experiment
.
Insomecasesitispossibletoinfercausalrelationshipsusing
regression
analysis
,whichisthetopicofChapter11.
7.9Exercises
Asolutiontothisexerciseisin
chap07soln.py
.
Exercise7.1
UsingdatafromtheNSFG,makeascatterplotofbirthweight
versusmother'sage.Plotpercentilesofbirthweightversusmother'sage.
ComputePearson'sandSpearman'scorrelations.Howwouldyoucharacter-
izetherelationshipbetweenthesevariables?
7.10Glossary

scatterplot
:Avisualizationoftherelationshipbetweentwovariables,
showingonepointforeachrowofdata.

jitter
:Randomnoiseaddedtodataforpurposesofvisualization.
104Chapter7.Relationshipsbetweenvariables

saturation
:Lossofinformationwhenmultiplepointsareplottedon
topofeachother.

correlation
:Astatisticthatmeasuresthestrengthoftherelationship
betweentwovariables.

standardize
:Totransformasetofvaluessothattheirmeanis0and
theirvarianceis1.

standardscore
:Avaluethathasbeenstandardizedsothatitis
expressedinstandarddeviationsfromthemean.

covariance
:Ameasureofthetendencyoftwovariablestovaryto-
gether.

rank
:Theindexwhereanelementappearsinasortedlist.

randomizedcontrolledtrial
:Anexperimentaldesigninwhichsub-
jectsaredividedintogroupsatrandom,andtgroupsaregiven
ttreatments.

treatmentgroup
:Agroupinacontrolledtrialthatreceivessome
kindofintervention.

controlgroup
:Agroupinacontrolledtrialthatreceivesnotreat-
ment,oratreatmentwhoseisknown.

naturalexperiment
:Anexperimentaldesignthattakesadvantage
ofanaturaldivisionofsubjectsintogroupsinwaysthatareatleast
approximatelyrandom.
Chapter8
Estimation
Thecodeforthischapterisin
estimation.py
.Forinformationaboutdown-
loadingandworkingwiththiscode,seeSection0.2.
8.1Theestimationgame
Let'splayagame.Ithinkofadistribution,andyouhavetoguesswhatit
is.I'llgiveyoutwohints:it'sanormaldistribution,andhere'sarandom
sampledrawnfromit:
[-0.441,1.774,-0.101,-1.138,2.975,-2.138]
Whatdoyouthinkisthemeanparameter,

,ofthisdistribution?
Onechoiceistousethesamplemean,
x
,asanestimateof

.Inthisexample,

x
is0.155,soitwouldbereasonabletoguess

=0.155.Thisprocessis
called
estimation
,andthestatisticweused(thesamplemean)iscalledan
estimator
.
Usingthesamplemeantoestimate

issoobviousthatitishardtoimagine
areasonablealternative.Butsupposewechangethegamebyintroducing
outliers.
I'mthinkingofadistribution.
It'sanormaldistribution,andhere'sasam-
plethatwascollectedbyanunreliablesurveyorwhooccasionallyputsthe
decimalpointinthewrongplace.
106Chapter8.Estimation
[-0.441,1.774,-0.101,-1.138,2.975,-213.8]
Nowwhat'syourestimateof

?Ifyouusethesamplemean,yourguessis
-35.12.Isthatthebestchoice?Whatarethealternatives?
Oneoptionistoidentifyanddiscardoutliers,thencomputethesamplemean
oftherest.Anotheroptionistousethemedianasanestimator.
Whichestimatorisbestdependsonthecircumstances(forexample,whether
thereareoutliers)andonwhatthegoalis.Areyoutryingtominimizeerrors,
ormaximizeyourchanceofgettingtherightanswer?
Iftherearenooutliers,thesamplemeanminimizesthe
meansquarederror
(MSE).Thatis,ifweplaythegamemanytimes,andeachtimecomputethe
error
x


,thesamplemeanminimizes
MSE
=
1
m
X
(
x


)
2
Where
m
isthenumberoftimesyouplaytheestimationgame,nottobe
confusedwith
n
,whichisthesizeofthesampleusedtocompute
x
.
Hereisafunctionthatsimulatestheestimationgameandcomputestheroot
meansquarederror(RMSE),whichisthesquarerootofMSE:
defEstimate1(n=7,m=1000):
mu=0
sigma=1
means=[]
medians=[]
for_inrange(m):
xs=[random.gauss(mu,sigma)foriinrange(n)]
xbar=np.mean(xs)
median=np.median(xs)
means.append(xbar)
medians.append(median)
RMSE(means,mu))
RMSE(medians,mu))
8.2.Guessthevariance107
Again,
n
isthesizeofthesample,and
m
isthenumberoftimesweplay
thegame.
means
isthelistofestimatesbasedon
x
.
medians
isthelistof
medians.
Here'sthefunctionthatcomputesRMSE:
defRMSE(estimates,actual):
e2=[(estimate-actual)**2forestimateinestimates]
mse=np.mean(e2)
returnmath.sqrt(mse)
estimates
isalistofestimates;
actual
istheactualvaluebeingestimated.
Inpractice,ofcourse,wedon'tknow
actual
;ifwedid,wewouldn'thaveto
estimateit.Thepurposeofthisexperimentistocomparetheperformance
ofthetwoestimators.
WhenIranthiscode,theRMSEofthesamplemeanwas0.41,whichmeans
thatifweuse
x
toestimatethemeanofthisdistribution,basedonasample
with
n
=7,weshouldexpecttobeby0.41onaverage.Usingthemedian
toestimatethemeanyieldsRMSE0.53,whichthat
x
yieldslower
RMSE,atleastforthisexample.
MinimizingMSEisaniceproperty,butit'snotalwaysthebeststrategy.
Forexample,supposeweareestimatingthedistributionofwindspeedsata
buildingsite.Iftheestimateistoohigh,wemightoverbuildthestructure,
increasingitscost.Butifit'stoolow,thebuildingmightcollapse.Because
costasafunctionoferrorisnotsymmetric,minimizingMSEisnotthebest
strategy.
Asanotherexample,supposeIrollthreesix-sideddiceandaskyoutopredict
thetotal.Ifyougetitexactlyright,yougetaprize;otherwiseyouget
nothing.InthiscasethevaluethatminimizesMSEis10.5,butthatwould
beabadguess,becausethetotalofthreediceisnever10.5.Forthisgame,
youwantanestimatorthathasthehighestchanceofbeingright,whichisa
maximumlikelihoodestimator
(MLE).Ifyoupick10or11,yourchance
ofwinningis1in8,andthat'sthebestyoucando.
8.2Guessthevariance
I'mthinkingofadistribution.
It'sanormaldistribution,andhere'sa(fa-
108Chapter8.Estimation
miliar)sample:
[-0.441,1.774,-0.101,-1.138,2.975,-2.138]
Whatdoyouthinkisthevariance,
˙
2
,ofmydistribution?Again,theobvious
choiceistousethesamplevariance,
S
2
,asanestimator.
S
2
=
1
n
X
(
x
i


x
)
2
Forlargesamples,
S
2
isanadequateestimator,butforsmallsamplesittends
tobetoolow.Becauseofthisunfortunateproperty,itiscalleda
biased
estimator.Anestimatoris
unbiased
iftheexpectedtotal(ormean)error,
aftermanyiterationsoftheestimationgame,is0.
Fortunately,thereisanothersimplestatisticthatisanunbiasedestimator
of
˙
2
:
S
2
n

1
=
1
n

1
X
(
x
i


x
)
2
Foranexplanationofwhy
S
2
isbiased,andaproofthat
S
2
n

1
isunbiased,
see
http://wikipedia.org/wiki/Bias_of_an_estimator
.
Thebiggestproblemwiththisestimatoristhatitsnameandsymbolare
usedinconsistently.Thename\samplevariance"canrefertoeither
S
2
or
S
2
n

1
,andthesymbol
S
2
isusedforeitherorboth.
Hereisafunctionthatsimulatestheestimationgameandteststheperfor-
manceof
S
2
and
S
2
n

1
:
defEstimate2(n=7,m=1000):
mu=0
sigma=1
estimates1=[]
estimates2=[]
for_inrange(m):
xs=[random.gauss(mu,sigma)foriinrange(n)]
biased=np.var(xs)
unbiased=np.var(xs,ddof=1)
estimates1.append(biased)
estimates2.append(unbiased)
8.3.Samplingdistributions109
errorMeanError(estimates1,sigma**2))
errorMeanError(estimates2,sigma**2))
Again,
n
isthesamplesizeand
m
isthenumberoftimesweplaythegame.
np.var
computes
S
2
bydefaultand
S
2
n

1
ifyouprovidetheargument
ddof=1
,
whichstandsfor\deltadegreesoffreedom."Iwon'texplainthatterm,
butyoucanreadaboutitat
http://en.wikipedia.org/wiki/Degrees_
of_freedom_(statistics)
.
MeanError
computesthemeanbetweentheestimatesandthe
actualvalue:
defMeanError(estimates,actual):
errors=[estimate-actualforestimateinestimates]
returnnp.mean(errors)
WhenIranthiscode,themeanerrorfor
S
2
was-0.13.Asexpected,this
biasedestimatortendstobetoolow.For
S
2
n

1
,themeanerrorwas0.014,
about10timessmaller.As
m
increases,weexpectthemeanerrorfor
S
2
n

1
toapproach0.
PropertieslikeMSEandbiasarelong-termexpectationsbasedonmany
iterationsoftheestimationgame.Byrunningsimulationsliketheonesin
thischapter,wecancompareestimatorsandcheckwhethertheyhavedesired
properties.
Butwhenyouapplyanestimatortorealdata,youjustgetoneestimate.It
wouldnotbemeaningfultosaythattheestimateisunbiased;beingunbiased
isapropertyoftheestimator,nottheestimate.
Afteryouchooseanestimatorwithappropriateproperties,anduseitto
generateanestimate,thenextstepistocharacterizetheuncertaintyofthe
estimate,whichisthetopicofthenextsection.
8.3Samplingdistributions
Supposeyouareascientiststudyinggorillasinawildlifepreserve.Youwant
toknowtheaverageweightoftheadultfemalegorillasinthepreserve.To
weighthem,youhavetotranquilizethem,whichisdangerous,expensive,
110Chapter8.Estimation
andpossiblyharmfultothegorillas.Butifitisimportanttoobtainthis
information,itmightbeacceptabletoweighasampleof9gorillas.Let's
assumethatthepopulationofthepreserveiswellknown,sowecanchoose
arepresentativesampleofadultfemales.Wecouldusethesamplemean,
x
,
toestimatetheunknownpopulationmean,

.
Havingweighed9femalegorillas,youmight
x
=90kgandsample
standarddeviation,
S
=7
:
5kg.Thesamplemeanisanunbiasedestimator
of

,andinthelongrunitminimizesMSE.Soifyoureportasingleestimate
thatsummarizestheresults,youwouldreport90kg.
Buthowntshouldyoubeinthisestimate?Ifyouonlyweigh
n
=9
gorillasoutofamuchlargerpopulation,youmightbeunluckyandchoose
the9heaviestgorillas(orthe9lightestones)justbychance.Variationin
theestimatecausedbyrandomselectioniscalled
samplingerror
.
Toquantifysamplingerror,wecansimulatethesamplingprocesswithhy-
potheticalvaluesof

and
˙
,andseehowmuch
x
varies.
Sincewedon'tknowtheactualvaluesof

and
˙
inthepopulation,we'lluse
theestimates
x
and
S
.Sothequestionweansweris:\Iftheactualvalues
of

and
˙
were90kgand7.5kg,andweranthesameexperimentmany
times,howmuchwouldtheestimatedmean,
x
,vary?"
Thefollowingfunctionanswersthatquestion:
defSimulateSample(mu=90,sigma=7.5,n=9,m=1000):
means=[]
forjinrange(m):
xs=np.random.normal(mu,sigma,n)
xbar=np.mean(xs)
means.append(xbar)
cdf=thinkstats2.Cdf(means)
ci=cdf.Percentile(5),cdf.Percentile(95)
stderr=RMSE(means,mu)
mu
and
sigma
arethe
hypothetical
valuesoftheparameters.
n
isthesample
size,thenumberofgorillaswemeasured.
m
isthenumberoftimeswerun
thesimulation.
8.3.Samplingdistributions111
Figure8.1:Samplingdistributionof
x
,withinterval.
Ineachiteration,wechoose
n
valuesfromanormaldistributionwiththe
givenparameters,andcomputethesamplemean,
xbar
.Werun1000simu-
lationsandthencomputethedistribution,
cdf
,oftheestimates.Theresult
isshowninFigure8.1.Thisdistributioniscalledthe
samplingdistribu-
tion
oftheestimator.Itshowshowmuchtheestimateswouldvaryifweran
theexperimentoverandover.
Themeanofthesamplingdistributionisprettyclosetothehypothetical
valueof

,whichmeansthattheexperimentyieldstherightanswer,on
average.After1000tries,thelowestresultis82kg,andthehighestis98kg.
Thisrangesuggeststhattheestimatemightbebyasmuchas8kg.
Therearetwocommonwaystosummarizethesamplingdistribution:

Standarderror
(SE)isameasureofhowfarweexpecttheestimate
tobeonaverage.Foreachsimulatedexperiment,wecomputethe
error,
x


,andthencomputetherootmeansquarederror(RMSE).
Inthisexample,itisroughly2.5kg.

A
interval
(CI)isarangethatincludesagivenfraction
ofthesamplingdistribution.Forexample,the90%interval
istherangefromthe5thtothe95thpercentile.Inthisexample,the
90%CIis(86
;
94)kg.
112Chapter8.Estimation
Standarderrorsandintervalsarethesourceofmuchconfusion:

Peopleoftenconfusestandarderrorandstandarddeviation.Remember
thatstandarddeviationdescribesvariabilityinameasuredquantity;
inthisexample,thestandarddeviationofgorillaweightis7.5kg.
Standarderrordescribesvariabilityinanestimate.Inthisexample,
thestandarderrorofthemean,basedonasampleof9measurements,
is2.5kg.
Onewaytoremembertheisthat,assamplesizeincreases,
standarderrorgetssmaller;standarddeviationdoesnot.

Peopleoftenthinkthatthereisa90%probabilitythattheactualpa-
rameter,

,fallsinthe90%interval.Sadly,thatisnottrue.
Ifyouwanttomakeaclaimlikethat,youhavetouseBayesianmethods
(seemybook,
ThinkBayes
).
Thesamplingdistributionanswersatquestion:itgivesyoua
senseofhowreliableanestimateisbytellingyouhowmuchitwould
varyifyourantheexperimentagain.
Itisimportanttorememberthateintervalsandstandarderrors
onlyquantifysamplingerror;thatis,errorduetomeasuringonlypartofthe
population.Thesamplingdistributiondoesnotaccountforothersourcesof
error,notablysamplingbiasandmeasurementerror,whicharethetopicsof
thenextsection.
8.4Samplingbias
Supposethatinsteadoftheweightofgorillasinanaturepreserve,youwant
toknowtheaverageweightofwomeninthecitywhereyoulive.Itisunlikely
thatyouwouldbeallowedtochoosearepresentativesampleofwomenand
weighthem.
Asimplealternativewouldbe\telephonesampling;"thatis,youcouldchoose
randomnumbersfromthephonebook,callandasktospeaktoanadult
woman,andaskhowmuchsheweighs.
8.5.Exponentialdistributions113
Telephonesamplinghasobviouslimitations.Forexample,thesampleis
limitedtopeoplewhosetelephonenumbersarelisted,soiteliminatespeople
withoutphones(whomightbepoorerthanaverage)andpeoplewithunlisted
numbers(whomightbericher).Also,ifyoucallhometelephonesduringthe
day,youarelesslikelytosamplepeoplewithjobs.Andifyouonlysample
thepersonwhoanswersthephone,youarelesslikelytosamplepeoplewho
shareaphoneline.
Iffactorslikeincome,employment,andhouseholdsizearerelatedtoweight|
anditisplausiblethattheyare|theresultsofyoursurveywouldbea
onewayoranother.Thisproblemiscalled
samplingbias
becauseitisa
propertyofthesamplingprocess.
Thissamplingprocessisalsovulnerabletoself-selection,whichisakindof
samplingbias.Somepeoplewillrefusetoanswerthequestion,andifthe
tendencytorefuseisrelatedtoweight,thatwouldtheresults.
Finally,ifyouaskpeoplehowmuchtheyweigh,ratherthanweighingthem,
theresultsmightnotbeaccurate.Evenhelpfulrespondentsmightround
upordowniftheyareuncomfortablewiththeiractualweight.Andnotall
respondentsarehelpful.Theseinaccuraciesareexamplesof
measurement
error
.
Whenyoureportanestimatedquantity,itisusefultoreportstandarderror,
oradenceinterval,orboth,inordertoquantifysamplingerror.But
itisalsoimportanttorememberthatsamplingerrorisonlyonesourceof
error,andoftenitisnotthebiggest.
8.5Exponentialdistributions
Let'splayonemoreroundoftheestimationgame.
I'mthinkingofadistri-
bution.
It'sanexponentialdistribution,andhere'sasample:
[5.384,4.493,19.198,2.790,6.122,12.844]
Whatdoyouthinkistheparameter,

,ofthisdistribution?
Ingeneral,themeanofanexponentialdistributionis1

,soworkingback-
wards,wemightchoose
L
=1
=

x
114Chapter8.Estimation
L
isanestimatorof

.Andnotjustanyestimator;itisalsothemaxi-
mumlikelihoodestimator(see
http://wikipedia.org/wiki/Exponential_
distribution#Maximum_likelihood
).Soifyouwanttomaximizeyour
chanceofguessing

exactly,
L
isthewaytogo.
Butweknowthat
x
isnotrobustinthepresenceofoutliers,soweexpect
L
tohavethesameproblem.
Wecanchooseanalternativebasedonthesamplemedian.Themedianof
anexponentialdistributionisln(2)

,soworkingbackwardsagain,wecan
anestimator
L
m
=ln(2)
=m
where
m
isthesamplemedian.
Totesttheperformanceoftheseestimators,wecansimulatethesampling
process:
defEstimate3(n=7,m=1000):
lam=2
means=[]
medians=[]
for_inrange(m):
xs=np.random.exponential(1.0/lam,n)
L=1/np.mean(xs)
Lm=math.log(2)/thinkstats2.Median(xs)
means.append(L)
medians.append(Lm)
RMSE(means,lam))
RMSE(medians,lam))
errorMeanError(means,lam))
errorMeanError(medians,lam))
WhenIrunthisexperimentwith

=2,theRMSEof
L
is1.1.Forthe
median-basedestimator
L
m
,RMSEis1.8.Wecan'ttellfromthisexperiment
whether
L
minimizesMSE,butatleastitseemsbetterthan
L
m
.
Sadly,itseemsthatbothestimatorsarebiased.For
L
themeanerroris0.33;
for
L
m
itis0.45.Andneitherconvergesto0as
m
increases.
8.6.Exercises115
Itturnsoutthat
x
isanunbiasedestimatorofthemeanofthedistribution,
1

,but
L
isnotanunbiasedestimatorof

.
8.6Exercises
Forthefollowingexercises,youmightwanttostartwithacopyof
estimation.py
.Solutionsarein
chap08soln.py
Exercise8.1
Inthischapterweused
x
andmediantoestimate

,andfound
that
x
yieldslowerMSE.Also,weused
S
2
and
S
2
n

1
toestimate
˙
,andfound
that
S
2
isbiasedand
S
2
n

1
unbiased.
Runsimilarexperimentstoseeif
x
andmedianarebiasedestimatesof

.
Alsocheckwhether
S
2
or
S
2
n

1
yieldsalowerMSE.
Exercise8.2
Supposeyoudrawasamplewithsize
n
=10fromanexponen-
tialdistributionwith

=2.Simulatethisexperiment1000timesandplot
thesamplingdistributionoftheestimate
L
.Computethestandarderrorof
theestimateandthe90%coninterval.
Repeattheexperimentwithafewtvaluesof
n
andmakeaplotof
standarderrorversus
n
.
Exercise8.3
Ingameslikehockeyandsoccer,thetimebetweengoalsis
roughlyexponential.Soyoucouldestimateateam'sgoal-scoringrateby
observingthenumberofgoalstheyscoreinagame.Thisestimationprocess
isalittlerentfromsamplingthetimebetweengoals,solet'sseehowit
works.
Writeafunctionthattakesagoal-scoringrate,
lam
,ingoalspergame,and
simulatesagamebygeneratingthetimebetweengoalsuntilthetotaltime
exceeds1game,thenreturnsthenumberofgoalsscored.
Writeanotherfunctionthatsimulatesmanygames,storestheestimatesof
lam
,thencomputestheirmeanerrorandRMSE.
Isthiswayofmakinganestimatebiased?Plotthesamplingdistributionof
theestimatesandthe90%ceinterval.Whatisthestandarderror?
Whathappenstosamplingerrorforincreasingvaluesof
lam
?
116Chapter8.Estimation
8.7Glossary

estimation
:Theprocessofinferringtheparametersofadistribution
fromasample.

estimator
:Astatisticusedtoestimateaparameter.

meansquarederror(MSE)
:Ameasureofestimationerror.

rootmeansquarederror(RMSE)
:ThesquarerootofMSE,a
moremeaningfulrepresentationoftypicalerrormagnitude.

maximumlikelihoodestimator(MLE)
:Anestimatorthatcom-
putesthepointestimatemostlikelytobecorrect.

bias(ofanestimator)
:Thetendencyofanestimatortobeaboveor
belowtheactualvalueoftheparameter,whenaveragedoverrepeated
experiments.

samplingerror
:Errorinanestimateduetothelimitedsizeofthe
sampleandvariationduetochance.

samplingbias
:Errorinanestimateduetoasamplingprocessthat
isnotrepresentativeofthepopulation.

measurementerror
:Errorinanestimateduetoinaccuracycollect-
ingorrecordingdata.

samplingdistribution
:Thedistributionofastatisticifanexperi-
mentisrepeatedmanytimes.

standarderror
:TheRMSEofanestimate,whichquanvariabil-
ityduetosamplingerror(butnotothersourcesoferror).

interval
:Anintervalthatrepresentstheexpectedrange
ofanestimatorifanexperimentisrepeatedmanytimes.
Chapter9
Hypothesistesting
Thecodeforthischapterisin
hypothesis.py
.Forinformationaboutdown-
loadingandworkingwiththiscode,seeSection0.2.
9.1Classicalhypothesistesting
ExploringthedatafromtheNSFG,wesawseveral\apparentin-
cludingbetweenbabiesandothers.Sofarwehavetaken
theseatfacevalue;inthischapter,weputthemtothetest.
Thefundamentalquestionwewanttoaddressiswhetherthewesee
inasamplearelikelytoappearinthelargerpopulation.Forexample,inthe
NSFGsampleweseeainmeanpregnancylengthforbabies
andothers.Wewouldliketoknowifthattsarealencefor
womenintheU.S.,orifitmightappearinthesamplebychance.
Thereareseveralwayswecouldformulatethisquestion,includingFisher
nullhypothesistesting,Neyman-Pearsondecisiontheory,andBayesianin-
ference
1
.WhatIpresenthereisasubsetofallthreethatmakesupmostof
whatpeopleuseinpractice,whichIwillcall
classicalhypothesistesting
.
1
FormoreaboutBayesianinference,seethesequeltothisbook,
ThinkBayes
.
118Chapter9.Hypothesistesting
Thegoalofclassicalhypothesistestingistoanswerthequestion,\Givena
sampleandanapparentwhatistheprobabilityofseeingsuchan
bychance?"Here'showweanswerthatquestion:

Thestepistoquantifythesizeoftheapparentbychoosinga
teststatistic
.IntheNSFGexample,theapparentisa
inpregnancylengthbetweenbabiesandothers,soanaturalchoice
fortheteststatisticistheinmeansbetweenthetwogroups.

Thesecondstepistoa
nullhypothesis
,whichisamodelofthe
systembasedontheassumptionthattheapparentisnotreal.
IntheNSFGexamplethenullhypothesisisthatthereisno
betweenbabiesandothers;thatis,thatpregnancylengthsfor
bothgroupshavethesamedistribution.

Thethirdstepistocomputea
p-value
,whichistheprobabilityof
seeingtheapparentifthenullhypothesisistrue.IntheNSFG
example,wewouldcomputetheactualinmeans,thencom-
putetheprobabilityofseeingaasbig,orbigger,underthe
nullhypothesis.

Thelaststepistointerprettheresult.Ifthep-valueislow,the
issaidtobe
statisticallyt
,whichmeansthatitisunlikely
tohaveoccurredbychance.Inthatcaseweinferthattheis
morelikelytoappearinthelargerpopulation.
Thelogicofthisprocessissimilartoaproofbycontradiction.Toprovea
mathematicalstatement,A,youassumetemporarilythatAisfalse.Ifthat
assumptionleadstoacontradiction,youconcludethatAmustactuallybe
true.
Similarly,totestahypothesislike,\Thisisreal,"weassume,temporar-
ily,thatitisnot.That'sthenullhypothesis.Basedonthatassumption,we
computetheprobabilityoftheapparentThat'sthep-value.Ifthe
p-valueislow,weconcludethatthenullhypothesisisunlikelytobetrue.
9.2.HypothesisTest119
9.2HypothesisTest
thinkstats2
provides
HypothesisTest
,aclassthatrepresentsthestructure
ofaclassicalhypothesistest.Hereisthe
classHypothesisTest(object):
def__init__(self,data):
self.data=data
self.MakeModel()
self.actual=self.TestStatistic(data)
defPValue(self,iters=1000):
self.test_stats=[self.TestStatistic(self.RunModel())
for_inrange(iters)]
count=sum(1forxinself.test_statsifx>=self.actual)
returncount/iters
defTestStatistic(self,data):
raiseUnimplementedMethodException()
defMakeModel(self):
pass
defRunModel(self):
raiseUnimplementedMethodException()
HypothesisTest
isanabstractparentclassthatprovidescomplete
tionsforsomemethodsandplace-keepersforothers.Childclassesbasedon
HypothesisTest
inherit
__init__
and
PValue
andprovide
TestStatistic
,
RunModel
,andoptionally
MakeModel
.
__init__
takesthedatainwhateverformisappropriate.Itcalls
MakeModel
,
whichbuildsarepresentationofthenullhypothesis,thenpassesthedatato
TestStatistic
,whichcomputesthesizeoftheinthesample.
PValue
computestheprobabilityoftheapparentunderthenullhy-
pothesis.Ittakesasaparameter
iters
,whichisthenumberofsimulations
torun.Thelinegeneratessimulateddata,computesteststatistics,
120Chapter9.Hypothesistesting
andstoresthemin
test_stats
.Theresultisthefractionofelementsin
test_stats
thatexceedorequaltheobservedteststatistic,
self.actual
.
Asasimpleexample
2
,supposewetossacoin250timesandsee140heads
and110tails.Basedonthisresult,wemightsuspectthatthecoinisbiased;
thatis,morelikelytolandheads.Totestthishypothesis,wecomputethe
probabilityofseeingsuchaifthecoinisactuallyfair:
classCoinTest(thinkstats2.HypothesisTest):
defTestStatistic(self,data):
heads,tails=data
test_stat=abs(heads-tails)
returntest_stat
defRunModel(self):
heads,tails=self.data
n=heads+tails
sample=for_inrange(n)]
hist=thinkstats2.Hist(sample)
data=
returndata
Theparameter,
data
,isapairofintegers:thenumberofheadsandtails.
Theteststatisticistheabsolutebetweenthem,so
self.actual
is30.
RunModel
simulatescointossesassumingthatthecoinisactuallyfair.It
generatesasampleof250tosses,usesHisttocountthenumberofheadsand
tails,andreturnsapairofintegers.
Nowallwehavetodoisinstantiate
CoinTest
andcall
PValue
:
ct=CoinTest((140,110))
pvalue=ct.PValue()
Theresultisabout0.07,whichmeansthatifthecoinisfair,weexpectto
seeaasbigas30about7%ofthetime.
2
AdaptedfromMacKay,
InformationTheory,Inference,andLearningAlgorithms
,
2003.
9.3.Testingainmeans121
Howshouldweinterpretthisresult?Byconvention,5%isthethresholdof
statisticalIfthep-valueislessthan5%,theisconsidered
t;otherwiseitisnot.
Butthechoiceof5%isarbitrary,and(aswewillseelater)thep-valuede-
pendsonthechoiceoftheteststatisticsandthemodelofthenullhypothesis.
Sop-valuesshouldnotbeconsideredprecisemeasurements.
Irecommendinterpretingp-valuesaccordingtotheirorderofmagnitude:if
thep-valueislessthan1%,theisunlikelytobeduetochance;ifitis
greaterthan10%,thecanplausiblybeexplainedbychance.P-values
between1%and10%shouldbeconsideredborderline.SointhisexampleI
concludethatthedatadonotprovidestrongevidencethatthecoinisbiased
ornot.
9.3Testingainmeans
Oneofthemostcommonstotestisainmeanbetweentwo
groups.IntheNSFGdata,wesawthatthemeanpregnancylengthfor
babiesisslightlylonger,andthemeanbirthweightisslightlysmaller.Now
wewillseeifthoseectsarestatisticallyt.
Fortheseexamples,thenullhypothesisisthatthedistributionsforthetwo
groupsarethesame.Onewaytomodelthenullhypothesisisby
permuta-
tion
;thatis,wecantakevaluesforbabiesandothersandshthem,
treatingthetwogroupsasonebiggroup:
classDiffMeansPermute(thinkstats2.HypothesisTest):
defTestStatistic(self,data):
group1,group2=data
test_stat=abs(group1.mean()-group2.mean())
returntest_stat
defMakeModel(self):
group1,group2=self.data
self.n,self.m=len(group1),len(group2)
self.pool=np.hstack((group1,group2))
122Chapter9.Hypothesistesting
defRunModel(self):
np.random.shuffle(self.pool)
data=self.pool[:self.n],self.pool[self.n:]
returndata
data
isapairofsequences,oneforeachgroup.Theteststatisticisthe
absoluteinthemeans.
MakeModel
recordsthesizesofthegroups,
n
and
m
,andcombinesthegroups
intooneNumPyarray,
self.pool
.
RunModel
simulatesthenullhypothesisbyshthepooledvaluesand
splittingthemintotwogroupswithsizes
n
and
m
.Asalways,thereturn
valuefrom
RunModel
hasthesameformatastheobserveddata.
Totesttheinpregnancylength,werun:
live,firsts,others=first.MakeFrames()
data=firsts.prglngth.values,others.prglngth.values
ht=DiffMeansPermute(data)
pvalue=ht.PValue()
MakeFrames
readstheNSFGdataandreturnsDataFramesrepresentingall
livebirths,babies,andothers.WeextractpregnancylengthsasNumPy
arrays,passthemasdatato
DiffMeansPermute
,andcomputethep-value.
Theresultisabout0.17,whichmeansthatweexpecttoseea
asbigastheobservedabout17%ofthetime.Sothisisnot
statisticallyt.
HypothesisTest
provides
PlotCdf
,whichplotsthedistributionofthetest
statisticandagraylineindicatingtheobservedsize:
ht.PlotCdf()


Figure9.1showstheresult.TheCDFintersectstheobservedat
0.83,whichisthecomplementofthep-value,0.17.
Ifwerunthesameanalysiswithbirthweight,thecomputedp-valueis0;after
1000attempts,thesimulationneveryieldsanasbigastheobserved
0.12lbs.Sowewouldreport
p<
0
:
001,andconcludethatthe
inbirthweightisstatisticallyt.
9.4.Otherteststatistics123
Figure9.1:CDFofinmeanpregnancylengthunderthenullhy-
pothesis.
9.4Otherteststatistics
Choosingthebestteststatisticdependsonwhatquestionyouaretryingto
address.Forexample,iftherelevantquestioniswhetherpregnancylengths
aretforbabies,thenitmakessensetotesttheabsolute
inmeans,aswedidintheprevioussection.
Ifwehadsomereasontothinkthatbabiesarelikelytobelate,then
wewouldnottaketheabsolutevalueoftheinsteadwewoulduse
thisteststatistic:
classDiffMeansOneSided(DiffMeansPermute):
defTestStatistic(self,data):
group1,group2=data
test_stat=group1.mean()-group2.mean()
returntest_stat
DiffMeansOneSided
inherits
MakeModel
and
RunModel
from
DiffMeansPermute
;theonlyisthat
TestStatistic
does
nottaketheabsolutevalueoftheThiskindoftestiscalled
one-sided
becauseitonlycountsonesideofthedistributionofnces.
Theprevioustest,usingbothsides,is
two-sided
.
124Chapter9.Hypothesistesting
Forthisversionofthetest,thep-valueis0.09.Ingeneralthep-valuefor
aone-sidedtestisabouthalfthep-valueforatwo-sidedtest,dependingon
theshapeofthedistribution.
Theone-sidedhypothesis,thatbabiesarebornlate,ismoresp
thanthetwo-sidedhypothesis,sothep-valueissmaller.Butevenforthe
strongerhypothesis,theisnotstatisticallyt.
Wecanusethesameframeworktotestforainstandarddeviation.
InSection3.3,wesawsomeevidencethatbabiesaremorelikelytobe
earlyorlate,andlesslikelytobeontime.Sowemighthypothesizethatthe
standarddeviationishigher.Here'showwecantestthat:
classDiffStdPermute(DiffMeansPermute):
defTestStatistic(self,data):
group1,group2=data
test_stat=group1.std()-group2.std()
returntest_stat
Thisisaone-sidedtestbecausethehypothesisisthatthestandarddeviation
forbabiesishigher,notjustt.Thep-valueis0.09,whichisnot
statisticallyt.
9.5Testingacorrelation
Thisframeworkcanalsotestcorrelations.Forexample,intheNSFGdata
set,thecorrelationbetweenbirthweightandmother'sageisabout0.07.It
seemslikeoldermothershaveheavierbabies.Butcouldthisbedueto
chance?
Fortheteststatistic,IusePearson'scorrelation,butSpearman'swouldwork
aswell.Ifwehadreasontoexpectpositivecorrelation,wewoulddoaone-
sidedtest.Butsincewehavenosuchreason,I'lldoatwo-sidedtestusing
theabsolutevalueofcorrelation.
Thenullhypothesisisthatthereisnocorrelationbetweenmother'sageand
birthweight.Byshtheobservedvalues,wecansimulateaworld
wherethedistributionsofageandbirthweightarethesame,butwherethe
variablesareunrelated:
9.6.Testingproportions125
classCorrelationPermute(thinkstats2.HypothesisTest):
defTestStatistic(self,data):
xs,ys=data
test_stat=abs(thinkstats2.Corr(xs,ys))
returntest_stat
defRunModel(self):
xs,ys=self.data
xs=np.random.permutation(xs)
returnxs,ys
data
isapairofsequences.
TestStatistic
computestheabsolutevalueof
Pearson'scorrelation.
RunModel
shthe
xs
andreturnssimulateddata.
Here'sthecodethatreadsthedataandrunsthetest:
live,firsts,others=first.MakeFrames()
live=
data=live.agepreg.values,live.totalwgt_lb.values
ht=CorrelationPermute(data)
pvalue=ht.PValue()
Iuse
dropna
withthe
subset
argumenttodroprowsthataremissingeither
ofthevariablesweneed.
Theactualcorrelationis0.07.Thecomputedp-valueis0;after1000iter-
ationsthelargestsimulatedcorrelationis0.04.Soalthoughtheobserved
correlationissmall,itisstatisticallyt.
Thisexampleisareminderthat\statisticallyt"doesnotalways
meanthatanisimportant,ortinpractice.Itonlymeans
thatitisunlikelytohaveoccurredbychance.
9.6Testingproportions
Supposeyourunacasinoandyoususpectthatacustomerisusingacrooked
die;thatis,onethathasbeenmodtomakeoneofthefacesmorelikely
126Chapter9.Hypothesistesting
thantheothers.Youapprehendtheallegedcheaterandthedie,
butnowyouhavetoprovethatitiscrooked.Yourollthedie60timesand
getthefollowingresults:
Value
1
2
3
4
5
6
Frequency
8
9
19
5
8
11
Onaverageyouexpecteachvaluetoappear10times.Inthisdataset,the
value3appearsmoreoftenthanexpected,andthevalue4appearslessoften.
Butarethesestatisticallyt?
Totestthishypothesis,wecancomputetheexpectedfrequencyforeach
value,thebetweentheexpectedandobservedfrequencies,andthe
totalabsoluteInthisexample,weexpecteachsidetocomeup
10timesoutof60;thedeviationsfromthisexpectationare-2,-1,9,-5,-2,
and1;sothetotalabsoluteis20.Howoftenwouldweseesucha
bychance?
Here'saversionof
HypothesisTest
thatanswersthatquestion:
classDiceTest(thinkstats2.HypothesisTest):
defTestStatistic(self,data):
observed=data
n=sum(observed)
expected=np.ones(6)*n/6
test_stat=sum(abs(observed-expected))
returntest_stat
defRunModel(self):
n=sum(self.data)
values=[1,2,3,4,5,6]
rolls=np.random.choice(values,n,replace=True)
hist=thinkstats2.Hist(rolls)
freqs=hist.Freqs(values)
returnfreqs
Thedataarerepresentedasalistoffrequencies:theobservedvaluesare
[8,9,19,5,8,11]
;theexpectedfrequenciesareall10.Theteststatis-
ticisthesumoftheabsolute
9.7.Chi-squaredtests127
Thenullhypothesisisthatthedieisfair,sowesimulatethatbydrawing
randomsamplesfrom
values
.
RunModel
uses
Hist
tocomputeandreturn
thelistoffrequencies.
Thep-valueforthisdatais0.13,whichmeansthatifthedieisfairweexpect
toseetheobservedtotaldeviation,ormore,about13%ofthetime.Sothe
apparentisnotstatisticallyt.
9.7Chi-squaredtests
Intheprevioussectionweusedtotaldeviationastheteststatistic.Butfor
testingproportionsitismorecommontousethechi-squaredstatistic:
˜
2
=
X
i
(
O
i

E
i
)
2
E
i
Where
O
i
aretheobservedfrequenciesand
E
i
aretheexpectedfrequencies.
Here'sthePythoncode:
classDiceChiTest(DiceTest):
defTestStatistic(self,data):
observed=data
n=sum(observed)
expected=np.ones(6)*n/6
test_stat=sum((observed-expected)**2/expected)
returntest_stat
Squaringthedeviations(ratherthantakingabsolutevalues)givesmore
weighttolargedeviations.Dividingthroughby
expected
standardizesthe
deviations,althoughinthiscaseithasnobecausetheexpectedfre-
quenciesareallequal.
Thep-valueusingthechi-squaredstatisticis0.04,substantiallysmallerthan
whatwegotusingtotaldeviation,0.13.Ifwetakethe5%thresholdseriously,
wewouldconsiderthisstatisticallyt.Butconsideringthetwo
teststogther,Iwouldsaythattheresultsareborderline.Iwouldnotruleout
thepossibilitythatthedieiscrooked,butIwouldnotconvicttheaccused
cheater.
128Chapter9.Hypothesistesting
Thisexampledemonstratesanimportantpoint:thep-valuedependsonthe
choiceofteststatisticandthemodelofthenullhypothesis,andsometimes
thesechoicesdeterminewhetheranisstatisticallytornot.
9.8Firstbabiesagain
Earlierinthischapterwelookedatpregnancylengthsforbabiesand
others,andconcludedthattheapparentinmeanandstandard
deviationarenotstatisticallyt.ButinSection3.3,wesawseveral
apparentinthedistributionofpregnancylength,especiallyinthe
rangefrom35to43weeks.Toseewhetherthosearestatistically
t,wecanuseatestbasedonachi-squaredstatistic.
Thecodecombineselementsfrompreviousexamples:
classPregLengthTest(thinkstats2.HypothesisTest):
defMakeModel(self):
firsts,others=self.data
self.n=len(firsts)
self.pool=np.hstack((firsts,others))
pmf=thinkstats2.Pmf(self.pool)
self.values=range(35,44)
self.expected_probs=np.array(pmf.Probs(self.values))
defRunModel(self):
np.random.shuffle(self.pool)
data=self.pool[:self.n],self.pool[self.n:]
returndata
Thedataarerepresentedastwolistsofpregnancylengths.Thenullhypoth-
esisisthatbothsamplesaredrawnfromthesamedistribution.
MakeModel
modelsthatdistributionbypoolingthetwosamplesusing
hstack
.Then
RunModel
generatessimulateddatabyshthepooledsampleandsplit-
tingitintotwoparts.
MakeModel
also
values
,whichistherangeofweekswe'lluse,and
9.8.Firstbabiesagain129
expected_probs
,whichistheprobabilityofeachvalueinthepooleddistri-
bution.
Here'sthecodethatcomputestheteststatistic:
#classPregLengthTest:
defTestStatistic(self,data):
firsts,others=data
stat=self.ChiSquared(firsts)+self.ChiSquared(others)
returnstat
defChiSquared(self,lengths):
hist=thinkstats2.Hist(lengths)
observed=np.array(hist.Freqs(self.values))
expected=self.expected_probs*len(lengths)
stat=sum((observed-expected)**2/expected)
returnstat
TestStatistic
computesthechi-squaredstatisticforbabiesandothers,
andaddsthem.
ChiSquared
takesasequenceofpregnancylengths,computesitshistogram,
andcomputes
observed
,whichisalistoffrequenciescorrespondingto
self.values
.Tocomputethelistofexpectedfrequencies,itmultipliesthe
pre-computedprobabilities,
expected_probs
,bythesamplesize.Itreturns
thechi-squaredstatistic,
stat
.
FortheNSFGdatathetotalchi-squaredstatisticis102,whichdoesn'tmean
muchbyitself.Butafter1000iterations,thelargestteststatisticgenerated
underthenullhypothesisis32.Weconcludethattheobservedchi-squared
statisticisunlikelyunderthenullhypothesis,sotheapparentissta-
tisticallyt.
Thisexampledemonstratesalimitationofchi-squaredtests:theyindicate
thatthereisabetweenthetwogroups,buttheydon'tsayanything
spaboutwhattheenceis.
130Chapter9.Hypothesistesting
9.9Errors
Inclassicalhypothesistesting,anisconsideredstatisticallyt
ifthep-valueisbelowsomethreshold,commonly5%.Thisprocedureraises
twoquestions:

Iftheisactuallyduetochance,whatistheprobabilitythat
wewillwronglyconsideritt?Thisprobabilityisthe
false
positiverate
.

Iftheisreal,whatisthechancethatthehypothesistestwillfail?
Thisprobabilityisthe
falsenegativerate
.
Thefalsepositiverateisrelativelyeasytocompute:ifthethresholdis5%,
thefalsepositiverateis5%.Here'swhy:

Ifthereisnorealthenullhypothesisistrue,sowecancompute
thedistributionoftheteststatisticbysimulatingthenullhypothesis.
CallthisdistributionCDF
T
.

Eachtimewerunanexperiment,wegetateststatistic,
t
,whichis
drawnfrom
CDF
T
.Thenwecomputeap-value,whichistheprobabil-
itythatarandomvaluefrom
CDF
T
exceeds
t
,sothat's1

CDF
T
(
t
).

Thep-valueislessthan5%if
CDF
T
(
t
)isgreaterthan95%;thatis,if
t
exceedsthe95thpercentile.Andhowoftendoesavaluechosenfrom
CDF
T
exceedthe95thpercentile?5%ofthetime.
Soifyouperformonehypothesistestwitha5%threshold,youexpectafalse
positive1timein20.
9.10Power
Thefalsenegativerateishardertocomputebecauseitdependsontheactual
size,andnormallywedon'tknowthat.Oneoptionistocomputea
rateconditionedonahypotheticalsize.
Forexample,ifweassumethattheobserveddbetweengroupsis
accurate,wecanusetheobservedsamplesasamodelofthepopulationand
runhypothesistestswithsimulateddata:
9.10.Power131
defFalseNegRate(data,num_runs=100):
group1,group2=data
count=0
foriinrange(num_runs):
sample1=thinkstats2.Resample(group1)
sample2=thinkstats2.Resample(group2)
ht=DiffMeansPermute((sample1,sample2))
pvalue=ht.PValue(iters=101)
ifpvalue>0.05:
count+=1
returncount/num_runs
FalseNegRate
takesdataintheformoftwosequences,oneforeachgroup.
Eachtimethroughtheloop,itsimulatesanexperimentbydrawingarandom
samplefromeachgroupandrunningahypothesistest.Thenitchecksthe
resultandcountsthenumberoffalsenegatives.
Resample
takesasequenceanddrawsasamplewiththesamelength,with
replacement:
defResample(xs):
returnnp.random.choice(xs,len(xs),replace=True)
Here'sthecodethattestspregnancylengths:
live,firsts,others=first.MakeFrames()
data=firsts.prglngth.values,others.prglngth.values
neg_rate=FalseNegRate(data)
Theresultisabout70%,whichmeansthatiftheactualenceinmean
pregnancylengthis0.078weeks,weexpectanexperimentwiththissample
sizetoyieldanegativetest70%ofthetime.
Thisresultisoftenpresentedtheotherwayaround:iftheactual
is0.078weeks,weshouldexpectapositivetestonly30%ofthetime.This
\correctpositiverate"iscalledthe
power
ofthetest,orsometimes\sensi-
tivity".Ittheabilityofthetesttodetectanofagivensize.
132Chapter9.Hypothesistesting
Inthisexample,thetesthadonlya30%chanceofyieldingapositiveresult
(again,assumingthattheis0.078weeks).Asaruleofthumb,a
powerof80%isconsideredacceptable,sowewouldsaythatthistestwas
\underpowered."
Ingeneralanegativehypothesistestdoesnotimplythatthereisno
betweenthegroups;insteaditsuggeststhatifthereisa,itistoo
smalltodetectwiththissamplesize.
9.11Replication
ThehypothesistestingprocessIdemonstratedinthischapterisnot,strictly
speaking,goodpractice.
First,Iperformedmultipletests.Ifyourunonehypothesistest,thechance
ofafalsepositiveisabout1in20,whichmightbeacceptable.Butifyou
run20tests,youshouldexpectatleastonefalsepositive,mostofthetime.
Second,Iusedthesamedatasetforexplorationandtesting.Ifyouexplorea
largedataset,asurprisingandthentestwhetheritist,
youhaveagoodchanceofgeneratingafalsepositive.
Tocompensateformultipletests,youcanadjustthep-valuethreshold(see
https://en.wikipedia.org/wiki/Holm-Bonferroni_method
).Oryoucan
addressbothproblemsbypartitioningthedata,usingonesetforexploration
andtheotherfortesting.
Insomethesepracticesarerequiredoratleastencouraged.Butitis
alsocommontoaddresstheseproblemsimplicitlybyreplicatingpublished
results.Typicallythepapertoreportanewresultisconsideredex-
ploratory.Subsequentpapersthatreplicatetheresultwithnewdataare
considered.
Asithappens,wehaveanopportunitytoreplicatetheresultsinthischapter.
TheeditionofthisbookisbasedonCycle6oftheNSFG,whichwas
releasedin2002.InOctober2011,theCDCreleasedadditionaldatabased
oninterviewsconductedfrom2006{2010.
nsfg2.py
containscodetoread
andcleanthisdata.Inthenewdataset:
9.12.Exercises133

Theinmeanpregnancylengthis0.16weeksandstatistically
twith
p<
0
:
001(comparedto0.078weeksintheoriginal
dataset).

Theerenceinbirthweightis0.17poundswith
p<
0
:
001(compared
to0.12lbsintheoriginaldataset).

Thecorrelationbetweenbirthweightandmother'sageis0.08with
p<
0
:
001(comparedto0.07).

Thechi-squaredtestisstatisticallytwith
p<
0
:
001(asitwas
intheoriginal).
Insummary,allofthethatwerestatisticallysignitintheoriginal
datasetwerereplicatedinthenewdataset,andtheinpregnancy
length,whichwasnottintheoriginal,isbiggerinthenewdataset
andt.
9.12Exercises
Asolutiontotheseexercisesisin
chap09soln.py
.
Exercise9.1
Assamplesizeincreases,thepowerofahypothesistestin-
creases,whichmeansitismorelikelytobepositiveiftheisreal.
Conversely,assamplesizedecreases,thetestislesslikelytobepositiveeven
iftheisreal.
Toinvestigatethisbehavior,runthetestsinthischapterwithtsub-
setsoftheNSFGdata.Youcanuse
thinkstats2.SampleRows
toselecta
randomsubsetoftherowsinaDataFrame.
Whathappenstothep-valuesofthesetestsassamplesizedecreases?What
isthesmallestsamplesizethatyieldsapositivetest?
Exercise9.2
InSection9.3,wesimulatedthenullhypothesisbypermuta-
tion;thatis,wetreatedtheobservedvaluesasiftheyrepresentedtheentire
population,andrandomlyassignedthemembersofthepopulationtothe
twogroups.
134Chapter9.Hypothesistesting
Analternativeistousethesampletoestimatethedistributionforthepop-
ulation,thendrawarandomsamplefromthatdistribution.Thisprocessis
called
resampling
.Thereareseveralwaystoimplementresampling,but
oneofthesimplestistodrawasamplewithreplacementfromtheobserved
values,asinSection9.10.
Writeaclassnamed
DiffMeansResample
thatinheritsfrom
DiffMeansPermute
andoverrides
RunModel
toimplementresampling,
ratherthanpermutation.
Usethismodeltotesttheinpregnancylengthandbirthweight.
Howmuchdoesthemodeltheresults?
9.13Glossary

hypothesistesting
:Theprocessofdeterminingwhetheranapparent
isstatisticallyt.

teststatistic
:Astatisticusedtoquantifyansize.

nullhypothesis
:Amodelofasystembasedontheassumptionthat
anapparentisduetochance.

p-value
:Theprobabilitythatancouldoccurbychance.

statisticallyt
:Anisstatisticallytifitis
unlikelytooccurbychance.

permutationtest
:Awaytocomputep-valuesbygeneratingpermu-
tationsofanobserveddataset.

resamplingtest
:Awaytocomputep-valuesbygeneratingsamples,
withreplacement,fromanobserveddataset.

two-sidedtest
:Atestthatasks,\Whatisthechanceofanas
bigastheobservedpositiveornegative?"

one-sidedtest
:Atestthatasks,\Whatisthechanceofanas
bigastheobservedandwiththesamesign?"
9.13.Glossary135

chi-squaredtest
:Atestthatusesthechi-squaredstatisticasthetest
statistic.

falsepositive
:Theconclusionthatanisrealwhenitisnot.

falsenegative
:Theconclusionthatanisduetochancewhen
itisnot.

power
:Theprobabilityofapositivetestifthenullhypothesisisfalse.
136Chapter9.Hypothesistesting
Chapter10
Linearleastsquares
Thecodeforthischapterisin
linear.py
.Forinformationaboutdownload-
ingandworkingwiththiscode,seeSection0.2.
10.1Leastsquares
Correlationcotsmeasurethestrengthandsignofarelationship,but
nottheslope.Thereareseveralwaystoestimatetheslope;themostcommon
isa
linearleastsquares
.A\linearisalineintendedtomodelthe
relationshipbetweenvariables.A\leastsquares"isonethatminimizes
themeansquarederror(MSE)betweenthelineandthedata.
Supposewehaveasequenceofpoints,
ys
,thatwewanttoexpressasa
functionofanothersequence
xs
.Ifthereisalinearrelationshipbetween
xs
and
ys
withintercept
inter
andslope
slope
,weexpecteach
y[i]
tobe
inter+slope*x[i]
.
Butunlessthecorrelationisperfect,thispredictionisonlyapproximate.The
verticaldeviationfromtheline,or
residual
,is
res=ys-(inter+slope*xs)
Theresidualsmightbeduetorandomfactorslikemeasurementerror,ornon-
randomfactorsthatareunknown.Forexample,ifwearetryingtopredict
138Chapter10.Linearleastsquares
weightasafunctionofheight,unknownfactorsmightincludediet,exercise,
andbodytype.
Ifwegettheparameters
inter
and
slope
wrong,theresidualsgetbigger,
soitmakesintuitivesensethattheparameterswewantaretheonesthat
minimizetheresiduals.
Wemighttrytominimizetheabsolutevalueoftheresiduals,ortheirsquares,
ortheircubes;butthemostcommonchoiceistominimizethesumofsquared
residuals,
sum(res**2)
.
Why?Therearethreegoodreasonsandonelessimportantone:

Squaringhasthefeatureoftreatingpositiveandnegativeresidualsthe
same,whichisusuallywhatwewant.

Squaringgivesmoreweighttolargeresiduals,butnotsomuchweight
thatthelargestresidualalwaysdominates.

Iftheresidualsareuncorrelatedandnormallydistributedwithmean0
andconstant(butunknown)variance,thentheleastsquaresisalso
themaximumlikelihoodestimatorof
inter
and
slope
.See
https:
//en.wikipedia.org/wiki/Linear_regression
.

Thevaluesof
inter
and
slope
thatminimizethesquaredresiduals
canbecomputedtly.
Thelastreasonmadesensewhencomputationalwasmoreimpor-
tantthanchoosingthemethodmostappropriatetotheproblemathand.
That'snolongerthecase,soitisworthconsideringwhethersquaredresid-
ualsaretherightthingtominimize.
Forexample,ifyouareusing
xs
topredictvaluesof
ys
,guessingtoohigh
mightbebetter(orworse)thanguessingtoolow.Inthatcaseyoumight
wanttocomputesomecostfunctionforeachresidual,andminimizetotal
cost,
sum(cost(res))
.However,computingaleastsquaresisquick,easy
andoftengoodenough.
10.2.Implementation139
10.2Implementation
thinkstats2
providessimplefunctionsthatdemonstratelinearleastsquares:
defLeastSquares(xs,ys):
meanx,varx=MeanVar(xs)
meany=Mean(ys)
slope=Cov(xs,ys,meanx,meany)/varx
inter=meany-slope*meanx
returninter,slope
LeastSquares
takessequences
xs
and
ys
andreturnstheestimatedparame-
ters
inter
and
slope
.Fordetailsonhowitworks,see
http://wikipedia.
org/wiki/Numerical_methods_for_linear_least_squares
.
thinkstats2
alsoprovides
FitLine
,whichtakes
inter
and
slope
andre-
turnsthelineforasequenceof
xs
.
defFitLine(xs,inter,slope):
fit_xs=np.sort(xs)
fit_ys=inter+slope*fit_xs
returnfit_xs,fit_ys
Wecanusethesefunctionstocomputetheleastsquaresforbirthweight
asafunctionofmother'sage.
live,firsts,others=first.MakeFrames()
live=
ages=live.agepreg
weights=live.totalwgt_lb
inter,slope=thinkstats2.LeastSquares(ages,weights)
fit_xs,fit_ys=thinkstats2.FitLine(ages,inter,slope)
Theestimatedinterceptandslopeare6.8lbsand0.017lbsperyear.These
valuesarehardtointerpretinthisform:theinterceptistheexpectedweight
ofababywhosemotheris0yearsold,whichdoesn'tmakesenseincontext,
andtheslopeistoosmalltograspeasily.
140Chapter10.Linearleastsquares
Figure10.1:Scatterplotofbirthweightandmother'sagewithalinear
Insteadofpresentingtheinterceptat
x
=0,itisoftenhelpfultopresentthe
interceptatthemeanof
x
.Inthiscasethemeanageisabout25yearsand
themeanbabyweightfora25yearoldmotheris7.3pounds.Theslopeis
0.27ouncesperyear,or0.17poundsperdecade.
Figure10.1showsascatterplotofbirthweightandagealongwiththe
line.It'sagoodideatolookatalikethistoassesswhetherthe
relationshipislinearandwhetherthelineseemslikeagoodmodelof
therelationship.
10.3Residuals
Anotherusefultestistoplottheresiduals.
thinkstats2
providesafunction
thatcomputesresiduals:
defResiduals(xs,ys,inter,slope):
xs=np.asarray(xs)
ys=np.asarray(ys)
res=ys-(inter+slope*xs)
returnres
Residuals
takessequences
xs
and
ys
andestimatedparameters
inter
and
slope
.Itreturnsthebetweentheactualvaluesandthe
10.4.Estimation141
Figure10.2:Residualsofthelinear
line.
Tovisualizetheresiduals,Igrouprespondentsbyageandcomputeper-
centilesineachgroup,aswesawinSection7.2.Figure10.2showsthe25th,
50thand75thpercentilesoftheresidualsforeachagegroup.Themedianis
nearzero,asexpected,andtheinterquartilerangeisabout2pounds.Soif
weknowthemother'sage,wecanguessthebaby'sweightwithinapound,
about50%ofthetime.
Ideallytheselinesshouldbet,indicatingthattheresidualsarerandom,
andparallel,indicatingthatthevarianceoftheresidualsisthesameforall
agegroups.Infact,thelinesareclosetoparallel,sothat'sgood;butthey
havesomecurvature,indicatingthattherelationshipisnonlinear.Neverthe-
less,thelinearisasimplemodelthatisprobablygoodenoughforsome
purposes.
10.4Estimation
Theparameters
slope
and
inter
areestimatesbasedonasample;like
otherestimates,theyarevulnerabletosamplingbias,measurementerror,
andsamplingerror.AsdiscussedinChapter8,samplingbiasiscaused
bynon-representativesampling,measurementerroriscausedbyerrorsin
142Chapter10.Linearleastsquares
collectingandrecordingdata,andsamplingerroristheresultofmeasuring
asampleratherthantheentirepopulation.
Toassesssamplingerror,weask,\Ifwerunthisexperimentagain,howmuch
variabilitydoweexpectintheestimates?"Wecananswerthisquestionby
runningsimulatedexperimentsandcomputingsamplingdistributionsofthe
estimates.
Isimulatetheexperimentsbyresamplingthedata;thatis,Itreattheob-
servedpregnanciesasiftheyweretheentirepopulationanddrawsamples,
withreplacement,fromtheobservedsample.
defSamplingDistributions(live,iters=101):
t=[]
for_inrange(iters):
sample=thinkstats2.ResampleRows(live)
ages=sample.agepreg
weights=sample.totalwgt_lb
estimates=thinkstats2.LeastSquares(ages,weights)
t.append(estimates)
inters,slopes=zip(*t)
returninters,slopes
SamplingDistributions
takesaDataFramewithonerowperlivebirth,
and
iters
,thenumberofexperimentstosimulate.Ituses
ResampleRows
toresampletheobservedpregnancies.We'vealreadyseen
SampleRows
,
whichchoosesrandomrowsfromaDataFrame.
thinkstats2
alsoprovides
ResampleRows
,whichreturnsasamplethesamesizeastheoriginal:
defResampleRows(df):
returnSampleRows(df,len(df),replace=True)
Afterresampling,weusethesimulatedsampletoestimateparameters.The
resultistwosequences:theestimatedinterceptsandestimatedslopes.
Isummarizethesamplingdistributionsbyprintingthestandarderrorand
interval:
defSummarize(estimates,actual=None):
mean=thinkstats2.Mean(estimates)
stderr=thinkstats2.Std(estimates,mu=actual)
10.4.Estimation143
cdf=thinkstats2.Cdf(estimates)
ci=cdf.ConfidenceInterval(90)
SE,mean,stderr,ci)
Summarize
takesasequenceofestimatesandtheactualvalue.Itprintsthe
meanoftheestimates,thestandarderroranda90%interval.
Fortheintercept,themeanestimateis6.83,withstandarderror0.07and
90%interval(6.71,6.94).Theestimatedslope,inmorecompact
form,is0.0174,SE0.0028,CI(0.0126,0.0220).Thereisalmostafactorof
twobetweenthelowandhighendsofthisCI,soitshouldbeconsidereda
roughestimate.
Tovisualizethesamplingerroroftheestimate,wecouldplotallofthe
lines,orforalessclutteredrepresentation,plota90%enceintervalfor
eachage.Here'sthecode:
defPlotConfidenceIntervals(xs,inters,slopes,
percent=90,**options):
fys_seq=[]
forinter,slopeinzip(inters,slopes):
fxs,fys=thinkstats2.FitLine(xs,inter,slope)
fys_seq.append(fys)
p=(100-percent)/2
percents=p,100-p
low,high=thinkstats2.PercentileRows(fys_seq,percents)
thinkplot.FillBetween(fxs,low,high,**options)
xs
isthesequenceofmother'sage.
inters
and
slopes
aretheestimated
parametersgeneratedby
SamplingDistributions
.
percent
indicateswhich
intervaltoplot.
PlotConfidenceIntervals
generatesalineforeachpairof
inter
and
slope
andstorestheresultsinasequence,
fys_seq
.Thenituses
PercentileRows
toselecttheupperandlowerpercentilesof
y
foreachvalue
of
x
.Fora90%interval,itselectsthe5thand95thpercentiles.
FillBetween
drawsapolygonthatthespacebetweentwolines.
Figure10.3showsthe50%and90%intervalsforcurvesto
birthweightasafunctionofmother'sage.Theverticalwidthoftheregion
144Chapter10.Linearleastsquares
Figure10.3:50%and90%intervalsshowingvariabilityinthe
lineduetosamplingerrorof
inter
and
slope
.
representstheofsamplingerror;theissmallerforvaluesnear
themeanandlargerfortheextremes.
10.5Goodnessof
Thereareseveralwaystomeasurethequalityofalinearmodel,or
goodness
of
.Oneofthesimplestisthestandarddeviationoftheresiduals.
Ifyouusealinearmodeltomakepredictions,
Std(res)
istherootmean
squarederror(RMSE)ofyourpredictions.Forexample,ifyouusemother's
agetoguessbirthweight,theRMSEofyourguesswouldbe1.40lbs.
Ifyouguessbirthweightwithoutknowingthemother'sage,theRMSEof
yourguessis
Std(ys)
,whichis1.41lbs.Sointhisexample,knowinga
mother'sagedoesnotimprovethepredictionssubstantially.
Anotherwaytomeasuregoodnessofisthe
cotofdetermina-
tion
,usuallydenoted
R
2
andcalled\R-squared":
defCoefDetermination(ys,res):
return1-Var(res)/Var(ys)
10.5.Goodnessof145
Var(res)
istheMSEofyourguessesusingthemodel,
Var(ys)
istheMSE
withoutit.SotheirratioisthefractionofMSEthatremainsifyouusethe
model,and
R
2
isthefractionofMSEthemodeleliminates.
Forbirthweightandmother'sage,
R
2
is0.0047,whichmeansthatmother's
agepredictsabouthalfof1%ofvarianceinbirthweight.
Thereisasimplerelationshipbetweenthecotofdeterminationand
Pearson'scotofcorrelation:
R
2
=
ˆ
2
.Forexample,if
ˆ
is0.8or-0.8,
R
2
=0
:
64.
Although
ˆ
and
R
2
areoftenusedtoquantifythestrengthofarelationship,
theyarenoteasytointerpretintermsofpredictivepower.Inmyopinion,
Std(res)
isthebestrepresentationofthequalityofprediction,especiallyif
itispresentedinrelationto
Std(ys)
.
Forexample,whenpeopletalkaboutthevalidityoftheSAT(astandardized
testusedforcollegeadmissionintheU.S.)theyoftentalkaboutcorrelations
betweenSATscoresandothermeasuresofintelligence.
Accordingtoonestudy,thereisaPearsoncorrelationof
ˆ
=0
:
72between
totalSATscoresandIQscores,whichsoundslikeastrongcorrelation.But
R
2
=
ˆ
2
=0
:
52,soSATscoresaccountforonly52%ofvarianceinIQ.
IQscoresarenormalizedwith
Std(ys)=15
,so
>>>var_ys=15**2
>>>rho=0.72
>>>r2=rho**2
>>>var_res=(1-r2)*var_ys
>>>std_res=math.sqrt(var_res)
10.4096
SousingSATscoretopredictIQreducesRMSEfrom15pointsto10.4
points.Acorrelationof0.72yieldsareductioninRMSEofonly31%.
Ifyouseeacorrelationthatlooksimpressive,rememberthat
R
2
isabetter
indicatorofreductioninMSE,andreductioninRMSEisabetterindicator
ofpredictivepower.
146Chapter10.Linearleastsquares
10.6Testingalinearmodel
Theofmother'sageonbirthweightissmall,andhaslittlepredictive
power.Soisitpossiblethattheapparentrelationshipisduetochance?
Thereareseveralwayswemighttesttheresultsofalinear
OneoptionistotestwhethertheapparentreductioninMSEisduetochance.
Inthatcase,theteststatisticis
R
2
andthenullhypothesisisthatthereis
norelationshipbetweenthevariables.Wecansimulatethenullhypothesis
bypermutation,asinSection9.5,whenwetestedthecorrelationbetween
mother'sageandbirthweight.Infact,because
R
2
=
ˆ
2
,aone-sidedtest
of
R
2
isequivalenttoatwo-sidedtestof
ˆ
.We'vealreadydonethattest,
andfound
p<
0
:
001,soweconcludethattheapparentrelationshipbetween
mother'sageandbirthweightisstatisticallyt.
Anotherapproachistotestwhethertheapparentslopeisduetochance.
Thenullhypothesisisthattheslopeisactuallyzero;inthatcasewecan
modelthebirthweightsasrandomvariationsaroundtheirmean.Here'sa
HypothesisTestforthismodel:
classSlopeTest(thinkstats2.HypothesisTest):
defTestStatistic(self,data):
ages,weights=data
_,slope=thinkstats2.LeastSquares(ages,weights)
returnslope
defMakeModel(self):
_,weights=self.data
self.ybar=weights.mean()
self.res=weights-self.ybar
defRunModel(self):
ages,_=self.data
weights=self.ybar+np.random.permutation(self.res)
returnages,weights
Thedataarerepresentedassequencesofagesandweights.Theteststatistic
istheslopeestimatedby
LeastSquares
.Themodelofthenullhypothesis
isrepresentedbythemeanweightofallbabiesandthedeviationsfromthe
10.6.Testingalinearmodel147
mean.Togeneratesimulateddata,wepermutethedeviationsandaddthem
tothemean.
Here'sthecodethatrunsthehypothesistest:
live,firsts,others=first.MakeFrames()
live=
ht=SlopeTest((live.agepreg,live.totalwgt_lb))
pvalue=ht.PValue()
Thep-valueislessthan0
:
001,soalthoughtheestimatedslopeissmall,itis
unlikelytobeduetochance.
Estimatingthep-valuebysimulatingthenullhypothesisisstrictlycorrect,
butthereisasimpleralternative.Rememberthatwealreadycomputedthe
samplingdistributionoftheslope,inSection10.4.Todothat,weassumed
thattheobservedslopewascorrectandsimulatedexperimentsbyresampling.
Figure10.4showsthesamplingdistributionoftheslope,fromSection10.4,
andthedistributionofslopesgeneratedunderthenullhypothesis.Thesam-
plingdistributioniscenteredabouttheestimatedslope,0.017lbs/year,and
theslopesunderthenullhypothesisarecenteredaround0;butotherthan
that,thedistributionsareidentical.Thedistributionsarealsosymmetric,
forreasonswewillseeinSection14.4.
Sowecouldestimatethep-valuetwoways:

Computetheprobabilitythattheslopeunderthenullhypothesisex-
ceedstheobservedslope.

Computetheprobabilitythattheslopeinthesamplingdistribution
fallsbelow0.(Iftheestimatedslopewerenegative,wewouldcompute
theprobabilitythattheslopeinthesamplingdistributionexceeds0.)
Thesecondoptioniseasierbecausewenormallywanttocomputethesam-
plingdistributionoftheparametersanyway.Anditisagoodapproximation
unlessthesamplesizeissmall
and
thedistributionofresidualsisskewed.
Eventhen,itisusuallygoodenough,becausep-valuesdon'thavetobe
precise.
Here'sthecodethatestimatesthep-valueoftheslopeusingthesampling
distribution:
148Chapter10.Linearleastsquares
Figure10.4:Thesamplingdistributionoftheestimatedslopeandthedistri-
butionofslopesgeneratedunderthenullhypothesis.Theverticallinesare
at0andtheobservedslope,0.017lbs/year.
inters,slopes=SamplingDistributions(live,iters=1001)
slope_cdf=thinkstats2.Cdf(slopes)
pvalue=slope_cdf[0]
Again,we
p<
0
:
001.
10.7Weightedresampling
SofarwehavetreatedtheNSFGdataasifitwerearepresentativesample,
butasImentionedinSection1.2,itisnot.Thesurveydeliberatelyover-
samplesseveralgroupsinordertoimprovethechanceofgettingstatistically
tresults;thatis,inordertoimprovethepoweroftestsinvolving
thesegroups.
Thissurveydesignisusefulformanypurposes,butitmeansthatwecan-
notusethesampletoestimatevaluesforthegeneralpopulationwithout
accountingforthesamplingprocess.
Foreachrespondent,theNSFGdataincludesavariablecalled
finalwgt
,
whichisthenumberofpeopleinthegeneralpopulationtherespondent
represents.Thisvalueiscalleda
samplingweight
,orjust\weight."
10.7.Weightedresampling149
Asanexample,ifyousurvey100,000peopleinacountryof300million,each
respondentrepresents3,000people.Ifyouoversampleonegroupbyafactor
of2,eachpersonintheoversampledgroupwouldhavealowerweight,about
1500.
Tocorrectforoversampling,wecanuseresampling;thatis,wecandraw
samplesfromthesurveyusingprobabilitiesproportionaltosamplingweights.
Then,foranyquantitywewanttoestimate,wecangeneratesamplingdis-
tributions,standarderrors,andintervals.Asanexample,Iwill
estimatemeanbirthweightwithandwithoutsamplingweights.
InSection10.4,wesaw
ResampleRows
,whichchoosesrowsfroma
DataFrame,givingeachrowthesameprobability.Nowweneedto
dothesamethingusingprobabilitiesproportionaltosamplingweights.
ResampleRowsWeighted
takesaDataFrame,resamplesrowsaccordingto
theweightsin
finalwgt
,andreturnsaDataFramecontainingtheresampled
rows:
defResampleRowsWeighted(df,
weights=df[column]
cdf=Cdf(dict(weights))
indices=cdf.Sample(len(weights))
sample=df.loc[indices]
returnsample
weights
isaSeries;convertingittoadictionarymakesamapfromthe
indicestotheweights.In
cdf
thevaluesareindicesandtheprobabilitiesare
proportionaltotheweights.
indices
isasequenceofrowindices;
sample
isaDataFramethatcontains
theselectedrows.Sincewesamplewithreplacement,thesamerowmight
appearmorethanonce.
Nowwecancomparetheofresamplingwithandwithoutweights.
Withoutweights,wegeneratethesamplingdistributionlikethis:
estimates=[ResampleRows(live).totalwgt_lb.mean()
for_inrange(iters)]
Withweights,itlookslikethis:
estimates=[ResampleRowsWeighted(live).totalwgt_lb.mean()
for_inrange(iters)]
150Chapter10.Linearleastsquares
Thefollowingtablesummarizestheresults:
meanbirth
standard
90%CI
weight(lbs)
error
Unweighted
7.27
0.014
(7.24,7.29)
Weighted
7.35
0.014
(7.32,7.37)
Inthisexample,theofweightingissmallbutnon-negligible.The
enceinestimatedmeans,withandwithoutweighting,isabout0.08pounds,
or1.3ounces.Thisissubstantiallylargerthanthestandarderror
oftheestimate,0.014pounds,whichimpliesthattheisnotdueto
chance.
10.8Exercises
Asolutiontothisexerciseisin
chap10soln.ipynb
Exercise10.1
UsingthedatafromtheBRFSS,computethelinearleast
squaresforlog(weight)versusheight.Howwouldyoubestpresentthe
estimatedparametersforamodellikethiswhereoneofthevariablesislog-
transformed?Ifyouweretryingtoguesssomeone'sweight,howmuchwould
ithelptoknowtheirheight?
LiketheNSFG,theBRFSSoversamplessomegroupsandprovidesasampling
weightforeachrespondent.IntheBRFSSdata,thevariablenameforthese
weightsis
finalwt
.Useresampling,withandwithoutweights,toestimate
themeanheightofrespondentsintheBRFSS,thestandarderrorofthe
mean,anda90%cointerval.Howmuchdoescorrectweighting
theestimates?
10.9Glossary

linear
:alineintendedtomodeltherelationshipbetweenvariables.

leastsquares
:Amodelofadatasetthatminimizesthesumof
squaresoftheresiduals.
10.9.Glossary151

residual
:Thedeviationofanactualvaluefromamodel.

goodnessof
:Ameasureofhowwellamodeldata.

cotofdetermination
:Astatisticintendedtoquantifygood-
nessof

samplingweight
:Avalueassociatedwithanobservationinasample
thatindicateswhatpartofthepopulationitrepresents.
152Chapter10.Linearleastsquares
Chapter11
Regression
Thelinearleastsquaresinthepreviouschapterisanexampleof
regres-
sion
,whichisthemoregeneralproblemofanykindofmodeltoany
kindofdata.Thisuseoftheterm\regression"isahistoricalaccident;itis
onlyindirectlyrelatedtotheoriginalmeaningoftheword.
Thegoalofregressionanalysisistodescribetherelationshipbetweenoneset
ofvariables,calledthe
dependentvariables
,andanothersetofvariables,
calledindependentor
explanatoryvariables
.
Inthepreviouschapterweusedmother'sageasanexplanatoryvariableto
predictbirthweightasadependentvariable.Whenthereisonlyonedepen-
dentandoneexplanatoryvariable,that's
simpleregression
.Inthischap-
ter,wemoveonto
multipleregression
,withmorethanoneexplanatory
variable.Ifthereismorethanonedependentvariable,that'smultivariate
regression.
Iftherelationshipbetweenthedependentandexplanatoryvariableislinear,
that's
linearregression
.Forexample,ifthedependentvariableis
y
and
theexplanatoryvariablesare
x
1
and
x
2
,wewouldwritethefollowinglinear
regressionmodel:
y
=

0
+

1
x
1
+

2
x
2
+
"
where

0
istheintercept,

1
istheparameterassociatedwith
x
1
,

2
isthe
parameterassociatedwith
x
2
,and
"
istheresidualduetorandomvariation
orotherunknownfactors.
154Chapter11.Regression
Givenasequenceofvaluesfor
y
andsequencesfor
x
1
and
x
2
,wecan
theparameters,

0
,

1
,and

2
,thatminimizethesumof
"
2
.Thispro-
cessiscalled
ordinaryleastsquares
.Thecomputationissimilarto
thinkstats2.LeastSquare
,butgeneralizedtodealwithmorethanoneex-
planatoryvariable.Youcanthedetailsat
https://en.wikipedia.org/
wiki/Ordinary_least_squares
Thecodeforthischapterisin
regression.py
.Forinformationaboutdown-
loadingandworkingwiththiscode,seeSection0.2.
11.1StatsModels
InthepreviouschapterIpresented
thinkstats2.LeastSquares
,animple-
mentationofsimplelinearregressionintendedtobeeasytoread.Formul-
tipleregressionwe'llswitchtoStatsModels,aPythonpackagethatprovides
severalformsofregressionandotheranalyses.IfyouareusingAnaconda,
youalreadyhaveStatsModels;otherwiseyoumighthavetoinstallit.
Asanexample,I'llrunthemodelfromthepreviouschapterwithStatsMod-
els:
importstatsmodels.formula.apiassmf
live,firsts,others=first.MakeFrames()
formula=~
model=smf.ols(formula,data=live)
results=model.fit()
statsmodels
providestwointerfaces(APIs);the\formula"APIusesstrings
toidentifythedependentandexplanatoryvariables.Itusesasyntaxcalled
patsy
;inthisexample,the
~
operatorseparatesthedependentvariableon
theleftfromtheexplanatoryvariablesontheright.
smf.ols
takestheformulastringandtheDataFrame,
live
,andreturnsan
OLSobjectthatrepresentsthemodel.Thename
ols
standsfor\ordinary
leastsquares."
The
fit
methodthemodeltothedataandreturnsaRegressionResults
objectthatcontainstheresults.
11.1.StatsModels155
Theresultsarealsoavailableasattributes.
params
isaSeriesthatmaps
fromvariablenamestotheirparameters,sowecangettheinterceptand
slopelikethis:
inter=
slope=
Theestimatedparametersare6.83and0.0175,thesameasfrom
LeastSquares
.
pvalues
isaSeriesthatmapsfromvariablenamestotheassociatedp-values,
sowecancheckwhethertheestimatedslopeisstatisticallyt:
slope_pvalue=
Thep-valueassociatedwith
agepreg
is
5.7e-11
,whichislessthan0
:
001,as
expected.
results.rsquared
contains
R
2
,whichis0
:
0047.
results
alsoprovides
f_pvalue
,whichisthep-valueassociatedwiththemodelasawhole,similar
totestingwhether
R
2
isstatisticallyt.
And
results
provides
resid
,asequenceofresiduals,and
fittedvalues
,a
sequenceofvaluescorrespondingto
agepreg
.
Theresultsobjectprovides
summary()
,whichrepresentstheresultsina
readableformat.
print(results.summary())
Butitprintsalotofinformationthatisnotrelevant(yet),soIuseasimpler
functioncalled
SummarizeResults
.Herearetheresultsofthismodel:
Intercept6.83(0)
agepreg0.0175(5.72e-11)
R^20.004738
Std(ys)1.408
Std(res)1.405
Std(ys)
isthestandarddeviationofthedependentvariable,whichisthe
RMSEifyouhavetoguessbirthweightswithoutthebofanyexplana-
toryvariables.
Std(res)
isthestandarddeviationoftheresiduals,which
istheRMSEifyourguessesareinformedbythemother'sage.Aswehave
alreadyseen,knowingthemother'sageprovidesnosubstantialimprovement
tothepredictions.
156Chapter11.Regression
11.2Multipleregression
InSection4.5wesawthatbabiestendtobelighterthanothers,and
thiseisstatisticallyt.Butitisastrangeresultbecausethere
isnoobviousmechanismthatwouldcausebabiestobelighter.Sowe
mightwonderwhetherthisrelationshipis
spurious
.
Infact,thereisapossibleexplanationforthisWehaveseenthat
birthweightdependsonmother'sage,andwemightexpectthatmothersof
babiesareyoungerthanothers.
Withafewcalculationswecancheckwhetherthisexplanationisplausible.
Thenwe'llusemultipleregressiontoinvestigatemorecarefully.First,let's
seehowbigtheinweightis:
diff_weight=firsts.totalwgt_lb.mean()-others.totalwgt_lb.mean()
Firstbabiesare0.125lbslighter,or2ounces.Andtheinages:
diff_age=firsts.agepreg.mean()-others.agepreg.mean()
Themothersofbabiesare3.59yearsyounger.Runningthelinearmodel
again,wegetthechangeinbirthweightasafunctionofage:
results=~data=live).fit()
slope=
Theslopeis0.0175poundsperyear.Ifwemultiplytheslopebythe
inages,wegettheexpectedinbirthweightforbabiesand
others,duetomother'sage:
slope*diff_age
Theresultis0.063,justabouthalfoftheobservedSowecon-
clude,tentatively,thattheobservedinbirthweightcanbepartly
explainedbytheinmother'sage.
Usingmultipleregression,wecanexploretheserelationshipsmoresystemat-
ically.
=live.birthord==1
formula=~
results=smf.ols(formula,data=live).fit()
11.2.Multipleregression157
Thelinecreatesanewcolumnnamed
isfirst
thatisTruefor
babiesandfalseotherwise.Thenweamodelusing
isfirst
asanex-
planatoryvariable.
Herearetheresults:
Intercept7.33(0)
isfirst[T.True]-0.125(2.55e-05)
R^20.00196
Because
isfirst
isaboolean,
ols
treatsitasa
categoricalvariable
,which
meansthatthevaluesfallintocategories,likeTrueandFalse,andshould
notbetreatedasnumbers.Theestimatedparameteristheonbirth
weightwhen
isfirst
istrue,sotheresult,-0.125lbs,isthein
birthweightbetweenbabiesandothers.
Theslopeandtheinterceptarestatisticallyt,whichmeansthat
theywereunlikelytooccurbychance,butthethe
R
2
valueforthismodel
issmall,whichmeansthat
isfirst
doesn'taccountforasubstantialpartof
thevariationinbirthweight.
Theresultsaresimilarwith
agepreg
:
Intercept6.83(0)
agepreg0.0175(5.72e-11)
R^20.004738
Again,theparametersarestatisticallyt,but
R
2
islow.
Thesemodelsresultswehavealreadyseen.Butnowwecan
asinglemodelthatincludesbothvariables.Withtheformula
totalwgt_lb~isfirst+agepreg
,weget:
Intercept6.91(0)
isfirst[T.True]-0.0698(0.0253)
agepreg0.0154(3.93e-08)
R^20.005289
Inthecombinedmodel,theparameterfor
isfirst
issmallerbyabouthalf,
whichmeansthatpartoftheapparentof
isfirst
isactuallyaccounted
forby
agepreg
.Andthep-valuefor
isfirst
isabout2.5%,whichisonthe
borderofstatistical
158Chapter11.Regression
R
2
forthismodelisalittlehigher,whichindicatesthatthetwovariables
togetheraccountformorevariationinbirthweightthaneitheralone(but
notbymuch).
11.3Nonlinearrelationships
Rememberingthatthecontributionof
agepreg
mightbenonlinear,wemight
consideraddingavariabletocapturemoreofthisrelationship.Oneoption
istocreateacolumn,
agepreg2
,thatcontainsthesquaresoftheages:
=live.agepreg**2
formula=~isfirst+agepreg+
Nowbyestimatingparametersfor
agepreg
and
agepreg2
,weareely
aparabola:
Intercept5.69(1.38e-86)
isfirst[T.True]-0.0504(0.109)
agepreg0.112(3.23e-07)
agepreg2-0.00185(8.8e-06)
R^20.007462
Theparameterof
agepreg2
isnegative,sotheparabolacurvesdownward,
whichisconsistentwiththeshapeofthelinesinFigure10.2.
Thequadraticmodelof
agepreg
accountsformoreofthevariabilityinbirth
weight;theparameterfor
isfirst
issmallerinthismodel,andnolonger
statisticallyt.
Usingcomputedvariableslike
agepreg2
isacommonwaytopolynomials
andotherfunctionstodata.Thisprocessisstillconsideredlinearregression,
becausethedependentvariableisalinearfunctionoftheexplanatoryvari-
ables,regardlessofwhethersomevariablesarenonlinearfunctionsofothers.
Thefollowingtablesummarizestheresultsoftheseregressions:

agepreg
agepreg2
R
2
Model1
-0.125*
{
{
0.002
Model2
{
0.0175*
{
0.0047
Model3
-0.0698(0.025)
0.0154*
{
0.0053
Model4
-0.0504(0.11)
0.112*
-0.00185*
0.0075
11.4.Datamining159
Thecolumnsinthistablearetheexplanatoryvariablesandthecoet
ofdetermination,
R
2
.Eachentryisanestimatedparameterandeithera
p-valueinparenthesesoranasterisktoindicateap-valuelessthat0.001.
Weconcludethattheapparentinbirthweightisexplained,at
leastinpart,bytheinmother'sage.Whenweincludemother's
ageinthemodel,theof
isfirst
getssmaller,andtheremainingect
mightbeduetochance.
Inthisexample,mother'sageactsasa
controlvariable
;including
agepreg
inthemodel\controlsfor"theinagebetweenmothers
andothers,makingitpossibletoisolatethe(ifany)of
isfirst
.
11.4Datamining
Sofarwehaveusedregressionmodelsforexplanation;forexample,inthe
previoussectionwediscoveredthatanapparentinbirthweight
isactuallyduetoainmother'sage.Butthe
R
2
valuesofthose
modelsisverylow,whichmeansthattheyhavelittlepredictivepower.In
thissectionwe'lltrytodobetter.
Supposeoneofyourco-workersisexpectingababyandthereisan
pooltoguessthebaby'sbirthweight(ifyouarenotfamiliarwithbetting
pools,see
https://en.wikipedia.org/wiki/Betting_pool
).
Nowsupposethatyou
really
wanttowinthepool.Whatcouldyoudoto
improveyourchances?Well,theNSFGdatasetincludes244variablesabout
eachpregnancyandanother3087variablesabouteachrespondent.Maybe
someofthosevariableshavepredictivepower.Tooutwhichonesare
mostuseful,whynottrythemall?
Testingthevariablesinthepregnancytableiseasy,butinordertousethe
variablesintherespondenttable,wehavetomatchupeachpregnancywith
arespondent.Intheorywecoulditeratethroughtherowsofthepregnancy
table,usethe
caseid
tothecorrespondingrespondent,andcopythe
valuesfromthecorrespondenttableintothepregnancytable.Butthat
wouldbeslow.
160Chapter11.Regression
Abetteroptionistorecognizethisprocessasa
join
operationasin
SQLandotherrelationaldatabaselanguages(see
https://en.wikipedia.
org/wiki/Join_(SQL)
).JoinisimplementedasaDataFramemethod,so
wecanperformtheoperationlikethis:
live=live[live.prglngth>30]
resp=chap01soln.ReadFemResp()
resp.index=resp.caseid
join=live.join(resp,
Thelineselectsrecordsforpregnancieslongerthan30weeks,assuming
thatthepoolisformedseveralweeksbeforetheduedate.
ThenextlinereadstherespondentTheresultisaDataFramewithinte-
gerindices;inordertolookuprespondentstly,Ireplace
resp.index
with
resp.caseid
.
The
join
methodisinvokedon
live
,whichisconsideredthe\left"table,
andpassed
resp
,whichisthe\right"table.Thekeywordargument
on
indicatesthevariableusedtomatchuprowsfromthetwotables.
Inthisexamplesomecolumnnamesappearinbothtables,sowehaveto
provide
rsuffix
,whichisastringthatwillbeappendedtothenamesof
overlappingcolumnsfromtherighttable.Forexample,bothtableshavea
columnnamed
race
thatencodestheraceoftherespondent.Theresultof
thejoincontainstwocolumnsnamed
race
and
race_r
.
Thepandasimplementationisfast.JoiningtheNSFGtablestakeslessthana
secondonanordinarydesktopcomputer.Nowwecanstarttestingvariables.
t=[]
fornameinjoin.columns:
try:
ifjoin[name].var()<1e-7:
continue
formula=~agepreg++name
model=smf.ols(formula,data=join)
ifmodel.nobs<len(join)/2:
continue
11.5.Prediction161
results=model.fit()
except(ValueError,TypeError):
continue
t.append((results.rsquared,name))
Foreachvariableweconstructamodel,compute
R
2
,andappendtheresults
toalist.Themodelsallinclude
agepreg
,sincewealreadyknowthatithas
somepredictivepower.
Icheckthateachexplanatoryvariablehassomevariability;otherwisethere-
sultsoftheregressionareunreliable.Ialsocheckthenumberofobservations
foreachmodel.Variablesthatcontainalargenumberof
nan
sarenotgood
candidatesforprediction.
Formostofthesevariables,wehaven'tdoneanycleaning.Someofthemare
encodedinwaysthatdon'tworkverywellforlinearregression.Asaresult,
wemightoverlooksomevariablesthatwouldbeusefuliftheywerecleaned
properly.Butmaybewewillsomegoodcandidates.
11.5Prediction
Thenextstepistosorttheresultsandselectthevariablesthatyieldthe
highestvaluesof
R
2
.
t.sort(reverse=True)
formse,nameint[:30]:
print(name,mse)
Thevariableonthelistis
totalwgt_lb
,followedby
birthwgt_lb
.Ob-
viously,wecan'tusebirthweighttopredictbirthweight.
Similarly
prglngth
hasusefulpredictivepower,butforthepoolwe
assumepregnancylength(andtherelatedvariables)arenotknownyet.
Theusefulpredictivevariableis
babysex
whichindicateswhetherthe
babyismaleorfemale.IntheNSFGdataset,boysareabout0.3lbsheavier.
So,assumingthatthesexofthebabyisknown,wecanuseitforprediction.
162Chapter11.Regression
Nextis
race
,whichindicateswhethertherespondentiswhite,black,or
other.Asanexplanatoryvariable,racecanbeproblematic.Indatasetslike
theNSFG,raceiscorrelatedwithmanyothervariables,includingincome
andothersocioeconomicfactors.Inaregressionmodel,raceactsasa
proxy
variable
,soapparentcorrelationswithraceareoftencaused,atleastin
part,byotherfactors.
Thenextvariableonthelistis
nbrnaliv
,whichindicateswhetherthepreg-
nancyyieldedmultiplebirths.Twinsandtripletstendtobesmallerthan
otherbabies,soifweknowwhetherourhypotheticalco-workerisexpecting
twins,thatwouldhelp.
Nextonthelistis
paydu
,whichindicateswhethertherespondentowns
herhome.Itisoneofseveralincome-relatedvariablesthatturnoutto
bepredictive.IndatasetsliketheNSFG,incomeandwealtharecorrelated
withjustabouteverything.Inthisexample,incomeisrelatedtodiet,health,
healthcare,andotherfactorslikelytobirthweight.
Someoftheothervariablesonthelistarethingsthatwouldnotbeknown
untillater,like
bfeedwks
,thenumberofweeksthebabywasbreastfed.We
can'tusethesevariablesforprediction,butyoumightwanttospeculateon
reasons
bfeedwks
mightbecorrelatedwithbirthweight.
Sometimesyoustartwithatheoryandusedatatotestit.Othertimesyou
startwithdataandgolookingforpossibletheories.Thesecondapproach,
whichthissectiondemonstrates,iscalled
datamining
.Anadvantageof
dataminingisthatitcandiscoverunexpectedpatterns.Ahazardisthat
manyofthepatternsitdiscoversareeitherrandomorspurious.
Havingidenpotentialexplanatoryvariables,Itestedafewmodelsand
settledonthisone:
formula=~agepreg+C(race)+babysex==1+
+paydu==1+
results=smf.ols(formula,data=join).fit()
Thisformulausessomesyntaxwehavenotseenyet:
C(race)
tellsthe
formulaparser(Patsy)totreatraceasacategoricalvariable,eventhoughit
isencodednumerically.
Theencodingfor
babysex
is1formale,2forfemale;writing
babysex==1
convertsittoboolean,Trueformaleandfalseforfemale.
11.6.Logisticregression163
Similarly
nbrnaliv>1
isTrueformultiplebirthsand
paydu==1
isTruefor
respondentswhoowntheirhouses.
totincr
isencodednumericallyfrom1-14,witheachincrementrepresenting
about$5000inannualincome.Sowecantreatthesevaluesasnumerical,
expressedinunitsof$5000.
Herearetheresultsofthemodel:
Intercept6.63(0)
C(race)[T.2]0.357(5.43e-29)
C(race)[T.3]0.266(2.33e-07)
babysex==1[T.True]0.295(5.39e-29)
nbrnaliv>1[T.True]-1.38(5.1e-37)
paydu==1[T.True]0.12(0.000114)
agepreg0.00741(0.0035)
totincr0.0122(0.00188)
TheestimatedparametersforracearelargerthanIexpected,especiallysince
wecontrolforincome.Theencodingis1forblack,2forwhite,and3for
other.Babiesofblackmothersarelighterthanbabiesofotherracesby
0.27{0.36lbs.
Aswe'vealreadyseen,boysareheavierbyabout0.3lbs;twinsandother
multipletsarelighterby1.4lbs.
Peoplewhoowntheirhomeshaveheavierbabiesbyabout0.12lbs,even
whenwecontrolforincome.Theparameterformother'sageissmallerthan
whatwesawinSection11.2,whichsuggeststhatsomeoftheothervariables
arecorrelatedwithage,probablyincluding
paydu
and
totincr
.
Allofthesevariablesarestatisticallyt,somewithverylowp-values,
but
R
2
isonly0.06,stillquitesmall.RMSEwithoutusingthemodelis1.27
lbs;withthemodelitdropsto1.23.Soyourchanceofwinningthepoolis
notsubstantiallyimproved.Sorry!
11.6Logisticregression
Inthepreviousexamples,someoftheexplanatoryvariableswerenumerical
andsomecategorical(includingboolean).Butthedependentvariablewas
alwaysnumerical.
164Chapter11.Regression
Linearregressioncanbegeneralizedtohandleotherkindsofdependentvari-
ables.Ifthedependentvariableisboolean,thegeneralizedmodeliscalled
logisticregression
.Ifthedependentvariableisanintegercount,it'scalled
Poissonregression
.
Asanexampleoflogisticregression,let'sconsideravariationonthe
poolscenario.Supposeafriendofyoursispregnantandyouwanttopredict
whetherthebabyisaboyoragirl.YoucouldusedatafromtheNSFGto
factorsthatctthe\sexratio",whichisconventionallytobe
theprobabilityofhavingaboy.
Ifyouencodethedependentvariablenumerically,forexample0foragirl
and1foraboy,youcouldapplyordinaryleastsquares,buttherewouldbe
problems.Thelinearmodelmightbesomethinglikethis:
y
=

0
+

1
x
1
+

2
x
2
+
"
Where
y
isthedependentvariable,and
x
1
and
x
2
areexplanatoryvariables.
Thenwecouldtheparametersthatminimizetheresiduals.
Theproblemwiththisapproachisthatitproducespredictionsthatarehard
tointerpret.Givenestimatedparametersandvaluesfor
x
1
and
x
2
,themodel
mightpredict
y
=0
:
5,buttheonlymeaningfulvaluesof
y
are0and1.
Itistemptingtointerpretaresultlikethatasaprobability;forexample,
wemightsaythatarespondentwithparticularvaluesof
x
1
and
x
2
hasa
50%chanceofhavingaboy.Butitisalsopossibleforthismodeltopredict
y
=1
:
1or
y
=

0
:
1,andthosearenotvalidprobabilities.
Logisticregressionavoidsthisproblembyexpressingpredictionsintermsof
odds
ratherthanprobabilities.Ifyouarenotfamiliarwithodds,\oddsin
favor"ofaneventistheratiooftheprobabilityitwilloccurtotheprobability
thatitwillnot.
SoifIthinkmyteamhasa75%chanceofwinning,Iwouldsaythatthe
oddsintheirfavorarethreetoone,becausethechanceofwinningisthree
timesthechanceoflosing.
Oddsandprobabilitiesaretrepresentationsofthesameinformation.
Givenaprobability,youcancomputetheoddslikethis:
11.7.Estimatingparameters165
o=p/(1-p)
Givenoddsinfavor,youcanconverttoprobabilitylikethis:
p=o/(o+1)
Logisticregressionisbasedonthefollowingmodel:
log
o
=

0
+

1
x
1
+

2
x
2
+
"
Where
o
istheoddsinfavorofaparticularoutcome;intheexample,
o
would
betheoddsofhavingaboy.
Supposewehaveestimatedtheparameters

0
,

1
,and

2
(I'llexplainhowin
aminute).Andsupposewearegivenvaluesfor
x
1
and
x
2
.Wecancompute
thepredictedvalueoflog
o
,andthenconverttoaprobability:
o=np.exp(log_o)
p=o/(o+1)
Sointhepoolscenariowecouldcomputethepredictiveprobabilityof
havingaboy.Buthowdoweestimatetheparameters?
11.7Estimatingparameters
Unlikelinearregression,logisticregressiondoesnothaveaclosedformsolu-
tion,soitissolvedbyguessinganinitialsolutionandimprovingititeratively.
Theusualgoalistothemaximum-likelihoodestimate(MLE),whichis
thesetofparametersthatmaximizesthelikelihoodofthedata.Forexample,
supposewehavethefollowingdata:
>>>y=np.array([0,1,0,1])
>>>x1=np.array([0,0,0,1])
>>>x2=np.array([0,1,1,1])
Andwestartwiththeinitialguesses

0
=

1
:
5,

1
=2
:
8,and

2
=1
:
1:
>>>beta=[-1.5,2.8,1.1]
Thenforeachrowwecancompute
log_o
:
>>>log_o=beta[0]+beta[1]*x1+beta[2]*x2
[-1.5-0.4-0.42.4]
166Chapter11.Regression
Andconvertfromlogoddstoprobabilities:
>>>o=np.exp(log_o)
[0.2230.6700.67011.02]
>>>p=o/(o+1)
[0.1820.4010.4010.916]
Noticethatwhen
log_o
isgreaterthan0,
o
isgreaterthan1and
p
isgreater
than0.5.
Thelikelihoodofanoutcomeis
p
when
y==1
and
1-p
when
y==0
.For
example,ifwethinktheprobabilityofaboyis0.8andtheoutcomeisaboy,
thelikelihoodis0.8;iftheoutcomeisagirl,thelikelihoodis0.2.Wecan
computethatlikethis:
>>>likes=y*p+(1-y)*(1-p)
[0.8170.4010.5980.916]
Theoveralllikelihoodofthedataistheproductof
likes
:
>>>like=np.prod(likes)
0.18
Forthesevaluesof
beta
,thelikelihoodofthedatais0.18.The
goaloflogisticregressionistoparametersthatmaximizethislike-
lihood.Todothat,moststatisticspackagesuseaniterativesolver
likeNewton'smethod(see
https://en.wikipedia.org/wiki/Logistic_
regression#Model_fitting
).
11.8Implementation
StatsModelsprovidesanimplementationoflogisticregressioncalled
logit
,
namedforthefunctionthatconvertsfromprobabilitytologodds.Todemon-
strateitsuse,I'lllookforvariablesthatthesexratio.
Again,IloadtheNSFGdataandselectpregnancieslongerthan30weeks:
live,firsts,others=first.MakeFrames()
df=live[live.prglngth>30]
logit
requiresthedependentvariabletobebinary(ratherthanboolean),so
Icreateanewcolumnnamed
boy
,using
astype(int)
toconverttobinary
integers:
11.8.Implementation167
=(df.babysex==1).astype(int)
Factorsthathavebeenfoundtosexratioincludeparents'age,birth
order,race,andsocialstatus.Wecanuselogisticregressiontoseeifthese
appearintheNSFGdata.I'llstartwiththemother'sage:
importstatsmodels.formula.apiassmf
model=~data=df)
results=model.fit()
SummarizeResults(results)
logit
takesthesameargumentsas
ols
,aformulainPatsysyntaxanda
DataFrame.TheresultisaLogitobjectthatrepresentsthemodel.Itcon-
tainsattributescalled
endog
and
exog
thatcontainthe
endogenousvari-
able
,anothernameforthedependentvariable,andthe
exogenousvari-
ables
,anothernamefortheexplanatoryvariables.SincetheyareNumPy
arrays,itissometimesconvenienttoconvertthemtoDataFrames:
endog=pandas.DataFrame(model.endog,columns=[model.endog_names])
exog=pandas.DataFrame(model.exog,columns=model.exog_names)
Theresultof
model.fit
isaBinaryResultsobject,whichissimilartothe
RegressionResultsobjectwegotfrom
ols
.Hereisasummaryoftheresults:
Intercept0.00579(0.953)
agepreg0.00105(0.783)
R^26.144e-06
Theparameterof
agepreg
ispositive,whichsuggeststhatoldermothersare
morelikelytohaveboys,butthep-valueis0.783,whichmeansthatthe
apparentcouldeasilybeduetochance.
Thecotofdetermination,
R
2
,doesnotapplytologisticregression,
butthereareseveralalternativesthatareusedas\pseudo
R
2
values."These
valuescanbeusefulforcomparingmodels.Forexample,here'samodelthat
includesseveralfactorsbelievedtobeassociatedwithsexratio:
formula=~agepreg+hpagelb+birthord+
model=smf.logit(formula,data=df)
results=model.fit()
Alongwithmother'sage,thismodelincludesfather'sageatbirth(
hpagelb
),
birthorder(
birthord
),andraceasacategoricalvariable.Herearethe
results:
168Chapter11.Regression
Intercept-0.0301(0.772)
C(race)[T.2]-0.0224(0.66)
C(race)[T.3]-0.000457(0.996)
agepreg-0.00267(0.629)
hpagelb0.0047(0.266)
birthord0.00501(0.821)
R^20.000144
Noneoftheestimatedparametersarestatisticallyt.Thepseudo-
R
2
valueisalittlehigher,butthatcouldbeduetochance.
11.9Accuracy
Inthepoolscenario,wearemostinterestedintheaccuracyofthe
model:thenumberofsuccessfulpredictions,comparedwithwhatwewould
expectbychance.
IntheNSFGdata,therearemoreboysthangirls,sothebaselinestrategyis
toguess\boy"everytime.Theaccuracyofthisstrategyisjustthefraction
ofboys:
actual=
baseline=actual.mean()
Since
actual
isencodedinbinaryintegers,themeanisthefractionofboys,
whichis0.507.
Here'showwecomputetheaccuracyofthemodel:
predict=(results.predict()>=0.5)
true_pos=predict*actual
true_neg=(1-predict)*(1-actual)
results.predict
returnsaNumPyarrayofprobabilities,whichweround
to0or1.Multiplyingby
actual
yields1ifwepredictaboyandgetit
right,0otherwise.So,
true_pos
indicates\truepositives".
Similarly,
true_neg
indicatesthecaseswhereweguess\girl"andgetitright.
Accuracyisthefractionofcorrectguesses:
acc=(sum(true_pos)+sum(true_neg))/len(actual)
11.10.Exercises169
Theresultis0.512,slightlybetterthanthebaseline,0.507.But,youshould
nottakethisresulttooseriously.Weusedthesamedatatobuildandtest
themodel,sothemodelmaynothavepredictivepoweronnewdata.
Nevertheless,let'susethemodeltomakeapredictionforthepool.
Supposeyourfriendis35yearsoldandwhite,herhusbandis39,andthey
areexpectingtheirthirdchild:
columns=
new=pandas.DataFrame([[35,39,3,2]],columns=columns)
y=results.predict(new)
Toinvoke
results.predict
foranewcase,youhavetoconstructa
DataFramewithacolumnforeachvariableinthemodel.Theresultin
thiscaseis0.52,soyoushouldguess\boy."Butifthemodelimprovesyour
chancesofwinning,theisverysmall.
11.10Exercises
Mysolutiontotheseexercisesisin
chap11soln.ipynb
.
Exercise11.1
Supposeoneofyourco-workersisexpectingababyandyou
areparticipatinginanpooltopredictthedateofbirth.Assumingthat
betsareplacedduringthe30thweekofpregnancy,whatvariablescouldyou
usetomakethebestprediction?Youshouldlimityourselftovariablesthat
areknownbeforethebirth,andlikelytobeavailabletothepeopleinthe
pool.
Exercise11.2
TheTrivers-Willardhypothesissuggeststhatformanymam-
malsthesexratiodependson\maternalcondition";thatis,factorslikethe
mother'sage,size,health,andsocialstatus.See
https://en.wikipedia.
org/wiki/Trivers-Willard_hypothesis
Somestudieshaveshownthiseamonghumans,butresultsaremixed.
Inthischapterwetestedsomevariablesrelatedtothesefactors,butdidn't
anywithastatisticallytonsexratio.
Asanexercise,useadataminingapproachtotesttheothervariablesinthe
pregnancyandrespondentCanyouanyfactorswithasubstantial

170Chapter11.Regression
Exercise11.3
Ifthequantityyouwanttopredictisacount,youcanuse
Poissonregression,whichisimplementedinStatsModelswithafunction
called
poisson
.Itworksthesamewayas
ols
and
logit
.Asanexercise,
let'suseittopredicthowmanychildrenawomanhasborn;intheNSFG
dataset,thisvariableiscalled
numbabes
.
Supposeyoumeetawomanwhois35yearsold,black,andacollegegraduate
whoseannualhouseholdincomeexceeds$75,000.Howmanychildrenwould
youpredictshehasborn?
Exercise11.4
Ifthequantityyouwanttopredictiscategorical,youcanuse
multinomiallogisticregression,whichisimplementedinStatsModelswitha
functioncalled
mnlogit
.Asanexercise,let'suseittoguesswhetherawoman
ismarried,cohabitating,widowed,divorced,separated,ornevermarried;in
theNSFGdataset,maritalstatusisencodedinavariablecalled
rmarital
.
Supposeyoumeetawomanwhois25yearsold,white,andahighschool
graduatewhoseannualhouseholdincomeisabout$45,000.Whatisthe
probabilitythatsheismarried,cohabitating,etc?
11.11Glossary

regression
:Oneofseveralrelatedprocessesforestimatingparameters
thatamodeltodata.

dependentvariables
:Thevariablesinaregressionmodelwewould
liketopredict.Alsoknownasendogenousvariables.

explanatoryvariables
:Thevariablesusedtopredictorexplainthe
dependentvariables.Alsoknownasindependent,orexogenous,vari-
ables.

simpleregression
:Aregressionwithonlyonedependentandone
explanatoryvariable.

multipleregression
:Aregressionwithmultipleexplanatoryvari-
ables,butonlyonedependentvariable.

linearregression
:Aregressionbasedonalinearmodel.
11.11.Glossary171

ordinaryleastsquares
:Alinearregressionthatestimatesparame-
tersbyminimizingthesquarederroroftheresiduals.

spuriousrelationship
:Arelationshipbetweentwovariablesthatis
causedbyastatisticalartifactorafactor,notincludedinthemodel,
thatisrelatedtobothvariables.

controlvariable
:Avariableincludedinaregressiontoeliminateor
\controlfor"aspuriousrelationship.

proxyvariable
:Avariablethatcontributesinformationtoaregres-
sionmodelindirectlybecauseofarelationshipwithanotherfactor,so
itactsasaproxyforthatfactor.

categoricalvariable
:Avariablethatcanhaveoneofadiscreteset
ofunorderedvalues.

join
:AnoperationthatcombinesdatafromtwoDataFramesusinga
keytomatchuprowsinthetwoframes.

datamining
:Anapproachtorelationshipsbetweenvariables
bytestingalargenumberofmodels.

logisticregression
:Aformofregressionusedwhenthedependent
variableisboolean.

Poissonregression
:Aformofregressionusedwhenthedependent
variableisanon-negativeinteger,usuallyacount.

odds
:Analternativewayofrepresentingaprobability,
p
,astheratio
oftheprobabilityanditscomplement,
p=
(1

p
).
172Chapter11.Regression
Chapter12
Timeseriesanalysis
A
timeseries
isasequenceofmeasurementsfromasystemthatvariesin
time.Onefamousexampleisthe\hockeystickgraph"thatshowsglobalaver-
agetemperatureovertime(see
https://en.wikipedia.org/wiki/Hockey_
stick_graph
).
TheexampleIworkwithinthischaptercomesfromZacharyM.Jones,a
researcherinpoliticalsciencewhostudiestheblackmarketforcannabisin
theU.S.(
http://zmjones.com/marijuana
).Hecollecteddatafromaweb
sitecalled\PriceofWeed"thatcrowdsourcesmarketinformationbyasking
participantstoreporttheprice,quantity,quality,andlocationofcannabis
transactions(
http://www.priceofweed.com/
).Thegoalofhisprojectisto
investigatetheofpolicydecisions,likelegalization,onmarkets.I
thisprojectappealingbecauseitisanexamplethatusesdatatoaddress
importantpoliticalquestions,likedrugpolicy.
Ihopeyouwillthischapterinteresting,butI'lltakethisopportunity
toreiteratetheimportanceofmaintainingaprofessionalattitudetodata
analysis.Whetherandwhichdrugsshouldbeillegalareimportantand
publicpolicyquestions;ourdecisionsshouldbeinformedbyaccurate
datareportedhonestly.
Thecodeforthischapterisin
timeseries.py
.Forinformationaboutdown-
loadingandworkingwiththiscode,seeSection0.2.
174Chapter12.Timeseriesanalysis
12.1Importingandcleaning
ThedataIdownloadedfromMr.Jones'ssiteisintherepositoryforthis
book.ThefollowingcodereadsitintoapandasDataFrame:
transactions=parse_dates=[5])
parse_dates
tells
read_csv
tointerpretvaluesincolumn5asdatesand
convertthemtoNumPy
datetime64
objects.
TheDataFramehasarowforeachreportedtransactionandthefollowing
columns:

city:stringcityname.

state:two-letterstateabbreviation.

price:pricepaidindollars.

amount:quantitypurchasedingrams.

quality:high,medium,orlowquality,asreportedbythepurchaser.

date:dateofreport,presumedtobeshortlyafterdateofpurchase.

ppg:pricepergram,indollars.

state.name:stringstatename.

lat:approximatelatitudeofthetransaction,basedoncityname.

lon:approximatelongitudeofthetransaction.
Eachtransactionisaneventintime,sowecouldtreatthisdatasetasa
timeseries.Buttheeventsarenotequallyspacedintime;thenumber
oftransactionsreportedeachdayvariesfrom0toseveralhundred.Many
methodsusedtoanalyzetimeseriesrequirethemeasurementstobeequally
spaced,oratleastthingsaresimpleriftheyare.
Inordertodemonstratethesemethods,Idividethedatasetintogroupsby
reportedquality,andthentransformeachgroupintoanequallyspacedseries
bycomputingthemeandailypricepergram.
12.1.Importingandcleaning175
defGroupByQualityAndDay(transactions):
groups=
dailies={}
forname,groupingroups:
dailies[name]=GroupByDay(group)
returndailies
groupby
isaDataFramemethodthatreturnsaGroupByobject,
groups
;
usedinaforloop,ititeratesthenamesofthegroupsandtheDataFrames
thatrepresentthem.Sincethevaluesof
quality
are
low
,
medium
,and
high
,
wegetthreegroupswiththosenames.
Theloopiteratesthroughthegroupsandcalls
GroupByDay
,whichcomputes
thedailyaveragepriceandreturnsanewDataFrame:
defGroupByDay(transactions,func=np.mean):
grouped=
daily=grouped.aggregate(func)
=daily.index
start=daily.date[0]
one_year=np.timedelta64(1,
=(daily.date-start)/one_year
returndaily
Theparameter,
transactions
,isaDataFramethatcontainscolumns
date
and
ppg
.Weselectthesetwocolumns,thengroupby
date
.
Theresult,
grouped
,isamapfromeachdatetoaDataFramethatcontains
pricesreportedonthatdate.
aggregate
isaGroupBymethodthatiterates
throughthegroupsandappliesafunctiontoeachcolumnofthegroup;in
thiscasethereisonlyonecolumn,
ppg
.Sotheresultof
aggregate
isa
DataFramewithonerowforeachdateandonecolumn,
ppg
.
DatesintheseDataFramesarestoredasNumPy
datetime64
objects,which
arerepresentedas64-bitintegersinnanoseconds.Forsomeoftheanalyses
comingup,itwillbeconvenienttoworkwithtimeinmorehuman-friendly
units,likeyears.So
GroupByDay
addsacolumnnamed
date
bycopyingthe
176Chapter12.Timeseriesanalysis
index
,thenadds
years
,whichcontainsthenumberofyearssincethe
transactionasaointnumber.
TheresultingDataFramehascolumns
ppg
,
date
,and
years
.
12.2Plotting
Theresultfrom
GroupByQualityAndDay
isamapfromeachqualitytoa
DataFrameofdailyprices.Here'sthecodeIusetoplotthethreetime
series:
thinkplot.PrePlot(rows=3)
fori,(name,daily)inenumerate(dailies.items()):
thinkplot.SubPlot(i+1)
title=pergramifi==0else
thinkplot.Config(ylim=[0,20],title=title)
thinkplot.Scatter(daily.index,daily.ppg,s=10,label=name)
ifi==2:
pyplot.xticks(rotation=30)
else:
thinkplot.Config(xticks=[])
PrePlot
with
rows=3
meansthatweareplanningtomakethreesubplotslaid
outinthreerows.TheloopiteratesthroughtheDataFramesandcreatesa
scatterplotforeach.Itiscommontoplottimeserieswithlinesegments
betweenthepoints,butinthiscasetherearemanydatapointsandprices
arehighlyvariable,soaddinglineswouldnothelp.
Sincethelabelsonthex-axisaredates,Iuse
pyplot.xticks
torotatethe
\ticks"30degrees,makingthemmorereadable.
Figure12.1showstheresult.Oneapparentfeatureintheseplotsisagap
aroundNovember2013.It'spossiblethatdatacollectionwasnotactive
duringthistime,orthedatamightnotbeavailable.Wewillconsiderways
todealwiththismissingdatalater.
Visually,itlookslikethepriceofhighqualitycannabisisdecliningduring
thisperiod,andthepriceofmediumqualityisincreasing.Thepriceoflow
qualitymightalsobeincreasing,butitishardertotell,sinceitseemstobe
12.2.Plotting177
Figure12.1:Timeseriesofdailypricepergramforhigh,medium,andlow
qualitycannabis.
178Chapter12.Timeseriesanalysis
morevolatile.Keepinmindthatqualitydataisreportedbyvolunteers,so
trendsovertimemightchangesinhowparticipantsapplytheselabels.
12.3Linearregression
Althoughtherearemethodssptotimeseriesanalysis,formanyprob-
lemsasimplewaytogetstartedisbyapplyinggeneral-purposetoolslike
linearregression.ThefollowingfunctiontakesaDataFrameofdailyprices
andcomputesaleastsquaresreturningthemodelandresultsobjects
fromStatsModels:
defRunLinearModel(daily):
model=~data=daily)
results=model.fit()
returnmodel,results
Thenwecaniteratethroughthequalitiesandamodeltoeach:
forname,dailyindailies.items():
model,results=RunLinearModel(daily)
print(name)
regression.SummarizeResults(results)
Herearetheresults:
quality
intercept
slope
R
2
high
13.450
-0.708
0.444
medium
8.879
0.283
0.050
low
5.362
0.568
0.030
Theestimatedslopesindicatethatthepriceofhighqualitycannabisdropped
byabout71centsperyearduringtheobservedinterval;formediumquality
itincreasedby28centsperyear,andforlowqualityitincreasedby57cents
peryear.Theseestimatesareallstatisticallytwithverysmall
p-values.
The
R
2
valueforhighqualitycannabisis0.44,whichmeansthattimeas
anexplanatoryvariableaccountsfor44%oftheobservedvariabilityinprice.
Fortheotherqualities,thechangeinpriceissmaller,andvariabilityinprices
ishigher,sothevaluesof
R
2
aresmaller(butstillstatisticallyt).
12.3.Linearregression179
Figure12.2:Timeseriesofdailypricepergramforhighqualitycannabis,
andalinearleastsquares
Thefollowingcodeplotstheobservedpricesandthevalues:
defPlotFittedValues(model,results,
years=model.exog[:,1]
values=model.endog
thinkplot.Scatter(years,values,s=15,label=label)
thinkplot.Plot(years,results.fittedvalues,
AswesawinSection11.8,
model
contains
exog
and
endog
,NumPyarrays
withtheexogenous(explanatory)andendogenous(dependent)variables.
PlotFittedValues
makesascatterplotofthedatapointsandalineplotof
thevalues.Figure12.2showstheresultsforhighqualitycannabis.The
modelseemslikeagoodlinearforthedata;nevertheless,linearregression
isnotthemostappropriatechoiceforthisdata:

First,thereisnoreasontoexpectthelong-termtrendtobealineor
anyothersimplefunction.Ingeneral,pricesaredeterminedbysupply
anddemand,bothofwhichvaryovertimeinunpredictableways.

Second,thelinearregressionmodelgivesequalweighttoalldata,recent
andpast.Forpurposesofprediction,weshouldprobablygivemore
weighttorecentdata.
180Chapter12.Timeseriesanalysis

Finally,oneoftheassumptionsoflinearregressionisthattheresiduals
areuncorrelatednoise.Withtimeseriesdata,thisassumptionisoften
falsebecausesuccessivevaluesarecorrelated.
Thenextsectionpresentsanalternativethatismoreappropriatefortime
seriesdata.
12.4Movingaverages
Mosttimeseriesanalysisisbasedonthemodelingassumptionthattheob-
servedseriesisthesumofthreecomponents:

Trend:Asmoothfunctionthatcapturespersistentchanges.

Seasonality:Periodicvariation,possiblyincludingdaily,weekly,
monthly,oryearlycycles.

Noise:Randomvariationaroundthelong-termtrend.
Regressionisonewaytoextractthetrendfromaseries,aswesawinthe
previoussection.Butifthetrendisnotasimplefunction,agoodalternative
isa
movingaverage
.Amovingaveragedividestheseriesintooverlapping
regions,called
windows
,andcomputestheaverageofthevaluesineach
window.
Oneofthesimplestmovingaveragesisthe
rollingmean
,whichcomputes
themeanofthevaluesineachwindow.Forexample,ifthewindowsizeis
3,therollingmeancomputesthemeanofvalues0through2,1through3,2
through4,etc.
pandasprovides
rolling_mean
,whichtakesaSeriesandawindowsizeand
returnsanewSeries.
>>>series=np.arange(10)
array([0,1,2,3,4,5,6,7,8,9])
>>>pandas.rolling_mean(series,3)
array([nan,nan,1,2,3,4,5,6,7,8])
12.4.Movingaverages181
Thetwovaluesare
nan
;thenextvalueisthemeanofthethree
elements,0,1,and2.Thenextvalueisthemeanof1,2,and3.Andsoon.
Beforewecanapply
rolling_mean
tothecannabisdata,wehavetodeal
withmissingvalues.Thereareafewdaysintheobservedintervalwithno
reportedtransactionsforoneormorequalitycategories,andaperiodin2013
whendatacollectionwasnotactive.
IntheDataFrameswehaveusedsofar,thesedatesareabsent;theindex
skipsdayswithnodata.Fortheanalysisthatfollows,weneedtorepresent
thismissingdataexplicitly.Wecandothatby\reindexing"theDataFrame:
dates=pandas.date_range(daily.index.min(),daily.index.max())
reindexed=daily.reindex(dates)
Thelinecomputesadaterangethatincludeseverydayfromthebe-
ginningtotheendoftheobservedinterval.Thesecondlinecreatesanew
DataFramewithallofthedatafrom
daily
,butincludingrowsforalldates,
with
nan
.
Nowwecanplottherollingmeanlikethis:
roll_mean=pandas.rolling_mean(reindexed.ppg,30)
thinkplot.Plot(roll_mean.index,roll_mean)
Thewindowsizeis30,soeachvaluein
roll_mean
isthemeanof30values
from
reindexed.ppg
.
Figure12.3(left)showstheresult.Therollingmeanseemstodoagoodjob
ofsmoothingoutthenoiseandextractingthetrend.The29valuesare
nan
,andwhereverthere'samissingvalue,it'sfollowedbyanother29
nan
s.
Therearewaystointhesegaps,buttheyareaminornuisance.
Analternativeisthe
exponentially-weightedmovingaverage
(EWMA),
whichhastwoadvantages.First,asthenamesuggests,itcomputesa
weightedaveragewherethemostrecentvaluehasthehighestweightand
theweightsforpreviousvaluesdropexponentially.Second,thepandas
implementationofEWMAhandlesmissingvaluesbetter.
ewma=pandas.ewma(reindexed.ppg,span=30)
thinkplot.Plot(ewma.index,ewma)
182Chapter12.Timeseriesanalysis
Figure12.3:Dailypriceandarollingmean(left)andexponentially-weighted
movingaverage(right).
The
span
parametercorrespondsroughlytothewindowsizeofamoving
average;itcontrolshowfasttheweightsdropsoitdeterminesthenumber
ofpointsthatmakeanon-negligiblecontributiontoeachaverage.
Figure12.3(right)showstheEWMAforthesamedata.Itissimilarto
therollingmean,wheretheyarebothbutithasnomissingvalues,
whichmakesiteasiertoworkwith.Thevaluesarenoisyatthebeginningof
thetimeseries,becausetheyarebasedonfewerdatapoints.
12.5Missingvalues
Nowthatwehavecharacterizedthetrendofthetimeseries,thenextstepis
toinvestigateseasonality,whichisperiodicbehavior.Timeseriesdatabased
onhumanbehavioroftenexhibitsdaily,weekly,monthly,oryearlycycles.
InthenextsectionIpresentmethodstotestforseasonality,buttheydon't
workwellwithmissingdata,sowehavetosolvethatproblemst.
Asimpleandcommonwaytomissingdataistouseamovingaverage.
TheSeriesmethod
fillna
doesjustwhatwewant:
reindexed.ppg.fillna(ewma,inplace=True)
12.6.Serialcorrelation183
Figure12.4:Dailypricewithdata.
Wherever
reindexed.ppg
is
nan
,
fillna
replacesitwiththecorresponding
valuefrom
ewma
.The
inplace
tells
fillna
tomodifytheexistingSeries
ratherthancreateanewone.
Adrawbackofthismethodisthatitunderstatesthenoiseintheseries.We
cansolvethatproblembyaddinginresampledresiduals:
resid=(reindexed.ppg-ewma).dropna()
fake_data=ewma+thinkstats2.Resample(resid,len(reindexed))
reindexed.ppg.fillna(fake_data,inplace=True)
resid
containstheresidualvalues,notincludingdayswhen
ppg
is
nan
.
fake_data
containsthesumofthemovingaverageandarandomsampleof
residuals.Finally,
fillna
replaces
nan
withvaluesfrom
fake_data
.
Figure12.4showstheresult.Thedataisvisuallysimilartotheactual
values.Sincetheresampledresidualsarerandom,theresultsaredt
everytime;laterwe'llseehowtocharacterizetheerrorcreatedbymissing
values.
12.6Serialcorrelation
Aspricesvaryfromdaytoday,youmightexpecttoseepatterns.Iftheprice
ishighonMonday,youmightexpectittobehighforafewmoredays;and
184Chapter12.Timeseriesanalysis
ifit'slow,youmightexpectittostaylow.Apatternlikethisiscalled
serial
correlation
,becauseeachvalueiscorrelatedwiththenextoneintheseries.
Tocomputeserialcorrelation,wecanshiftthetimeseriesbyaninterval
calleda
lag
,andthencomputethecorrelationoftheshiftedserieswiththe
original:
defSerialCorr(series,lag=1):
xs=series[lag:]
ys=series.shift(lag)[lag:]
corr=thinkstats2.Corr(xs,ys)
returncorr
Aftertheshift,the
lag
valuesare
nan
,soIuseaslicetoremovethem
beforecomputing
Corr
.
Ifweapply
SerialCorr
totherawpricedatawithlag1,wedserial
correlation0.48forthehighqualitycategory,0.16formediumand0.10for
low.Inanytimeserieswithalong-termtrend,weexpecttoseestrongserial
correlations;forexample,ifpricesarefalling,weexpecttoseevaluesabove
themeaninthehalfoftheseriesandvaluesbelowthemeaninthe
secondhalf.
Itismoreinterestingtoseeifthecorrelationpersistsifyousubtractaway
thetrend.Forexample,wecancomputetheresidualoftheEWMAand
thencomputeitsserialcorrelation:
ewma=pandas.ewma(reindexed.ppg,span=30)
resid=reindexed.ppg-ewma
corr=SerialCorr(resid,1)
Withlag=1,theserialcorrelationsforthede-trendeddataare-0.022for
highquality,-0.015formedium,and0.036forlow.Thesevaluesaresmall,
indicatingthatthereislittleornoone-dayserialcorrelationinthisseries.
Tocheckforweekly,monthly,andyearlyseasonality,Irantheanalysisagain
withtlags.Herearetheresults:
lag
high
medium
low
1
-0.029
-0.014
0.034
7
0.02
-0.042
-0.0097
30
0.014
-0.0064
-0.013
365
0.045
0.015
0.033
12.7.Autocorrelation185
Inthenextsectionwe'lltestwhetherthesecorrelationsarestatisticallysig-
t(theyarenot),butatthispointwecantentativelyconcludethat
therearenosubstantialseasonalpatternsintheseseries,atleastnotwith
theselags.
12.7Autocorrelation
Ifyouthinkaseriesmighthavesomeserialcorrelation,butyoudon'tknow
whichlagstotest,youcantestthemall!The
autocorrelationfunction
isafunctionthatmapsfromlagtotheserialcorrelationwiththegivenlag.
\Autocorrelation"isanothernameforserialcorrelation,usedmoreoften
whenthelagisnot1.
StatsModels,whichweusedforlinearregressioninSection11.1,alsopro-
videsfunctionsfortimeseriesanalysis,including
acf
,whichcomputesthe
autocorrelationfunction:
importstatsmodels.tsa.stattoolsassmtsa
acf=smtsa.acf(filled.resid,nlags=365,unbiased=True)
acf
computesserialcorrelationswithlagsfrom0through
nlags
.The
unbiased
tells
acf
tocorrecttheestimatesforthesamplesize.The
resultisanarrayofcorrelations.Ifweselectdailypricesforhighquality,
andextractcorrelationsforlags1,7,30,and365,wecanthat
acf
and
SerialCorr
yieldapproximatelythesameresults:
>>>acf[0],acf[1],acf[7],acf[30],acf[365]
1.000,-0.029,0.020,0.014,0.044
With
lag=0
,
acf
computesthecorrelationoftheserieswithitself,whichis
always1.
Figure12.5(left)showsautocorrelationfunctionsforthethreequalitycat-
egories,with
nlags=40
.Thegrayregionshowsthenormalvariabilitywe
wouldexpectifthereisnoactualautocorrelation;anythingthatfallsoutside
thisrangeisstatisticallysit,withap-valuelessthan5%.Sincethe
falsepositiverateis5%,andwearecomputing120correlations(40lagsfor
eachof3timesseries),weexpecttoseeabout6pointsoutsidethisregion.
Infact,thereare7.Weconcludethattherearenoautocorrelationsinthese
seriesthatcouldnotbeexplainedbychance.
186Chapter12.Timeseriesanalysis
Figure12.5:Autocorrelationfunctionfordailyprices(left),anddailyprices
withasimulatedweeklyseasonality(right).
Icomputedthegrayregionsbyresamplingtheresiduals.Youcanseemy
codein
timeseries.py
;thefunctioniscalled
SimulateAutocorrelation
.
Toseewhattheautocorrelationfunctionlookslikewhenthereisaseasonal
component,Igeneratedsimulateddatabyaddingaweeklycycle.Assuming
thatdemandforcannabisishigheronweekends,wemightexpecttheprice
tobehigher.TosimulatethisIselectdatesthatfallonFridayor
Saturdayandaddarandomamounttotheprice,chosenfromauniform
distributionfrom$0to$2.
defAddWeeklySeasonality(daily):
frisat=(daily.index.dayofweek==4)|(daily.index.dayofweek==5)
fake=daily.copy()
fake.ppg[frisat]+=np.random.uniform(0,2,frisat.sum())
returnfake
frisat
isabooleanSeries,
True
ifthedayoftheweekisFridayorSaturday.
fake
isanewDataFrame,initiallyacopyof
daily
,whichwemodifyby
addingrandomvaluesto
ppg
.
frisat.sum()
isthetotalnumberofFridays
andSaturdays,whichisthenumberofrandomvalueswehavetogenerate.
Figure12.5(right)showsautocorrelationfunctionsforpriceswiththissim-
12.8.Prediction187
ulatedseasonality.Asexpected,thecorrelationsarehighestwhenthelagis
amultipleof7.Forhighandmediumquality,thenewcorrelationsaresta-
tisticallysignt.Forlowqualitytheyarenot,becauseresidualsinthis
categoryarelarge;thewouldhavetobebiggertobevisiblethrough
thenoise.
12.8Prediction
Timeseriesanalysiscanbeusedtoinvestigate,andsometimesexplain,the
behaviorofsystemsthatvaryintime.Itcanalsomakepredictions.
ThelinearregressionsweusedinSection12.3canbeusedforprediction.
TheRegressionResultsclassprovides
predict
,whichtakesaDataFrame
containingtheexplanatoryvariablesandreturnsasequenceofpredictions.
Here'sthecode:
defGenerateSimplePrediction(results,years):
n=len(years)
inter=np.ones(n)
d=dict(Intercept=inter,years=years)
predict_df=pandas.DataFrame(d)
predict=results.predict(predict_df)
returnpredict
results
isaRegressionResultsobject;
years
isthesequenceoftimevalues
wewantpredictionsfor.ThefunctionconstructsaDataFrame,passesitto
predict
,andreturnstheresult.
Ifallwewantisasingle,best-guessprediction,we'redone.Butformost
purposesitisimportanttoquantifyerror.Inotherwords,wewanttoknow
howaccuratethepredictionislikelytobe.
Therearethreesourcesoferrorweshouldtakeintoaccount:

Samplingerror:Thepredictionisbasedonestimatedparameters,
whichdependonrandomvariationinthesample.Ifweruntheexper-
imentagain,weexpecttheestimatestovary.
188Chapter12.Timeseriesanalysis

Randomvariation:Eveniftheestimatedparametersareperfect,the
observeddatavariesrandomlyaroundthelong-termtrend,andwe
expectthisvariationtocontinueinthefuture.

Modelingerror:Wehavealreadyseenevidencethatthelong-term
trendisnotlinear,sopredictionsbasedonalinearmodelwilleventually
fail.
Anothersourceoferrortoconsiderisunexpectedfutureevents.Agricultural
pricesarebyweather,andallpricesarebypoliticsandlaw.
AsIwritethis,cannabisislegalintwostatesandlegalformedicalpurposes
in20more.Ifmorestateslegalizeit,thepriceislikelytogodown.Butif
thefederalgovernmentcracksdown,thepricemightgoup.
Modelingerrorsandunexpectedfutureeventsarehardtoquantify.Sampling
errorandrandomvariationareeasiertodealwith,sowe'lldothat
Toquantifysamplingerror,Iuseresampling,aswedidinSection10.4.As
always,thegoalistousetheactualobservationstosimulatewhatwould
happenifwerantheexperimentagain.Thesimulationsarebasedonthe
assumptionthattheestimatedparametersarecorrect,buttherandomresid-
ualscouldhavebeent.Hereisafunctionthatrunsthesimulations:
defSimulateResults(daily,iters=101):
model,results=RunLinearModel(daily)
fake=daily.copy()
result_seq=[]
foriinrange(iters):
fake.ppg=results.fittedvalues+Resample(results.resid)
_,fake_results=RunLinearModel(fake)
result_seq.append(fake_results)
returnresult_seq
daily
isaDataFramecontainingtheobservedprices;
iters
isthenumber
ofsimulationstorun.
SimulateResults
uses
RunLinearModel
,fromSection12.3,toestimatethe
slopeandinterceptoftheobservedvalues.
12.8.Prediction189
Eachtimethroughtheloop,itgeneratesa\fake"datasetbyresamplingthe
residualsandaddingthemtothevalues.Thenitrunsalinearmodel
onthefakedataandstorestheRegressionResultsobject.
Thenextstepistousethesimulatedresultstogeneratepredictions:
defGeneratePredictions(result_seq,years,add_resid=False):
n=len(years)
d=dict(Intercept=np.ones(n),years=years,years2=years**2)
predict_df=pandas.DataFrame(d)
predict_seq=[]
forfake_resultsinresult_seq:
predict=fake_results.predict(predict_df)
ifadd_resid:
predict+=thinkstats2.Resample(fake_results.resid,n)
predict_seq.append(predict)
returnpredict_seq
GeneratePredictions
takesthesequenceofresultsfromthepreviousstep,
aswellas
years
,whichisasequenceofthatsptheintervaltogen-
eratepredictionsfor,and
add_resid
,whichindicateswhetheritshouldadd
resampledresidualstothestraight-lineprediction.
GeneratePredictions
iteratesthroughthesequenceofRegressionResultsandgeneratesasequence
ofpredictions.
Finally,here'sthecodethatplotsa90%intervalforthepredic-
tions:
defPlotPredictions(daily,years,iters=101,percent=90):
result_seq=SimulateResults(daily,iters=iters)
p=(100-percent)/2
percents=p,100-p
predict_seq=GeneratePredictions(result_seq,years,True)
low,high=thinkstats2.PercentileRows(predict_seq,percents)
thinkplot.FillBetween(years,low,high,alpha=0.3,colo
predict_seq=GeneratePredictions(result_seq,years,False)
190Chapter12.Timeseriesanalysis
Figure12.6:Predictionsbasedonlinearshowingvariationduetosam-
plingerrorandpredictionerror.
low,high=thinkstats2.PercentileRows(predict_seq,percents)
thinkplot.FillBetween(years,low,high,alpha=0.5,colo
PlotPredictions
calls
GeneratePredictions
twice:oncewith
add_resid=True
andagainwith
add_resid=False
.Ituses
PercentileRows
toselectthe5thand95thpercentilesforeachyear,thenplotsagrayregion
betweenthesebounds.
Figure12.6showstheresult.Thedarkgrayregionrepresentsa90%
denceintervalforthesamplingerror;thatis,uncertaintyabouttheestimated
slopeandinterceptduetosampling.
Thelighterregionshowsa90%intervalforpredictionerror,which
isthesumofsamplingerrorandrandomvariation.
Theseregionsquantifysamplingerrorandrandomvariation,butnotmod-
elingerror.Ingeneralmodelingerrorishardtoquantify,butinthiscasewe
canaddressatleastonesourceoferror,unpredictableexternalevents.
Theregressionmodelisbasedontheassumptionthatthesystemis
sta-
tionary
;thatis,thattheparametersofthemodeldon'tchangeovertime.
Sp,itassumesthattheslopeandinterceptareconstant,aswellas
thedistributionofresiduals.
12.8.Prediction191
Figure12.7:Predictionsbasedonlinearshowingvariationduetothe
intervalofobservation.
ButlookingatthemovingaveragesinFigure12.3,itseemsliketheslope
changesatleastonceduringtheobservedinterval,andthevarianceofthe
residualsseemsbiggerinthehalfthanthesecond.
Asaresult,theparameterswegetdependontheintervalweobserve.Tosee
howmuchthishasonthepredictions,wecanextend
SimulateResults
touseintervalsofobservationwithtstartandenddates.Myimple-
mentationisin
timeseries.py
.
Figure12.7showstheresultforthemediumqualitycategory.Thelightest
grayareashowsaintervalthatincludesuncertaintyduetosam-
plingerror,randomvariation,andvariationintheintervalofobservation.
Themodelbasedontheentireintervalhaspositiveslope,indicatingthat
priceswereincreasing.Butthemostrecentintervalshowssignsofdecreasing
prices,somodelsbasedonthemostrecentdatahavenegativeslope.Asa
result,thewidestpredictiveintervalincludesthepossibilityofdecreasing
pricesoverthenextyear.
192Chapter12.Timeseriesanalysis
12.9Furtherreading
Timeseriesanalysisisabigtopic;thischapterhasonlyscratchedthesurface.
Animportanttoolforworkingwithtimeseriesdataisautoregression,which
Ididnotcoverhere,mostlybecauseitturnsoutnottobeusefulforthe
exampledataIworkedwith.
Butonceyouhavelearnedthematerialinthischapter,youarewellprepared
tolearnaboutautoregression.OneresourceIrecommendisPhilippJanert's
book,
DataAnalysiswithOpenSourceTools
,O'ReillyMedia,2011.His
chapterontimeseriesanalysispicksupwherethisoneleaves
12.10Exercises
Mysolutiontotheseexercisesisin
chap12soln.py
.
Exercise12.1
ThelinearmodelIusedinthischapterhastheobviousdraw-
backthatitislinear,andthereisnoreasontoexpectpricestochangelinearly
overtime.Wecanaddlitytothemodelbyaddingaquadraticterm,
aswedidinSection11.3.
Useaquadraticmodeltothetimeseriesofdailyprices,andusethemodel
togeneratepredictions.Youwillhavetowriteaversionof
RunLinearModel
thatrunsthatquadraticmodel,butafterthatyoushouldbeabletoreuse
codein
timeseries.py
togeneratepredictions.
Exercise12.2
Writeaforaclassnamed
SerialCorrelationTest
thatextends
HypothesisTest
fromSection9.2.Itshouldtakeaseriesand
alagasdata,computetheserialcorrelationoftheserieswiththegivenlag,
andthencomputethep-valueoftheobservedcorrelation.
Usethisclasstotestwhethertheserialcorrelationinrawpricedatais
statisticallyt.Alsotesttheresidualsofthelinearmodeland(if
youdidthepreviousexercise),thequadraticmodel.
Exercise12.3
ThereareseveralwaystoextendtheEWMAmodeltogen-
eratepredictions.Oneofthesimplestissomethinglikethis:
1.ComputetheEWMAofthetimeseriesandusethelastpointasan
intercept,
inter
.
12.11.Glossary193
2.ComputetheEWMAoferencesbetweensuccessiveelementsinthe
timeseriesandusethelastpointasaslope,
slope
.
3.Topredictvaluesatfuturetimes,compute
inter+slope*dt
,
where
dt
isthebetweenthetimeofthepredictionandthe
timeofthelastobservation.
Usethismethodtogeneratepredictionsforayearafterthelastobservation.
Afewhints:

Use
timeseries.FillMissing
toinmissingvaluesbeforerunning
thisanalysis.Thatwaythetimebetweenconsecutiveelementsiscon-
sistent.

Use
Series.diff
tocomputedibetweensuccessiveelements.

Use
reindex
toextendtheDataFrameindexintothefuture.

Use
fillna
toputyourpredictedvaluesintotheDataFrame.
12.11Glossary

timeseries
:Adatasetwhereeachvalueisassociatedwithatimes-
tamp,oftenaseriesofmeasurementsandthetimestheywerecollected.

window
:Asequenceofconsecutivevaluesinatimeseries,oftenused
tocomputeamovingaverage.

movingaverage
:Oneofseveralstatisticsintendedtoestimatethe
underlyingtrendinatimeseriesbycomputingaverages(ofsomekind)
foraseriesofoverlappingwindows.

rollingmean
:Amovingaveragebasedonthemeanvalueineach
window.
194Chapter12.Timeseriesanalysis

exponentially-weightedmovingaverage(EWMA)
:Amovingav-
eragebasedonaweightedmeanthatgivesthehighestweighttothe
mostrecentvalues,andexponentiallydecreasingweightstoearlierval-
ues.

span
:AparameterofEWMAthatdetermineshowquicklytheweights
decrease.

serialcorrelation
:Correlationbetweenatimeseriesandashiftedor
laggedversionofitself.

lag
:Thesizeoftheshiftinaserialcorrelationorautocorrelation.

autocorrelation
:Amoregeneraltermforaserialcorrelationwith
anyamountoflag.

autocorrelationfunction
:Afunctionthatmapsfromlagtoserial
correlation.

stationary
:Amodelisstationaryiftheparametersandthedistribu-
tionofresidualsdoesnotchangeovertime.
Chapter13
Survivalanalysis
Survivalanalysis
isawaytodescribehowlongthingslast.Itisoftenused
tostudyhumanlifetimes,butitalsoappliesto\survival"ofmechanicaland
electroniccomponents,ormoregenerallytointervalsintimebeforeanevent.
Ifsomeoneyouknowhasbeendiagnosedwithalife-threateningdisease,you
mighthaveseena\5-yearsurvivalrate,"whichistheprobabilityofsurviving
eyearsafterdiagnosis.Thatestimateandrelatedstatisticsaretheresult
ofsurvivalanalysis.
Thecodeinthischapterisin
survival.py
.Forinformationaboutdown-
loadingandworkingwiththiscode,seeSection0.2.
13.1Survivalcurves
Thefundamentalconceptinsurvivalanalysisisthe
survivalcurve
,
S
(
t
),
whichisafunctionthatmapsfromaduration,
t
,totheprobabilityofsurviv-
inglongerthan
t
.Ifyouknowthedistributionofdurations,or\lifetimes",
thesurvivalcurveiseasy;it'sjustthecomplementoftheCDF:
S
(
t
)=1

CDF(
t
)
where
CDF
(
t
)istheprobabilityofalifetimelessthanorequalto
t
.
196Chapter13.Survivalanalysis
Figure13.1:Cdfandsurvivalcurveforpregnancylength(top),hazardcurve
(bottom).
Forexample,intheNSFGdataset,weknowthedurationof11189complete
pregnancies.WecanreadthisdataandcomputetheCDF:
preg=nsfg.ReadFemPreg()
complete=in[1,3,
cdf=thinkstats2.Cdf(complete,
Theoutcomecodes
1,3,4
indicatelivebirth,stillbirth,andmiscarriage.
ForthisanalysisIamexcludinginducedabortions,ectopicpregnancies,and
pregnanciesthatwereinprogresswhentherespondentwasinterviewed.
TheDataFramemethod
query
takesabooleanexpressionandevaluatesit
foreachrow,selectingtherowsthatyieldTrue.
Figure13.1(top)showstheCDFofpregnancylengthanditscomplement,
thesurvivalcurve.Torepresentthesurvivalcurve,Ianobjectthat
wrapsaCdfandadaptstheinterface:
classSurvivalFunction(object):
def__init__(self,cdf,
self.cdf=cdf
self.label=labelorcdf.label
13.1.Survivalcurves197
@property
defts(self):
returnself.cdf.xs
@property
defss(self):
return1-self.cdf.ps
SurvivalFunction
providestwoproperties:
ts
,whichisthesequenceof
lifetimes,and
ss
,whichisthesurvivalcurve.InPython,a\property"isa
methodthatcanbeinvokedasifitwereavariable.
Wecaninstantiatea
SurvivalFunction
bypassingtheCDFoflifetimes:
sf=SurvivalFunction(cdf)
SurvivalFunction
alsoprovides
__getitem__
and
Prob
,whichevaluates
thesurvivalcurve:
#classSurvivalFunction
def__getitem__(self,t):
returnself.Prob(t)
defProb(self,t):
return1-self.cdf.Prob(t)
Forexample,
sf[13]
isthefractionofpregnanciesthatproceedpastthe
trimester:
>>>sf[13]
0.86022
>>>cdf[13]
0.13978
About86%ofpregnanciesproceedpastthetrimester;about14%do
not.
SurvivalFunction
provides
Render
,sowecanplot
sf
usingthefunctions
in
thinkplot
:
thinkplot.Plot(sf)
198Chapter13.Survivalanalysis
Figure13.1(top)showstheresult.Thecurveisnearlybetween13and26
weeks,whichshowsthatfewpregnanciesendinthesecondtrimester.And
thecurveissteepestaround39weeks,whichisthemostcommonpregnancy
length.
13.2Hazardfunction
Fromthesurvivalcurvewecanderivethe
hazardfunction
;forpregnancy
lengths,thehazardfunctionmapsfromatime,
t
,tothefractionofpregnan-
ciesthatcontinueuntil
t
andthenendat
t
.Tobemoreprecise:

(
t
)=
S
(
t
)

S
(
t
+1)
S
(
t
)
Thenumeratoristhefractionoflifetimesthatendat
t
,whichisalsoPMF(
t
).
SurvivalFunction
provides
MakeHazard
,whichcalculatesthehazardfunc-
tion:
#classSurvivalFunction
defMakeHazard(self,
ss=self.ss
lams={}
fori,tinenumerate(self.ts[:-1]):
hazard=(ss[i]-ss[i+1])/ss[i]
lams[t]=hazard
returnHazardFunction(lams,label=label)
The
HazardFunction
objectisawrapperforapandasSeries:
classHazardFunction(object):
def__init__(self,d,
self.series=pandas.Series(d)
self.label=label
13.3.Inferringsurvivalcurves199
d
canbeadictionaryoranyothertypethatcaninitializeaSeries,including
anotherSeries.
label
isastringusedtoidentifytheHazardFunctionwhen
plotted.
HazardFunction
provides
__getitem__
,sowecanevaluateitlikethis:
>>>hf=sf.MakeHazard()
>>>hf[39]
0.49689
Soofallpregnanciesthatproceeduntilweek39,about50%endinweek39.
Figure13.1(bottom)showsthehazardfunctionforpregnancylengths.For
timesafterweek42,thehazardfunctioniserraticbecauseitisbasedona
smallnumberofcases.Otherthanthattheshapeofthecurveisasexpected:
itishighestaround39weeks,andalittlehigherinthetrimesterthan
inthesecond.
Thehazardfunctionisusefulinitsownright,butitisalsoanimportant
toolforestimatingsurvivalcurves,aswe'llseeinthenextsection.
13.3Inferringsurvivalcurves
IfsomeonegivesyoutheCDFoflifetimes,itiseasytocomputethesurvival
andhazardfunctions.Butinmanyreal-worldscenarios,wecan'tmeasure
thedistributionoflifetimesdirectly.Wehavetoinferit.
Forexample,supposeyouarefollowingagroupofpatientstoseehowlong
theysurviveafterdiagnosis.Notallpatientsarediagnosedonthesameday,
soatanypointintime,somepatientshavesurvivedlongerthanothers.If
somepatientshavedied,weknowtheirsurvivaltimes.Forpatientswhoare
stillalive,wedon'tknowsurvivaltimes,butwehavealowerbound.
Ifwewaituntilallpatientsaredead,wecancomputethesurvivalcurve,but
ifweareevaluatingtheenessofanewtreatment,wecan'twaitthat
long!Weneedawaytoestimatesurvivalcurvesusingincompleteinforma-
tion.
Asamorecheerfulexample,IwilluseNSFGdatatoquantifyhowlong
respondents\survive"untiltheygetmarriedforthetime.Therange
200Chapter13.Survivalanalysis
ofrespondents'agesis14to44years,sothedatasetprovidesasnapshotof
womenattstagesintheirlives.
Forwomenwhohavebeenmarried,thedatasetincludesthedateoftheir
marriageandtheirageatthetime.Forwomenwhohavenotbeenmarried,
weknowtheiragewheninterviewed,buthavenowayofknowingwhenorif
theywillgetmarried.
Sinceweknowtheageatmarriagefor
some
women,itmightbetempt-
ingtoexcludetherestandcomputetheCDFoftheknowndata.That
isabadidea.Theresultwouldbedoublymisleading:(1)olderwomen
wouldbeoverrepresented,becausetheyaremorelikelytobemarriedwhen
interviewed,and(2)marriedwomenwouldbeoverrepresented!Infact,this
analysiswouldleadtotheconclusionthatallwomengetmarried,whichis
obviouslyincorrect.
13.4Kaplan-Meierestimation
Inthisexampleitisnotonlydesirablebutnecessarytoincludeobservations
ofunmarriedwomen,whichbringsustooneofthecentralalgorithmsin
survivalanalysis,
Kaplan-Meierestimation
.
Thegeneralideaisthatwecanusethedatatoestimatethehazardfunction,
thenconvertthehazardfunctiontoasurvivalcurve.Toestimatethehazard
function,weconsider,foreachage,(1)thenumberofwomenwhogotmarried
atthatageand(2)thenumberofwomen\atrisk"ofgettingmarried,which
includesallwomenwhowerenotmarriedatanearlierage.
Here'sthecode:
defEstimateHazardFunction(complete,ongoing,
hist_complete=Counter(complete)
hist_ongoing=Counter(ongoing)
ts=list(hist_complete|hist_ongoing)
ts.sort()
13.4.Kaplan-Meierestimation201
at_risk=len(complete)+len(ongoing)
lams=pandas.Series(index=ts)
fortints:
ended=hist_complete[t]
censored=hist_ongoing[t]
lams[t]=ended/at_risk
at_risk-=ended+censored
returnHazardFunction(lams,label=label)
complete
isthesetofcompleteobservations;inthiscase,theageswhen
respondentsgotmarried.
ongoing
isthesetofincompleteobservations;that
is,theagesofunmarriedwomenwhentheywereinterviewed.
First,weprecompute
hist_complete
,whichisaCounterthatmapsfrom
eachagetothenumberofwomenmarriedatthatage,and
hist_ongoing
whichmapsfromeachagetothenumberofunmarriedwomeninterviewed
atthatage.
ts
istheunionofageswhenrespondentsgotmarriedandageswhenunmar-
riedwomenwereinterviewed,sortedinincreasingorder.
at_risk
keepstrackofthenumberofrespondentsconsidered\atrisk"at
eachage;initially,itisthetotalnumberofrespondents.
TheresultisstoredinaPandas
Series
thatmapsfromeachagetothe
estimatedhazardfunctionatthatage.
Eachtimethroughtheloop,weconsideroneage,
t
,andcomputethenumber
ofeventsthatendat
t
(thatis,thenumberofrespondentsmarriedatthat
age)andthenumberofeventscensoredat
t
(thatis,thenumberofwomen
interviewedat
t
whosefuturemarriagedatesarecensored).Inthiscontext,
\censored"meansthatthedataareunavailablebecauseofthedatacollection
process.
Theestimatedhazardfunctionisthefractionofthecasesatriskthatendat
t
.
Attheendoftheloop,wesubtractfrom
at_risk
thenumberofcasesthat
endedorwerecensoredat
t
.
202Chapter13.Survivalanalysis
Finally,wepass
lams
tothe
HazardFunction
constructorandreturnthe
result.
13.5Themarriagecurve
Totestthisfunction,wehavetodosomedatacleaningandtransformation.
TheNSFGvariablesweneedare:

cmbirth
:Therespondent'sdateofbirth,knownforallrespondents.

cmintvw
:Thedatetherespondentwasinterviewed,knownforallre-
spondents.

cmmarrhx
:Thedatetherespondentwasmarried,ifapplicableand
known.

evrmarry
:1iftherespondenthadbeenmarriedpriortothedateof
interview,0otherwise.
Thethreevariablesareencodedin\century-months";thatis,theinteger
numberofmonthssinceDecember1899.Socentury-month1isJanuary1900.
First,wereadtherespondentandreplaceinvalidvaluesof
cmmarrhx
:
resp=chap01soln.ReadFemResp()
resp.cmmarrhx.replace([9997,9998,9999],np.nan,inplace=True)
Thenwecomputeeachrespondent'sagewhenmarriedandagewheninter-
viewed:
=(resp.cmmarrhx-resp.cmbirth)/12.0
=(resp.cmintvw-resp.cmbirth)/12.0
Nextweextract
complete
,whichistheageatmarriageforwomenwhohave
beenmarried,and
ongoing
,whichistheageatinterviewforwomenwho
havenot:
complete=resp[resp.evrmarry==1].agemarry
ongoing=resp[resp.evrmarry==0].age
Finallywecomputethehazardfunction.
13.6.Estimatingthesurvivalcurve203
hf=EstimateHazardFunction(complete,ongoing)
Figure13.2(top)showstheestimatedhazardfunction;itislowintheteens,
higherinthe20s,anddeclininginthe30s.Itincreasesagaininthe40s,but
thatisanartifactoftheestimationprocess;asthenumberofrespondents
\atrisk"decreases,asmallnumberofwomengettingmarriedyieldsalarge
estimatedhazard.Thesurvivalcurvewillsmoothoutthisnoise.
13.6Estimatingthesurvivalcurve
Oncewehavethehazardfunction,wecanestimatethesurvivalcurve.The
chanceofsurvivingpasttime
t
isthechanceofsurvivingalltimesupthrough
t
,whichisthecumulativeproductofthecomplementaryhazardfunction:
[1


(0)][1


(1)]
:::
[1


(
t
)]
The
HazardFunction
classprovides
MakeSurvival
,whichcomputesthis
product:
#classHazardFunction:
defMakeSurvival(self):
ts=self.series.index
ss=(1-self.series).cumprod()
cdf=thinkstats2.Cdf(ts,1-ss)
sf=SurvivalFunction(cdf)
returnsf
ts
isthesequenceoftimeswherethehazardfunctionisestimated.
ss
is
thecumulativeproductofthecomplementaryhazardfunction,soitisthe
survivalcurve.
Becauseoftheway
SurvivalFunction
isimplemented,wehavetocompute
thecomplementof
ss
,makeaCdf,andtheninstantiateaSurvivalFunction
object.
Figure13.2(bottom)showstheresult.Thesurvivalcurveissteepestbetween
25and35,whenmostwomengetmarried.Between35and45,thecurve
isnearlyindicatingthatwomenwhodonotmarrybeforeage35are
unlikelytogetmarried.
204Chapter13.Survivalanalysis
Figure13.2:Hazardfunctionforageatrstmarriage(top)andsurvival
curve(bottom).
Acurvelikethiswasthebasisofafamousmagazinearticlein1986;
Newsweek
reportedthata40-yearoldunmarriedwomanwas\morelikelytobekilled
byaterrorist"thangetmarried.Thesestatisticswerewidelyreportedand
becamepartofpopularculture,buttheywerewrongthen(becausetheywere
basedonfaultyanalysis)andturnedouttobeevenmorewrong(because
ofculturalchangesthatwerealreadyinprogressandcontinued).In2006,
Newsweek
ranananotherarticleadmittingthattheywerewrong.
Iencourageyoutoreadmoreaboutthisarticle,thestatisticsitwasbasedon,
andthereaction.Itshouldremindyouoftheethicalobligationtoperform
statisticalanalysiswithcare,interprettheresultswithappropriateskepti-
cism,andpresentthemtothepublicaccuratelyandhonestly.
13.7intervals
Kaplan-Meieranalysisyieldsasingleestimateofthesurvivalcurve,butitis
alsoimportanttoquantifytheuncertaintyoftheestimate.Asusual,there
arethreepossiblesourcesoferror:measurementerror,samplingerror,and
modelingerror.
Inthisexample,measurementerrorisprobablysmall.Peoplegenerallyknow
13.7.intervals205
whentheywereborn,whetherthey'vebeenmarried,andwhen.Andthey
canbeexpectedtoreportthisinformationaccurately.
Wecanquantifysamplingerrorbyresampling.Here'sthecode:
defResampleSurvival(resp,iters=101):
low,high=resp.agemarry.min(),resp.agemarry.max()
ts=np.arange(low,high,1/12.0)
ss_seq=[]
foriinrange(iters):
sample=thinkstats2.ResampleRowsWeighted(resp)
hf,sf=EstimateSurvival(sample)
ss_seq.append(sf.Probs(ts))
low,high=thinkstats2.PercentileRows(ss_seq,[5,95])
thinkplot.FillBetween(ts,low,high)
ResampleSurvival
takes
resp
,aDataFrameofrespondents,and
iters
,the
numberoftimestoresample.Itcomputes
ts
,whichisthesequenceofages
wherewewillevaluatethesurvivalcurves.
Insidetheloop,
ResampleSurvival
:

Resamplestherespondentsusing
ResampleRowsWeighted
,whichwe
sawinSection10.7.

Calls
EstimateSurvival
,whichusestheprocessintheprevioussec-
tionstoestimatethehazardandsurvivalcurves,and

Evaluatesthesurvivalcurveateachagein
ts
.
ss_seq
isasequenceofevaluatedsurvivalcurves.
PercentileRows
takes
thissequenceandcomputesthe5thand95thpercentiles,returninga90%
intervalforthesurvivalcurve.
Figure13.3showstheresultalongwiththesurvivalcurveweestimatedin
theprevioussection.Theenceintervaltakesintoaccountthesampling
weights,unliketheestimatedcurve.Thediscrepancybetweenthemindicates
thatthesamplingweightshaveasubstantialontheestimate|wewill
havetokeepthatinmind.
206Chapter13.Survivalanalysis
Figure13.3:Survivalcurveforageatmarriage(darkline)anda90%
intervalbasedonweightedresampling(grayline).
13.8Cohort
Oneofthechallengesofsurvivalanalysisisthattpartsoftheesti-
matedcurvearebasedondtgroupsofrespondents.Thepartofthe
curveattime
t
isbasedonrespondentswhoseagewasatleast
t
whenthey
wereinterviewed.Sotheleftmostpartofthecurveincludesdatafromall
respondents,buttherightmostpartincludesonlytheoldestrespondents.
Iftherelevantcharacteristicsoftherespondentsarenotchangingovertime,
that'sbutinthiscaseitseemslikelythatmarriagepatternsaret
forwomenbornintgenerations.Wecaninvestigatethisby
groupingrespondentsaccordingtotheirdecadeofbirth.Groupslikethis,
bydateofbirthorsimilarevents,arecalled
cohorts
,and
betweenthegroupsarecalled
cohort
.
ToinvestigatecohortintheNSFGmarriagedata,IgatheredtheCycle
6datafrom2002usedthroughoutthisbook;theCycle7datafrom2006{
2010usedinSection9.11;andtheCycle5datafrom1995.Intotalthese
datasetsinclude30,769respondents.
resp5=ReadFemResp1995()
resp6=ReadFemResp2002()
resp7=ReadFemResp2010()
13.8.Cohort207
resps=[resp5,resp6,resp7]
ForeachDataFrame,
resp
,Iuse
cmbirth
tocomputethedecadeofbirthfor
eachrespondent:
month0=
dates=[month0+pandas.DateOffset(months=cm)
forcminresp.cmbirth]
=(pandas.DatetimeIndex(dates).year-1900)//10
cmbirth
isencodedastheintegernumberofmonthssinceDecember1899;
month0
representsthatdateasaTimestampobject.Foreachbirthdate,
weinstantiatea
DateOffset
thatcontainsthecentury-monthandaddit
to
month0
;theresultisasequenceofTimestamps,whichisconvertedtoa
DateTimeIndex
.Finally,weextract
year
andcomputedecades.
Totakeintoaccountthesamplingweights,andalsotoshowvariabilitydue
tosamplingerror,Iresamplethedata,grouprespondentsbydecade,and
plotsurvivalcurves:
foriinrange(iters):
samples=[thinkstats2.ResampleRowsWeighted(resp)
forrespinresps]
sample=pandas.concat(samples,ignore_index=True)
groups=
EstimateSurvivalByDecade(groups,alpha=0.2)
DatafromthethreeNSFGcyclesusetsamplingweights,soIre-
samplethemseparatelyandthenuse
concat
tomergethemintoasingle
DataFrame.Theparameter
ignore_index
tells
concat
nottomatchup
respondentsbyindex;insteaditcreatesanewindexfrom0to30768.
EstimateSurvivalByDecade
plotssurvivalcurvesforeachcohort:
defEstimateSurvivalByDecade(resp):
forname,groupingroups:
hf,sf=EstimateSurvival(group)
thinkplot.Plot(sf)
Figure13.4showstheresults.Severalpatternsarevisible:

Womenborninthe50smarriedearliest,withsuccessivecohortsmar-
ryinglaterandlater,atleastuntilage30orso.
208Chapter13.Survivalanalysis
Figure13.4:Survivalcurvesforrespondentsbornduringntdecades.

Womenborninthe60sfollowasurprisingpattern.Priortoage25,
theyweremarryingatslowerratesthantheirpredecessors.Afterage
25,theyweremarryingfaster.Byage32theyhadovertakenthe50s
cohort,andatage44theyaresubstantiallymorelikelytohavemarried.
Womenborninthe60sturned25between1985and1995.Remember-
ingthatthe
Newsweek
articleImentionedwaspublishedin1986,itis
temptingtoimaginethatthearticletriggeredamarriageboom.That
explanationwouldbetoopat,butitispossiblethatthearticleandthe
reactiontoitwereindicativeofamoodthatthebehaviorof
thiscohort.

Thepatternofthe70scohortissimilar.Theyarelesslikelythan
theirpredecessorstobemarriedbeforeage25,butatage35theyhave
caughtupwithbothofthepreviouscohorts.

Womenborninthe80sareevenlesslikelytomarrybeforeage25.
Whathappensafterthatisnotclear;formoredata,wehavetowait
forthenextcycleoftheNSFG.
Inthemeantimewecanmakesomepredictions.
13.9.Extrapolation209
13.9Extrapolation
Thesurvivalcurveforthe70scohortendsataboutage38;forthe80scohort
itendsatage28,andforthe90scohortwehardlyhaveanydataatall.
Wecanextrapolatethesecurvesby\borrowing"datafromtheprevious
cohort.HazardFunctionprovidesamethod,
Extend
,thatcopiesthetail
fromanotherlongerHazardFunction:
#classHazardFunction
defExtend(self,other):
last=self.series.index[-1]
more=other.series[other.series.index>last]
self.series=pandas.concat([self.series,more])
AswesawinSection13.2,theHazardFunctioncontainsaSeriesthatmaps
from
t
to

(
t
).
Extend

last
,whichisthelastindexin
self.series
,
selectsvaluesfrom
other
thatcomelaterthan
last
,andappendsthemonto
self.series
.
NowwecanextendtheHazardFunctionforeachcohort,usingvaluesfrom
thepredecessor:
defPlotPredictionsByDecade(groups):
hfs=[]
forname,groupingroups:
hf,sf=EstimateSurvival(group)
hfs.append(hf)
thinkplot.PrePlot(len(hfs))
fori,hfinenumerate(hfs):
ifi>0:
hf.Extend(hfs[i-1])
sf=hf.MakeSurvival()
thinkplot.Plot(sf)
groups
isaGroupByobjectwithrespondentsgroupedbydecadeofbirth.
TheloopcomputestheHazardFunctionforeachgroup.
ThesecondloopextendseachHazardFunctionwithvaluesfromitspredeces-
sor,whichmightcontainvaluesfromthepreviousgroup,andsoon.Thenit
210Chapter13.Survivalanalysis
Figure13.5:Survivalcurvesforrespondentsbornduringtdecades,
withpredictionsforthelatercohorts.
convertseachHazardFunctiontoaSurvivalFunctionandplotsit.
Figure13.5showstheresults;I'veremovedthe50scohorttomakethepre-
dictionsmorevisible.Theseresultssuggestthatbyage40,themostrecent
cohortswillconvergewiththe60scohort,withfewerthan20%nevermarried.
13.10Expectedremaininglifetime
Givenasurvivalcurve,wecancomputetheexpectedremaininglifetimeasa
functionofcurrentage.Forexample,giventhesurvivalcurveofpregnancy
lengthfromSection13.1,wecancomputetheexpectedtimeuntildelivery.
ThestepistoextractthePMFoflifetimes.
SurvivalFunction
provides
amethodthatdoesthat:
#classSurvivalFunction
defMakePmf(self,filler=None):
pmf=thinkstats2.Pmf()
forval,probinself.cdf.Items():
13.10.Expectedremaininglifetime211
pmf.Set(val,prob)
cutoff=self.cdf.ps[-1]
iffillerisnotNone:
pmf[filler]=1-cutoff
returnpmf
RememberthattheSurvivalFunctioncontainstheCdfoflifetimes.Theloop
copiesthevaluesandprobabilitiesfromtheCdfintoaPmf.
cutoff
isthehighestprobabilityintheCdf,whichis1iftheCdfiscomplete,
andotherwiselessthan1.IftheCdfisincomplete,weplugintheprovided
value,
filler
,tocapit
TheCdfofpregnancylengthsiscomplete,sowedon'thavetoworryabout
thisdetailyet.
Thenextstepistocomputetheexpectedremaininglifetime,where\ex-
pected"meansaverage.
SurvivalFunction
providesamethodthatdoes
that,too:
#classSurvivalFunction
defRemainingLifetime(self,filler=None,func=thinkstats2.Pmf.Mean):
pmf=self.MakePmf(filler=filler)
d={}
fortinsorted(pmf.Values())[:-1]:
pmf[t]=0
pmf.Normalize()
d[t]=func(pmf)-t
returnpandas.Series(d)
RemainingLifetime
takes
filler
,whichispassedalongto
MakePmf
,and
func
whichisthefunctionusedtosummarizethedistributionofremaining
lifetimes.
pmf
isthePmfoflifetimesextractedfromtheSurvivalFunction.
d
isa
dictionarythatcontainstheresults,amapfromcurrentage,
t
,toexpected
remaininglifetime.
212Chapter13.Survivalanalysis
Figure13.6:Expectedremainingpregnancylength(left)andyearsuntil
marriage(right).
TheloopiteratesthroughthevaluesinthePmf.Foreachvalueof
t
it
computestheconditionaldistributionoflifetimes,giventhatthelifetime
exceeds
t
.ItdoesthatbyremovingvaluesfromthePmfoneatatimeand
renormalizingtheremainingvalues.
Thenituses
func
tosummarizetheconditionaldistribution.Inthisexample
theresultisthemeanpregnancylength,giventhatthelengthexceeds
t
.By
subtracting
t
wegetthemeanremainingpregnancylength.
Figure13.6(left)showstheexpectedremainingpregnancylengthasafunc-
tionofthecurrentduration.Forexample,duringWeek0,theexpected
remainingdurationisabout34weeks.That'slessthanfullterm(39weeks)
becauseterminationsofpregnancyinthetrimesterbringtheaverage
down.
Thecurvedropsslowlyduringthetrimester.After13weeks,theex-
pectedremaininglifetimehasdroppedbyonly9weeks,to25.Afterthatthe
curvedropsfaster,byaboutaweekperweek.
BetweenWeek37and42,thecurvelevelsbetween1and2weeks.Atany
timeduringthisperiod,theexpectedremaininglifetimeisthesame;with
eachweekthatpasses,thedestinationgetsnocloser.Processeswiththis
13.10.Expectedremaininglifetime213
propertyarecalled
memoryless
becausethepasthasnoonthepre-
dictions.Thisbehavioristhemathematicalbasisoftheinfuriatingmantra
ofobstetricsnurses:\anydaynow."
Figure13.6(right)showsthemedianremainingtimeuntilmarriage,asa
functionofage.Foran11year-oldgirl,themediantimeuntilmarriageis
about14years.Thecurvedecreasesuntilage22whenthemedianremaining
timeisabout7years.Afterthatitincreasesagain:byage30itisbackwhere
itstarted,at14years.
Basedonthisdata,youngwomenhavedecreasingremaining\lifetimes".
Mechanicalcomponentswiththispropertyarecalled
NBUE
for\newbetter
thanusedinexpectation,"meaningthatanewpartisexpectedtolastlonger.
Womenolderthan22haveincreasingremainingtimeuntilmarriage.
Componentswiththispropertyarecalled
UBNE
for\usedbetterthannew
inexpectation."Thatis,theolderthepart,thelongeritisexpectedtolast.
NewbornsandcancerpatientsarealsoUBNE;theirlifeexpectancyincreases
thelongertheylive.
ForthisexampleIcomputedmedian,ratherthanmean,becausetheCdf
isincomplete;thesurvivalcurveprojectsthatabout20%ofrespondents
willnotmarrybeforeage44.Theageofmarriageforthesewomenis
unknown,andmightbenon-existent,sowecan'tcomputeamean.
Idealwiththeseunknownvaluesbyreplacingthemwith
np.inf
,aspecial
valuethatrepresentsy.Thatmakesthemeanyforallages,
butthemedianiswnedaslongasmorethan50%oftheremaining
lifetimesarewhichistrueuntilage30.Afterthatitishardtoe
ameaningfulexpectedremaininglifetime.
Here'sthecodethatcomputesandplotsthesefunctions:
rem_life1=sf1.RemainingLifetime()
thinkplot.Plot(rem_life1)
func=lambdapmf:pmf.Percentile(50)
rem_life2=sf2.RemainingLifetime(filler=np.inf,func=func)
thinkplot.Plot(rem_life2)
214Chapter13.Survivalanalysis
sf1
isthesurvivalcurveforpregnancylength;inthiscasewecanusethe
defaultvaluesfor
RemainingLifetime
.
sf2
isthesurvivalcurveforageatrstmarriage;
func
isafunctionthat
takesaPmfandcomputesitsmedian(50thpercentile).
13.11Exercises
Mysolutiontothisexerciseisin
chap13soln.py
.
Exercise13.1
InNSFGCycles6and7,thevariable
cmdivorcx
contains
thedateofdivorcefortherespondent'smarriage,ifapplicable,encoded
incentury-months.
Computethedurationofmarriagesthathaveendedindivorce,andthe
duration,sofar,ofmarriagesthatareongoing.Estimatethehazardand
survivalcurveforthedurationofmarriage.
Useresamplingtotakeintoaccountsamplingweights,andplotdatafrom
severalresamplestovisualizesamplingerror.
Considerdividingtherespondentsintogroupsbydecadeofbirth,andpos-
siblybyageatmarriage.
13.12Glossary

survivalanalysis
:Asetofmethodsfordescribingandpredicting
lifetimes,ormoregenerallytimeuntilaneventoccurs.

survivalcurve
:Afunctionthatmapsfromatime,
t
,totheproba-
bilityofsurvivingpast
t
.

hazardfunction
:Afunctionthatmapsfrom
t
tothefractionof
peoplealiveuntil
t
whodieat
t
.

Kaplan-Meierestimation
:Analgorithmforestimatinghazardand
survivalfunctions.
13.12.Glossary215

cohort
:agroupofsubjectsbyanevent,likedateofbirth,in
aparticularintervaloftime.

cohort
:aerencebetweencohorts.

NBUE
:Apropertyofexpectedremaininglifetime,\Newbetterthan
usedinexpectation."

UBNE
:Apropertyofexpectedremaininglifetime,\Usedbetterthan
newinexpectation."
216Chapter13.Survivalanalysis
Chapter14
Analyticmethods
Thisbookhasfocusedoncomputationalmethodslikesimulationandresam-
pling,butsomeoftheproblemswesolvedhaveanalyticsolutionsthatcan
bemuchfaster.
Ipresentsomeofthesemethodsinthischapter,andexplainhowtheywork.
Attheendofthechapter,Imakesuggestionsforintegratingcomputational
andanalyticmethodsforexploratorydataanalysis.
Thecodeinthischapterisin
normal.py
.Forinformationaboutdownloading
andworkingwiththiscode,seeSection0.2.
14.1Normaldistributions
Asamotivatingexample,let'sreviewtheproblemfromSection8.3:
Supposeyouareascientiststudyinggorillasinawildlifepreserve.
Havingweighed9gorillas,yousamplemean
x
=90kgand
samplestandarddeviation,
S
=7
:
5kg.Ifyouuse
x
toestimate
thepopulationmean,whatisthestandarderroroftheestimate?
Toanswerthatquestion,weneedthesamplingdistributionof
x
.InSec-
tion8.3weapproximatedthisdistributionbysimulatingtheexperiment
218Chapter14.Analyticmethods
(weighing9gorillas),computing
x
foreachsimulatedexperiment,andaccu-
mulatingthedistributionofestimates.
Theresultisanapproximationofthesamplingdistribution.Thenweusethe
samplingdistributiontocomputestandarderrorsandintervals:
1.Thestandarddeviationofthesamplingdistributionisthestandard
erroroftheestimate;intheexample,itisabout2.5kg.
2.Theintervalbetweenthe5thand95thpercentileofthesamplingdis-
tributionisa90%interval.Ifweruntheexperimentmany
times,weexpecttheestimatetofallinthisinterval90%ofthetime.
Intheexample,the90%CIis(86
;
94)kg.
Nowwe'lldothesamecalculationanalytically.Wetakeadvantageofthe
factthattheweightsofadultfemalegorillasareroughlynormallydistributed.
Normaldistributionshavetwopropertiesthatmakethemamenableforanal-
ysis:theyare\closed"underlineartransformationandaddition.Toexplain
whatthatmeans,Ineedsomenotation.
Ifthedistributionofaquantity,
X
,isnormalwithparameters

and
˙
,you
canwrite
X
˘N
(
˙
2
)
wherethesymbol
˘
means\isdistributed"andthescriptletter
N
stands
for\normal."
Alineartransformationof
X
issomethinglike
X
0
=
aX
+
b
,where
a
and
b
are
realnumbers.Afamilyofdistributionsisclosedunderlineartransformation
if
X
0
isinthesamefamilyas
X
.Thenormaldistributionhasthisproperty;
if
X
˘N
(
˙
2
),
X
0
˘N
(

+
b;a
2
˙
2
)(1)
Normaldistributionsarealsoclosedunderaddition.If
Z
=
X
+
Y
and
X
˘N
(

X
;˙
2
X
)and
Y
˘N
(

Y
;˙
2
Y
)then
Z
˘N
(

X
+

Y
;˙
2
X
+
˙
2
Y
)(2)
Inthespecialcase
Z
=
X
+
X
,wehave
Z
˘N
(2

X
;
2
˙
2
X
)
14.2.Samplingdistributions219
andingeneralifwedraw
n
valuesof
X
andaddthemup,wehave
Z
˘N
(

X
;n˙
2
X
)(3)
14.2Samplingdistributions
Nowwehaveeverythingweneedtocomputethesamplingdistributionof
x
.
Rememberthatwecompute
x
byweighing
n
gorillas,addingupthetotal
weight,anddividingby
n
.
Assumethatthedistributionofgorillaweights,
X
,isapproximatelynormal:
X
˘N
(
˙
2
)
Ifweweigh
n
gorillas,thetotalweight,
Y
,isdistributed
Y
˘N
(
n˙
2
)
usingEquation3.Andifwedivideby
n
,thesamplemean,
Z
,isdistributed
Z
˘N
(
˙
2
=n
)
usingEquation1with
a
=1
=n
.
Thedistributionof
Z
isthesamplingdistributionof
x
.Themeanof
Z
is

,whichshowsthat
x
isanunbiasedestimateof

.Thevarianceofthe
samplingdistributionis
˙
2
=n
.
Sothestandarddeviationofthesamplingdistribution,whichisthestandard
erroroftheestimate,is
˙=
p
n
.Intheexample,
˙
is7.5kgand
n
is9,sothe
standarderroris2.5kg.Thatresultisconsistentwithwhatweestimated
bysimulation,butmuchfastertocompute!
Wecanalsousethesamplingdistributiontocomputeintervals.
A90%cintervalfor
x
istheintervalbetweenthe5thand95th
percentilesof
Z
.Since
Z
isnormallydistributed,wecancomputepercentiles
byevaluatingtheinverseCDF.
ThereisnoclosedformfortheCDFofthenormaldistributionoritsinverse,
buttherearefastnumericalmethodsandtheyareimplementedinSciPy,as
220Chapter14.Analyticmethods
wesawinSection5.2.
thinkstats2
providesawrapperfunctionthatmakes
theSciPyfunctionalittleeasiertouse:
defEvalNormalCdfInverse(p,mu=0,sigma=1):
returnscipy.stats.norm.ppf(p,loc=mu,scale=sigma)
Givenaprobability,
p
,itreturnsthecorrespondingpercentilefromanormal
distributionwithparameters
mu
and
sigma
.Forthe90%interval
of
x
,wecomputethe5thand95thpercentileslikethis:
>>>thinkstats2.EvalNormalCdfInverse(0.05,mu=90,sigma=2.5)
85.888
>>>thinkstats2.EvalNormalCdfInverse(0.95,mu=90,sigma=2.5)
94.112
Soifweruntheexperimentmanytimes,weexpecttheestimate,
x
,tofallin
therange(85
:
9
;
94
:
1)about90%ofthetime.Again,thisisconsistentwith
theresultwegotbysimulation.
14.3Representingnormaldistributions
Tomakethesecalculationseasier,Ihaveaclasscalled
Normal
that
representsanormaldistributionandencodestheequationsintheprevious
sections.Here'swhatitlookslike:
classNormal(object):
def__init__(self,mu,sigma2):
self.mu=mu
self.sigma2=sigma2
def__str__(self):
return%(self.mu,self.sigma2)
SowecaninstantiateaNormalthatrepresentsthedistributionofgorilla
weights:
>>>dist=Normal(90,7.5**2)
>>>dist
N(90,56.25)
14.4.Centrallimittheorem221
Normal
provides
Sum
,whichtakesasamplesize,
n
,andreturnsthedistribu-
tionofthesumof
n
values,usingEquation3:
defSum(self,n):
returnNormal(n*self.mu,n*self.sigma2)
NormalalsoknowshowtomultiplyanddivideusingEquation1:
def__mul__(self,factor):
returnNormal(factor*self.mu,factor**2*self.sigma2)
def__div__(self,divisor):
return1/divisor*self
Sowecancomputethesamplingdistributionofthemeanwithsamplesize
9:
>>>dist_xbar=dist.Sum(9)/9
>>>dist_xbar.sigma
2.5
Thestandarddeviationofthesamplingdistributionis2.5kg,aswesawin
theprevioussection.Finally,Normalprovides
Percentile
,whichwecan
usetocomputeainterval:
>>>dist_xbar.Percentile(5),dist_xbar.Percentile(95)
85.88894.113
Andthat'sthesameanswerwegotbefore.We'llusetheNormalclassagain
later,butbeforewegoon,weneedonemorebitofanalysis.
14.4Centrallimittheorem
Aswesawintheprevioussections,ifweaddvaluesdrawnfromnormal
distributions,thedistributionofthesumisnormal.Mostotherdistributions
don'thavethisproperty;ifweaddvaluesdrawnfromotherdistributions,
thesumdoesnotgenerallyhaveananalyticdistribution.
Butifweaddup
n
valuesfromalmostanydistribution,thedistributionof
thesumconvergestonormalas
n
increases.
Moresp,ifthedistributionofthevalueshasmeanandstandard
deviation

and
˙
,thedistributionofthesumisapproximately
N
(
n˙
2
).
222Chapter14.Analyticmethods
ThisresultistheCentralLimitTheorem(CLT).Itisoneofthemostuseful
toolsforstatisticalanalysis,butitcomeswithcaveats:

Thevalueshavetobedrawnindependently.Iftheyarecorrelated,the
CLTdoesn'tapply(althoughthisisseldomaprobleminpractice).

Thevalueshavetocomefromthesamedistribution(althoughthis
requirementcanberelaxed).

Thevalueshavetobedrawnfromadistributionwithmeanand
variance.SomostParetodistributionsareout.

Therateofconvergencedependsontheskewnessofthedistribution.
Sumsfromanexponentialdistributionconvergeforsmall
n
.Sumsfrom
alognormaldistributionrequirelargersizes.
TheCentralLimitTheoremexplainstheprevalenceofnormaldistributions
inthenaturalworld.Manycharacteristicsoflivingthingsareby
geneticandenvironmentalfactorswhosectisadditive.Thecharacter-
isticswemeasurearethesumofalargenumberofsmallsotheir
distributiontendstobenormal.
14.5TestingtheCLT
ToseehowtheCentralLimitTheoremworks,andwhenitdoesn't,let'stry
someexperiments.First,we'lltryanexponentialdistribution:
defMakeExpoSamples(beta=2.0,iters=1000):
samples=[]
fornin[1,10,100]:
sample=[np.sum(np.random.exponential(beta,n))
for_inrange(iters)]
samples.append((n,sample))
returnsamples
MakeExpoSamples
generatessamplesofsumsofexponentialvalues(Iuse
\exponentialvalues"asshorthandfor\valuesfromanexponentialdistribu-
tion").
beta
istheparameterofthedistribution;
iters
isthenumberof
sumstogenerate.
14.5.TestingtheCLT223
Toexplainthisfunction,I'llstartfromtheinsideandworkmywayout.Each
timewecall
np.random.exponential
,wegetasequenceof
n
exponential
valuesandcomputeitssum.
sample
isalistofthesesums,withlength
iters
.
Itiseasytoget
n
and
iters
confused:
n
isthenumberoftermsineach
sum;
iters
isthenumberofsumswecomputeinordertocharacterizethe
distributionofsums.
Thereturnvalueisalistof
(n,sample)
pairs.Foreachpair,wemakea
normalprobabilityplot:
defNormalPlotSamples(samples,plot=1,
forn,sampleinsamples:
thinkplot.SubPlot(plot)
thinkstats2.NormalProbabilityPlot(sample)
%n,ylabel=ylabel)
plot+=1
NormalPlotSamples
takesthelistofpairsfrom
MakeExpoSamples
andgen-
eratesarowofnormalprobabilityplots.
Figure14.1(toprow)showstheresults.With
n=1
,thedistributionofthe
sumisstillexponential,sothenormalprobabilityplotisnotastraightline.
Butwith
n=10
thedistributionofthesumisapproximatelynormal,andwith
n=100
itisallbutindistinguishablefromnormal.
Figure14.1(bottomrow)showssimilarresultsforalognormaldistribution.
Lognormaldistributionsaregenerallymoreskewedthanexponentialdistri-
butions,sothedistributionofsumstakeslongertoconverge.With
n=10
thenormalprobabilityplotisnowherenearstraight,butwith
n=100
itis
approximatelynormal.
Paretodistributionsareevenmoreskewedthanlognormal.Dependingonthe
parameters,manyParetodistributionsdonothavemeanandvariance.
Asaresult,theCentralLimitTheoremdoesnotapply.Figure14.2(toprow)
showsdistributionsofsumsofParetovalues.Evenwith
n=100
thenormal
probabilityplotisfarfromstraight.
IalsomentionedthatCLTdoesnotapplyifthevaluesarecorrelated.To
testthat,Igeneratecorrelatedvaluesfromanexponentialdistribution.The
224Chapter14.Analyticmethods
Figure14.1:Distributionsofsumsofexponentialvalues(toprow)andlog-
normalvalues(bottomrow).
14.5.TestingtheCLT225
Figure14.2:DistributionsofsumsofParetovalues(toprow)andcorrelated
exponentialvalues(bottomrow).
226Chapter14.Analyticmethods
algorithmforgeneratingcorrelatedvaluesis(1)generatecorrelatednormal
values,(2)usethenormalCDFtotransformthevaluestouniform,and
(3)usetheinverseexponentialCDFtotransformtheuniformvaluesto
exponential.
GenerateCorrelated
returnsaniteratorof
n
normalvalueswithserialcor-
relation
rho
:
defGenerateCorrelated(rho,n):
x=random.gauss(0,1)
yieldx
sigma=math.sqrt(1-rho**2)
for_inrange(n-1):
x=random.gauss(x*rho,sigma)
yieldx
Thevalueisastandardnormalvalue.Eachsubsequentvaluedepends
onitspredecessor:ifthepreviousvalueis
x
,themeanofthenextvalueis
x*rho
,withvariance
1-rho**2
.Notethat
random.gauss
takesthestandard
deviationasthesecondargument,notvariance.
GenerateExpoCorrelated
takestheresultingsequenceandtransformsitto
exponential:
defGenerateExpoCorrelated(rho,n):
normal=list(GenerateCorrelated(rho,n))
uniform=scipy.stats.norm.cdf(normal)
expo=scipy.stats.expon.ppf(uniform)
returnexpo
normal
isalistofcorrelatednormalvalues.
uniform
isasequenceofuniform
valuesbetween0and1.
expo
isacorrelatedsequenceofexponentialvalues.
ppf
standsfor\percentpointfunction,"whichisanothernamefortheinverse
CDF.
Figure14.2(bottomrow)showsdistributionsofsumsofcorrelatedexpo-
nentialvalueswith
rho=0.9
.Thecorrelationslowstherateofconvergence;
nevertheless,with
n=100
thenormalprobabilityplotisnearlystraight.So
eventhoughCLTdoesnotstrictlyapplywhenthevaluesarecorrelated,
moderatecorrelationsareseldomaprobleminpractice.
14.6.ApplyingtheCLT227
TheseexperimentsaremeanttoshowhowtheCentralLimitTheoremworks,
andwhathappenswhenitdoesn't.Nowlet'sseehowwecanuseit.
14.6ApplyingtheCLT
ToseewhytheCentralLimitTheoremisuseful,let'sgetbacktotheexample
inSection9.3:testingtheapparentinmeanpregnancylengthfor
babiesandothers.Aswe'veseen,theapparentisabout0.078
weeks:
>>>live,firsts,others=first.MakeFrames()
>>>delta=firsts.prglngth.mean()-others.prglngth.mean()
0.078
Rememberthelogicofhypothesistesting:wecomputeap-value,whichisthe
probabilityoftheobservedunderthenullhypothesis;ifitissmall,
weconcludethattheobservedisunlikelytobeduetochance.
Inthisexample,thenullhypothesisisthatthedistributionofpregnancy
lengthsisthesameforbabiesandothers.Sowecancomputethe
samplingdistributionofthemeanlikethis:
dist1=SamplingDistMean(live.prglngth,len(firsts))
dist2=SamplingDistMean(live.prglngth,len(others))
Bothsamplingdistributionsarebasedonthesamepopulation,whichisthe
poolofalllivebirths.
SamplingDistMean
takesthissequenceofvaluesand
thesamplesize,andreturnsaNormalobjectrepresentingthesamplingdis-
tribution:
defSamplingDistMean(data,n):
mean,var=data.mean(),data.var()
dist=Normal(mean,var)
returndist.Sum(n)/n
mean
and
var
arethemeanandvarianceof
data
.Weapproximatethe
distributionofthedatawithanormaldistribution,
dist
.
Inthisexample,thedataarenotnormallydistributed,sothisapproximation
isnotverygood.Butthenwecompute
dist.Sum(n)/n
,whichisthe
samplingdistributionofthemeanof
n
values.Evenifthedataarenot
228Chapter14.Analyticmethods
normallydistributed,thesamplingdistributionofthemeanis,bytheCentral
LimitTheorem.
Next,wecomputethesamplingdistributionoftheinthemeans.
The
Normal
classknowshowtoperformsubtractionusingEquation2:
def__sub__(self,other):
returnNormal(self.mu-other.mu,
self.sigma2+other.sigma2)
Sowecancomputethesamplingdistributionofthelikethis:
>>>dist=dist1-dist2
N(0,0.0032)
Themeanis0,whichmakessensebecauseweexpecttwosamplesfromthe
samedistributiontohavethesamemean,onaverage.Thevarianceofthe
samplingdistributionis0.0032.
Normal
provides
Prob
,whichevaluatesthenormalCDF.Wecanuse
Prob
tocomputetheprobabilityofaaslargeas
delta
underthenull
hypothesis:
>>>1-dist.Prob(delta)
0.084
Whichmeansthatthep-valueforaone-sidedtestis0.84.Foratwo-sided
testwewouldalsocompute
>>>dist.Prob(-delta)
0.084
Whichisthesamebecausethenormaldistributionissymmetric.Thesumof
thetailsis0.168,whichisconsistentwiththeestimateinSection9.3,which
was0.17.
14.7Correlationtest
InSection9.5weusedapermutationtestforthecorrelationbetweenbirth
weightandmother'sage,andfoundthatitisstatisticallyt,with
p-valuelessthan0.001.
Nowwecandothesamethinganalytically.Themethodisbasedonthis
mathematicalresult:giventwovariablesthatarenormallydistributedand
14.7.Correlationtest229
uncorrelated,ifwegenerateasamplewithsize
n
,computePearson'scorre-
lation,
r
,andthencomputethetransformedcorrelation
t
=
r
r
n

2
1

r
2
thedistributionof
t
isStudent'st-distributionwithparameter
n

2.Thet-
distributionisananalyticdistribution;theCDFcanbecomputedtly
usinggammafunctions.
Wecanusethisresulttocomputethesamplingdistributionofcorrelation
underthenullhypothesis;thatis,ifwegenerateuncorrelatedsequences
ofnormalvalues,whatisthedistributionoftheircorrelation?
StudentCdf
takesthesamplesize,
n
,andreturnsthesamplingdistributionofcorrelation:
defStudentCdf(n):
ts=np.linspace(-3,3,101)
ps=scipy.stats.t.cdf(ts,df=n-2)
rs=ts/np.sqrt(n-2+ts**2)
returnthinkstats2.Cdf(rs,ps)
ts
isaNumPyarrayofvaluesfor
t
,thetransformedcorrelation.
ps
contains
thecorrespondingprobabilities,computedusingtheCDFoftheStudent's
t-distributionimplementedinSciPy.Theparameterofthet-distribution,
df
,standsfor\degreesoffreedom."Iwon'texplainthatterm,butyoucan
readaboutitat
http://en.wikipedia.org/wiki/Degrees_of_freedom_
(statistics)
.
Togetfrom
ts
tothecorrelationcots,
rs
,weapplytheinversetrans-
form,
r
=
t=
p
n

2+
t
2
Theresultisthesamplingdistributionof
r
underthenullhypothesis.Fig-
ure14.3showsthisdistributionalongwiththedistributionwegeneratedin
Section9.5byresampling.Theyarenearlyidentical.Althoughtheactual
distributionsarenotnormal,Pearson'scotofcorrelationisbasedon
samplemeansandvariances.BytheCentralLimitTheorem,thesemoment-
basedstatisticsarenormallydistributedevenifthedataarenot.
FromFigure14.3,wecanseethattheobservedcorrelation,0.07,isunlikely
230Chapter14.Analyticmethods
Figure14.3:Samplingdistributionofcorrelationsforuncorrelatednormal
variables.
tooccurifthevariablesareactuallyuncorrelated.Usingtheanalyticdistri-
bution,wecancomputejusthowunlikely:
t=r*math.sqrt((n-2)/(1-r**2))
p_value=1-scipy.stats.t.cdf(t,df=n-2)
Wecomputethevalueof
t
thatcorrespondsto
r=0.07
,andthenevaluate
thet-distributionat
t
.Theresultis
2.9e-11
.Thisexampledemonstrates
anadvantageoftheanalyticmethod:wecancomputeverysmallp-values.
Butinpracticeitusuallydoesn'tmatter.
14.8Chi-squaredtest
InSection9.7weusedthechi-squaredstatistictotestwhetheradieis
crooked.Thechi-squaredstatisticmeasuresthetotalnormalizeddeviation
fromtheexpectedvaluesinatable:
˜
2
=
X
i
(
O
i

E
i
)
2
E
i
14.8.Chi-squaredtest231
Figure14.4:Samplingdistributionofchi-squaredstatisticsforafairsix-sided
die.
Onereasonthechi-squaredstatisticiswidelyusedisthatitssamplingdistri-
butionunderthenullhypothesisisanalytic;byaremarkablecoincidence
1
,it
iscalledthechi-squareddistribution.Likethet-distribution,thechi-squared
CDFcanbecomputedtlyusinggammafunctions.
SciPyprovidesanimplementationofthechi-squareddistribution,whichwe
usetocomputethesamplingdistributionofthechi-squaredstatistic:
defChiSquaredCdf(n):
xs=np.linspace(0,25,101)
ps=scipy.stats.chi2.cdf(xs,df=n-1)
returnthinkstats2.Cdf(xs,ps)
Figure14.4showstheanalyticresultalongwiththedistributionwegotby
resampling.Theyareverysimilar,especiallyinthetail,whichisthepart
weusuallycaremostabout.
Wecanusethisdistributiontocomputethep-valueoftheobservedtest
statistic,
chi2
:
p_value=1-scipy.stats.chi2.cdf(chi2,df=n-1)
Theresultis0.041,whichisconsistentwiththeresultfromSection9.7.
1
Notreally.
232Chapter14.Analyticmethods
Theparameterofthechi-squareddistributionis\degreesoffreedom"again.
Inthiscasethecorrectparameteris
n-1
,where
n
isthesizeofthetable,6.
Choosingthisparametercanbetricky;tobehonest,Iamnevert
thatIhaveitrightuntilIgeneratesomethinglikeFigure14.4tocompare
theanalyticresultstotheresamplingresults.
14.9Discussion
Thisbookfocusesoncomputationalmethodslikeresamplingandpermuta-
tion.Thesemethodshaveseveraladvantagesoveranalysis:

Theyareeasiertoexplainandunderstand.Forexample,oneofthe
mosttopicsinanintroductorystatisticsclassishypothesis
testing.Manystudentsdon'treallyunderstandwhatp-valuesare.
IthinktheapproachIpresentedinChapter9|simulatingthenull
hypothesisandcomputingteststatistics|makesthefundamentalidea
clearer.

Theyarerobustandversatile.Analyticmethodsareoftenbasedon
assumptionsthatmightnotholdinpractice.Computationalmethods
requirefewerassumptions,andcanbeadaptedandextendedmore
easily.

Theyaredebuggable.Analyticmethodsareoftenlikeablackbox:you
pluginnumbersandtheyspitoutresults.Butit'seasytomakesubtle
errors,hardtobetthattheresultsareright,andhardto
theproblemiftheyarenot.Computationalmethodslendthemselves
toincrementaldevelopmentandtesting,whichfostersinthe
results.
Butthereisonedrawback:computationalmethodscanbeslow.Takinginto
accounttheseprosandcons,Irecommendthefollowingprocess:
1.Usecomputationalmethodsduringexploration.Ifyouasatisfac-
toryanswerandtheruntimeisacceptable,youcanstop.
2.Ifruntimeisnotacceptable,lookforopportunitiestooptimize.Using
analyticmethodsisoneofseveralmethodsofoptimization.
14.10.Exercises233
3.Ifreplacingacomputationalmethodwithananalyticmethodisap-
propriate,usethecomputationalmethodasabasisofcomparison,
providingmutualvalidationbetweenthecomputationalandanalytic
results.
ForthevastmajorityofproblemsIhaveworkedon,Ididn'thavetogopast
Step1.
14.10Exercises
Asolutiontotheseexercisesisin
chap14soln.py
Exercise14.1
InSection5.4,wesawthatthedistributionofadultweights
isapproximatelylognormal.Onepossibleexplanationisthattheweighta
persongainseachyearisproportionaltotheircurrentweight.Inthatcase,
adultweightistheproductofalargenumberofmultiplicativefactors:
w
=
w
0
f
1
f
2
:::f
n
where
w
isadultweight,
w
0
isbirthweight,and
f
i
istheweightgainfactor
foryear
i
.
Thelogofaproductisthesumofthelogsofthefactors:
log
w
=log
w
0
+log
f
1
+log
f
2
+

+log
f
n
SobytheCentralLimitTheorem,thedistributionoflog
w
isapproximately
normalforlarge
n
,whichimpliesthatthedistributionof
w
islognormal.
Tomodelthisphenomenon,chooseadistributionfor
f
thatseemsreasonable,
thengenerateasampleofadultweightsbychoosingarandomvaluefrom
thedistributionofbirthweights,choosingasequenceoffactorsfromthe
distributionof
f
,andcomputingtheproduct.Whatvalueof
n
isneededto
convergetoalognormaldistribution?
Exercise14.2
InSection14.6weusedtheCentralLimitTheoremtothe
samplingdistributionoftheinmeans,

,underthenullhypothesis
thatbothsamplesaredrawnfromthesamepopulation.
234Chapter14.Analyticmethods
Wecanalsousethisdistributiontothestandarderroroftheestimate
andintervals,butthatwouldonlybeapproximatelycorrect.To
bemoreprecise,weshouldcomputethesamplingdistributionof

underthe
alternatehypothesisthatthesamplesaredrawnfromtpopulations.
Computethisdistributionanduseittocalculatethestandarderroranda
90%intervalfortheinmeans.
Exercise14.3
Inarecentpaper
2
,Steinetal.investigatetheofan
interventionintendedtomitigategender-stereotypicaltaskallocationwithin
studentengineeringteams.
Beforeandaftertheintervention,studentsrespondedtoasurveythatasked
themtoratetheircontributiontoeachaspectofclassprojectsona7-point
scale.
Beforetheintervention,malestudentsreportedhigherscoresforthepro-
grammingaspectoftheprojectthanfemalestudents;onaveragemenre-
portedascoreof3.57withstandarderror0.28.Womenreported1.91,on
average,withstandarderror0.32.
Computethesamplingdistributionofthegendergap(thein
means),andtestwhetheritisstatisticallyt.Becauseyouaregiven
standarderrorsfortheestimatedmeans,youdon'tneedtoknowthesample
sizetooutthesamplingdistributions.
Aftertheintervention,thegendergapwassmaller:theaveragescoreformen
was3.44(SE0.16);theaveragescoreforwomenwas3.18(SE0.16).Again,
computethesamplingdistributionofthegendergapandtestit.
Finally,estimatethechangeingendergap;whatisthesamplingdistribution
ofthischange,andisitstatisticallyt?
2
\Evidenceforthepersistentofaninterventiontomitigategender-sterotypical
taskallocationwithinstudentengineeringteams,"ProceedingsoftheIEEEFrontiersin
EducationConference,2014.
Index
abstraction,70
accuracy,168
acf,185
Adams,Cecil,29
addition,closedunder,218
adultheight,91
adultweight,65,67,91,112,233
age,139,155,156,159,167,200,202
agegroup,54
aggregate,175
alpha,93
Anaconda,ix,154
analysis,71,218
analyticdistribution,57,73,230
analyticmethods,217
anecdotalevidence,2,15
apparent117
artifact,94
atrisk,200
Australia,58
autocorrelationfunction,185,194
average,25
barplot,33
Bayesianinference,117
Bayesianstatistics,112
BehavioralRiskFactorSurveillance
System,66,150
bettingpool,159,160,164,169
bias,85
2
observer,37,41,43
oversampling,38
sampling,112,142
selection,2,42
biasedcoin,120
biasedestimator,108{110,114{116,
219
binary,166
binarysearch,82
binning,45,80,95
birthtime,58
birthweight,8,22,45,50,52,55,
61,63,65,103,122,124,133,
134,139,140,144,146,149,
153,155{159,161,162,228,
233
BlueManGroup,71
boolean,12,20,92,157,162,164,
166,186,196
bracketoperator,18,20,32,49
BRFSS,66,91,101,150
Brisbane,58
BureauofLaborStatistics,88
cannabis,173
casino,126
categoricalvariable,157,162,163,
167,170,171
causalrelationship,102
236Index
causation,102
CCDF,59,73,195
CDF,46,48,55,60,65,67,69,75,
80,130,199
complementary,59,73,195
Cdf,49,51{53,60,79,82,83,96,122,
149,196,203,211,213
CDF,interpreting,50
CDF,inverse,49,55,69,82,219,226
CensusBureau,88
CentralLimitTheorem,vi,222,223,
227{229,233
centralmoment,90
centraltendency,25,30,51,85
centurymonth,202,207
chi-squareddistribution,231
chi-squaredstatistic,127,129
chi-squaredtest,125,127,135,231
citysize,68
classsize,35
cleaning,v,161
clinicallyt,28,30
clone,viii
closedform,60,165,220
CLT,vi,222,223,227{229,233
cotofdetermination,144{146,
151,155,157{159,161,163,
167
cohort,206,215
cohort206,215
complementaryCDF,59,73,195,203
compression,71
computationalmethods,vi,138,217,
232
interval,111,113,115,
116,143,149,150,189,191,
204,205,218,219,221,234
bias,2
result,132
continuousdistribution,79
contradiction,proofby,118
contributors,x
controlgroup,103,104
controlvariable,v,159,163,171
controlledtrial,103
correctpositive,131
correlation,v,96,98,100,102,104,
124,138,226,229
serial,184
costfunction,107,138
Counter,201
covariance,97,104
crookeddie,126
cross-sectionalstudy,3,15
cumulativedistributionfunction,48
cumulativeprobability,55,79,82
cumulativeproduct,203
CurrentPopulationSurvey,88
cycle,3
datacollection,2
datamining,162,169,171
DataFrame,5{7,10,12,14,20,23,
39,41,43,58,89,92,96,122,
133,142,149,154,160,167,
169,171,174{176,178,181,
186{188,196,205,207
dateofbirth,169,202
daterange,181
datetime64,176
DateTimeIndex,207
debugging,vi,232
decile,52
degreesoffreedom,109,229,232
Index237
density,75,78
dependentvariable,153{155,158,
163,164,166,167,170,179
derivative,75
descriptivestatistics,2
deviation,26,97,98,126,127,137,
147,231
diagnosis,199
dice,107,126
dictionary,17,81
DictWrapper,81,82
digitize,95
discretedistribution,79
discretize,80,89
distribution,v,17,29
analytic,57,73
chi-squared,231
empirical,57,72,73
exponential,57,62,69,72,75,80,
113,115,222
Gaussian,60,62,67,71,75,80,
97,101,105,107,217,221,
222
lognormal,65,67,73,102,222,
223,233
normal,60,62,67,71,75,80,97,
101,105,107,217,221,222
Pareto,67,68,71{73,222,223
Student'st,229
uniform,55,69,93,97,186
Weibull,72
distributionframework,79
distributions,comparing,50
divorce,214
dotproduct,98
dropna,87,95,125,139,147,183
size,27,30,122,130,134
electricalcomponent,195
empiricaldistribution,57,72,73
endogenousvariable,167,170,179
equallyspaceddata,174
error,106,130
EstimatedPdf,78
estimation,v,3,105,116,142
estimator,105,107
biased,108{110,114,115,219
unbiased,108
ethics,13,28,29,103,173,204
EWMA,181,184,192,194
exogenousvariable,167,170,179
expectedremaininglifetime,211
explanatoryvariable,153{155,157{
159,161{164,167,170,178,
179,187
exploration,232
exploratorydataanalysis,2,35
exponentialdistribution,57,62,69,
72,75,80,113,115,222
exponentially-weightedmovingaver-
age,181,194
extrapolation,209
falsenegative,130,135
falsepositive,130,135,185
size,54
FillBetween,143,190,205
182,183,193
babies,1
FitLine,139
values,179
fork,viii
frequency,17,18,29{31,43,81,83,
126
238Index
Gaussiandistribution,30,60,62,67,
71,75,80,97,101,105,107,
217,221,222
gendergap,234
generativeprocess,71
Git,viii
GitHub,viii
goodnessof144,151
gorilla,110,112,217,219,220
Group,BlueMan,71
groupby,96,175,207,209,214
hashable,81
hazardfunction,198,200,202,214
HazardFunction,199,202,209
height,71,72,93
hexbinplot,94
Hist,18{20,22{24,29,31{34,80{82,
120,127
histogram,17,18,20,22,29
hockey,115
hockeystickgraph,173
Holm-Bonferronimethod,132
hstack,128
hypothesistesting,v,3,117,134,227
HypothesisTest,119,120,122,125,
126,128,146,192
identical,222
income,88,162,163
incompleteinformation,199
independent,222
Index,6,207
indexer
loc,12
inf,213
installation,ix
interarrivaltime,58,73
intercept,138,139
internalclass,81
interpolation,79
interquartilerange,51,56
interval,181,191
116
inverseCDF,49,55,69,82,219,226
inverseCDFalgorithm,53,69
IPython,ix,13
IQ,145
iterativesolver,166
iterator,226
JamesJoyceRamble,54
Janert,Philipp,192
jitter,93,103
join,159,160,171
Kaplan-Meierestimation,200,214
KDE,77,89
kerneldensityestimation,77,89
lag,184,185,187,192,194
leastsquares137,150
LeastSquares,139
length
pregnancy,24,33,117,121
likelihood,166
lineplot,33
linearalgebra,98
linearv,150
linearleastsquares,137
linearmodel,146,192
linearregression,153,170,178,187
linearrelationship,100
lineartransformation,218
locindexer,12
logodds,166
Index239
logarithm,233
logarithmicscale,59
logisticregression,164,165,171
logitfunction,166
lognormaldistribution,65,67,73,
102,222,223,233
longitudinalstudy,3,15
MacKay,David,120
maritalstatus,170,200,202,208,214
mass,75
matplotlib,ix,19
maximumlikelihoodestimator,107,
114,116,138,165
mean,25,41,60,97,105,113,222
in,119,121
rolling,180
meanerror,109
meansquarederror,106,116
MeanVar,99
measurementerror,105,112,113,
116,138,142,205
mechanicalcomponent,195
median,51,56,106,107,114,213
medicine,103
memoryless,213
missingvalues,9,125,176,181{183,
193
MLE,107,114,116,138,165
mode,25,29,30
model,57,60{62,64,65,67,68,70,
73,79,89,118,120{122,127,
128,130,134,137,140,141,
144,146,150,153{155,157,
158,161{164,167{169,179,
180,189,191,194,233
modelingerror,188,190,204
moment,84
momentofinertia,85
movingaverage,180,193
MSE,106,107,110,114,116,145
multiplebirth,162
multipleregression,v,153,156,170
multipletests,132
NaN,9,12,20,87,95,125,139,147,
161,183,184,202
NationalSurveyofFamilyGrowth,3,
35,45,50,61,117,121,133
naturalexperiment,103,104
NBUE,213,215
Newsweek,204,208
Newton'smethod,166
noise,93,180,181,183,188,190,203
nonlinear,100,101,141,158,192
Normal,220,228
normaldistribution,30,60{62,67,
71,75,80,97,101,105,107,
217,220{222
normalprobabilityplot,62,65,67,
68,73,223,226
normalization,31,43
NSFG,3,35,45,49,50,61,117,121,
132,133,159
nullhypothesis,117{119,121,122,
124,127{130,133{135,146,
147,227{229,231{233
NumPy,ix,7,13,39,63,77,78,84,
93,95,98,122,167,168,174,
176,179,223,229
observerbias,37,41,43
odds,164,171
one-sidedtest,123,134,228
ordinaryleastsquares,154,164,171
240Index
orthogonalvector,98
outlier,22,23,25,30,86,87,93,94,
97,101,106,114
oversampling,4,16,38,149,150
p-value,vi,118,121,122,124,125,
127,130,132{134,147,155,
157,159,163,167,178,185,
192,227,228,230{232
pandas,ix,5,6,9,18,20,26,39,43,
64,95,98,101,160,167,174,
180,181,184,187,198,207,
209
parabola,158
parameter,57,60,65,67,71,105,
113,138,139,142,147,154,
155,164,165,187,190
Paretodistribution,67,68,71{73,
222,223
ParetoWorld,72
Pareto,Vilfredo,67
Patsy,154,162,167
PDF,75,89
Pdf,79
Pearsoncotofcorrelation,96,
99{103,124,125,145,229
Pearsonmedianskewness,86,88,90
Pearson,Karl,99
percentpointfunction,226
percentile,47,51,55,61,96,220
percentilerank,46{48,51,52,54,55,
96
permutation,121,124,125,131,133,
134,146,147,228,232
permutationtest,134
plot
bar,33
hexbin,94
line,33
normalprobability,62,73
scatter,91,100,140
PMF,31,33,41,43,45
Pmf,31,33,35,42,76,78,79,81,83,
211,214
pointestimation,116
Poissonregression,164,170,171
population,4,15,68,110
power,131,135
prediction,99,107,144,145,161,
187,192,193,208
predictivepower,155,161
preferentialattachment,71
pregnancylength,2,8,22{24,27{29,
33,49,64,117,118,121{123,
128,131,133,134,161,196,
198,199,210{212,214,227
price,174,178,188
PriceofWeed,173
probability,31,43,164
probabilitydensity,89
probabilitydensityfunction,75,89
probabilitymassfunction,31,43
product,233
proofbycontradiction,118
property,197
proxyvariable,171
pseudor-squared,167,168
pumpkin,26
pyplot,19,33,176
quadraticmodel,158,192
quantile,52,56
quantize,80
quartile,51
Index241
query,196
quintile,52
r-squared,144{146,155,157{159,
161,163,167
race,160,162,163,167
racetime,54
randommodule,70,72
randomnumber,52,53,55,62,69,
72,112,226
randomizedcontrolledtrial,103,104
rank,96,101,104
rankcorrelation,101
rawdata,8,16
rawmoment,89
recode,8,16
record,15
regression,153,170
regressionanalysis,103
regressionmodel,153,159,164,165
RegressionResults,154
reindex,181,193
relayrace,42
replacement,52,56,92,131,134,142,
149
repository,viii
representative,4,16
Resample,131
resampling,134,142,149,183,186,
188,189,205,207,214,217,
229,231,232
weighted,148
resamplingtest,134
residuals,137,140,151,155,180,
187,189
respondent,4,16,67
RMSE,106,114,155
robust,86,87,90,97,101,114,232
rollingmean,180,193
sample,16,48,110
samplemean,110,115
samplemedian,114,115
samplesize,110,133,221
sampleskewness,85,90
samplevariance,26,108
SampleRows,92
samplingbias,112,113,116,142
samplingdistribution,111,112,115,
116,142,147,149,218,219,
221,227{229,231,233,234
samplingerror,110,142,187,190,
204,207
samplingweight,148,150,151,205
SAT,145
saturation,93,104
scatterplot,91,100,103,140
SciPy,ix,60,71,76,77,220,229{231
seasonality,180,182,184
selectionbias,2,42
self-selection,113
sensitivity,131
serialcorrelation,184,194
Series,6,10,12,13,20,40,64,101,
155,180,182,186,193,198,
209
sex,161,164
sexratio,166,169
shape,51
t,28,118,121,122,124{
130,132{134,146,148,155,
158,163,168,169,178,185,
187,192,228,234
simpleregression,153,170
242Index
simulation,79,110,120,142,186,
191,220
skewness,85,87,88,90,97,101,102,
147,222,223
slope,138,139,191,193
smoothing,70,79,181
soccer,115
span,182,194
Spearmancoetofcorrelation,
96,101{103,124
spread,25,30,51
spuriousrelationship,102,156,171
SQL,159
squaredresiduals,138
standarddeviation,26,30,60,64,65,
67,77,85,86,96,97,99,104,
110,112,124,128,144,155,
218,219,221,226,234
pooled,27
standarderror,111,113,115,116,
143,149,150,218,219,234
standardnormaldistribution,73,226
standardscore,96,98,104
standardize,97,104
standardizedmoment,85,90
stationarymodel,190,194
statisticallysignt,118,121,122,
124{130,132{134,146,148,
155,158,163,168,169,178,
185,187,192,228,234
StatsModels,ix,154,166,170,178,
185
stepfunction,49
StraightDope,The,29
Student'st-distribution,229
study
cross-sectional,3,15
longitudinal,3,15
sum,221
summarystatistic,25,30,51
survivalanalysis,195,214
survivalcurve,195,199,201,214
survivalrate,195
SurvivalFunction,196,203
symmetric,86,147,228
tail,25,30,231
telephonesampling,112
test
one-sided,134
two-sided,134
teststatistic,118,119,123,124,127,
134,231
theory,162
thinkplot,19,20,24,33{35,37,50,
52,58,60,64,77,78,86,87,
92{94,96,122,143,176,197,
223
threshold,130
ticks,176
timeseries,173,192,193
transaction,174
transparency,93
treatmentgroup,103,104
trend,179,180
trimester,197
Trivers-Willardhypothesis,169
truenegative,168
truepositive,168
two-sidedtest,123,134,228
U.S.CensusBureau,68
UBNE,213,215
unbiasedestimator,108
underpowered,132
Index243
uniformdistribution,30,55,69,93,
97,186
units,96,98
variance,26,30,41,107,222
visualization,v,35,79,141,176,210
wealth,162
Weibulldistribution,72
weight,93,148,156,163,179,219
adult,65,67
birth,8,22,45,50,52,55,61,63,
65,103,122,124,133,134,
139,140,144,146,149,153,
155{159,161,162,228,233
pumpkin,26
sample,8
weightedresampling,148,205
window,180{182,193
wrapper,81,198,220
xticks,176
244Index
